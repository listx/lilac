<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Lilac</title>
<meta name="author" content="Linus Arver" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<link rel="stylesheet" type="text/css" href="syntax-highlighting.css"/>
<link rel="stylesheet" type="text/css" href="lilac.css" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Source+Serif+Pro:wght@400;700&family=Source+Sans+Pro:wght@400;700&family=Source+Code+Pro">
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="lilac.js"></script>
<script>
// @license magnet:?xt=urn:btih:1f739d935676111cfff4b4693e3816e664797050&amp;dn=gpl-3.0.txt GPL-v3-or-Later
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
// @license-end
</script>
</head>
<body>
<div id="content" class="content">
<h1 class="title">Lilac</h1>
<div id="table-of-contents" role="doc-toc">

<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#h-Introduction">1. Introduction</a>
<ul>
<li><a href="#h-Motivation">1.1. Motivation</a>
<ul>
<li><a href="#h-Problems-with-Org-mode">1.1.1. Problems with Org mode</a></li>
<li><a href="#h-Enter--Lilac">1.1.2. Enter <i>Lilac</i></a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h-User-Guide">2. User Guide</a>
<ul>
<li><a href="#h-Source-code-blocks--monoblocks-and-polyblocks">2.1. Source code blocks: monoblocks and polyblocks</a>
<ul>
<li><a href="#h-Examples-of-source-code-blocks">2.1.1. Examples of source code blocks</a>
<ul>
<li><a href="#h-Multi-parent-child-blocks">2.1.1.1. Multi-parent child blocks</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h-Examples">2.2. Examples</a>
<ul>
<li><a href="#h-Code-blocks">2.2.1. Code blocks</a>
<ul>
<li><a href="#h-Source-blocks">2.2.1.1. Source blocks</a>
<ul>
<li><a href="#h-Plain">2.2.1.1.1. Plain</a></li>
<li><a href="#h-Monoblock">2.2.1.1.2. Monoblock</a></li>
<li><a href="#h-Monoblock--evaluation-result-s-value">2.2.1.1.3. Monoblock (evaluation result's value)</a></li>
<li><a href="#h-Polyblock">2.2.1.1.4. Polyblock</a></li>
<li><a href="#h-Linking-to-a-line-in-the-code-block-body">2.2.1.1.5. Linking to a line in the code block body</a></li>
</ul>
</li>
<li><a href="#h-Example-blocks">2.2.1.2. Example blocks</a></li>
<li><a href="#h-Quote-blocks">2.2.1.3. Quote blocks</a></li>
</ul>
</li>
<li><a href="#h-Sidenotes">2.2.2. Sidenotes</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h-Developer-Guide">3. Developer Guide</a>
<ul>
<li><a href="#h-Development-environment--Nix-shell">3.1. Development environment (Nix shell)</a></li>
<li><a href="#h-Makefile">3.2. Makefile</a></li>
<li><a href="#h-Tangling--generating-the-source-code">3.3. Tangling (generating the source code)</a>
<ul>
<li><a href="#h-Custom-Noweb-delimiters">3.3.1. Custom Noweb delimiters</a></li>
<li><a href="#h-Allow-evaluation-of-code-blocks">3.3.2. Allow evaluation of code blocks</a></li>
</ul>
</li>
<li><a href="#h-Weaving--generating-the-HTML">3.4. Weaving (generating the HTML)</a>
<ul>
<li><a href="#h-Emacs-customizations---lilac-el-">3.4.1. Emacs customizations (<code>lilac.el</code>)</a></li>
<li><a href="#h-Fix-non-determinism">3.4.2. Fix non-determinism</a>
<ul>
<li><a href="#h-Do-not-insert-current-time-as-HTML-comment">3.4.2.1. Do not insert current time as HTML comment</a></li>
<li><a href="#h-Do-not-insert-current-Org-mode-version">3.4.2.2. Do not insert current Org mode version</a></li>
<li><a href="#h-Do-not-use-random-numbers-for-the-HTML--id--attribute">3.4.2.3. Do not use random numbers for the HTML <code>id</code> attribute</a></li>
</ul>
</li>
<li><a href="#h-Toplevel-publishing-function---lilac-publish-">3.4.3. Toplevel publishing function (<code>lilac-publish</code>)</a>
<ul>
<li><a href="#h-Helper-functions">3.4.3.1. Helper functions</a></li>
</ul>
</li>
<li><a href="#h-Org-modifications">3.4.4. Org modifications</a>
<ul>
<li><a href="#h-Give-all-source-code-blocks-a----name-------field--HTML-ID">3.4.4.1. Give all source code blocks a <code>#+name: ...</code> field (HTML ID)</a></li>
<li><a href="#h-Automatic-captions-for-Noweb-source-code-blocks">3.4.4.2. Automatic captions for Noweb source code blocks</a></li>
<li><a href="#h-Human-readable-UIDs--Headings--aka-headlines">3.4.4.3. Human-readable UIDs (Headings, aka headlines)</a></li>
</ul>
</li>
<li><a href="#h-HTML-modifications">3.4.5. HTML modifications</a>
<ul>
<li><a href="#h-Use-human-readable-HTML-IDs-for-source-code-links">3.4.5.1. Use human-readable HTML IDs for source code links</a></li>
<li><a href="#h-Pretty-source-code-captions">3.4.5.2. Pretty source code captions</a></li>
<li><a href="#h-Link-noweb-references--link-to-child-block-from-parent-block">3.4.5.3. Link noweb references (link to child block from parent block)</a></li>
<li><a href="#h-Search-and-replace-hardcoded-things">3.4.5.4. Search and replace hardcoded things</a>
<ul>
<li><a href="#h-Bibliography--citations">3.4.5.4.1. Bibliography (citations)</a></li>
<li><a href="#h-Glossary--description-lists">3.4.5.4.2. Glossary (description lists)</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h-JavaScript">3.4.6. JavaScript</a>
<ul>
<li><a href="#h-Self-linked-headlines">3.4.6.1. Self-linked headlines</a></li>
<li><a href="#h-Table-of-contents-sidebar">3.4.6.2. Table of contents sidebar</a>
<ul>
<li><a href="#h-Delete--Table-of-Contents--text">3.4.6.2.1. Delete "Table of Contents" text</a></li>
<li><a href="#h-Convert--Table-of-Contents--to-a-sidebar-on-the-left">3.4.6.2.2. Convert "Table of Contents" to a sidebar on the left</a></li>
<li><a href="#h-Track-the-current-headline">3.4.6.2.3. Track the current headline</a></li>
</ul>
</li>
<li><a href="#h-Highlight-and-scroll-to-just-clicked-on-item">3.4.6.3. Highlight and scroll to just-clicked-on item</a></li>
<li><a href="#h-Scroll-to-history-item">3.4.6.4. Scroll to history item</a></li>
</ul>
</li>
<li><a href="#h-Autogenerate-CSS-for-syntax-highlighting-of-source-code-blocks">3.4.7. Autogenerate CSS for syntax highlighting of source code blocks</a></li>
<li><a href="#h-Misc-settings">3.4.8. Misc settings</a>
<ul>
<li><a href="#h-Use-HTML5-export--not-XML--to-un-break-MathJax">3.4.8.1. Use HTML5 export, not XML (to un-break MathJax)</a></li>
<li><a href="#h-Set-citeproc-styles-folder">3.4.8.2. Set citeproc styles folder</a></li>
<li><a href="#h-Code-references">3.4.8.3. Code references</a>
<ul>
<li><a href="#h-Define--CodeHighlightOn--and--CodeHighlightOff">3.4.8.3.1. Define <code>CodeHighlightOn</code> and <code>CodeHighlightOff</code></a></li>
<li><a href="#h-Do-not-highlight-coderefs">3.4.8.3.2. Do not highlight coderefs</a></li>
</ul>
</li>
<li><a href="#h-Preserve-leading-whitespace-characters-on-export">3.4.8.4. Preserve leading whitespace characters on export</a></li>
<li><a href="#h-Set-tab-width-to-4-spaces">3.4.8.5. Set tab width to 4 spaces</a></li>
<li><a href="#h-Disable-backups">3.4.8.6. Disable backups</a></li>
<li><a href="#h-Profiling">3.4.8.7. Profiling</a></li>
</ul>
</li>
<li><a href="#h-Imports">3.4.9. Imports</a></li>
<li><a href="#h-Additional--hand-tweaked--CSS">3.4.10. Additional (hand-tweaked) CSS</a>
<ul>
<li><a href="#h-Colors">3.4.10.1. Colors</a></li>
<li><a href="#h-General-body-text">3.4.10.2. General body text</a></li>
<li><a href="#h-Headline-font-sizes">3.4.10.3. Headline font sizes</a></li>
<li><a href="#h-Tables">3.4.10.4. Tables</a></li>
<li><a href="#h-Description-lists">3.4.10.5. Description lists</a></li>
<li><a href="#h-Images">3.4.10.6. Images</a></li>
<li><a href="#h-Monospaced">3.4.10.7. Monospaced</a></li>
<li><a href="#h-Links">3.4.10.8. Links</a></li>
<li><a href="#h-Source-code-block-body">3.4.10.9. Source code block body</a></li>
<li><a href="#h-Source-code-block-captions">3.4.10.10. Source code block captions</a></li>
<li><a href="#h-Links-to-child-source-block-from-parent">3.4.10.11. Links to child source block from parent</a></li>
<li><a href="#h-Sidenotes-1">3.4.10.12. Sidenotes</a></li>
</ul>
</li>
<li><a href="#h-Create--lilac-theme--file">3.4.11. Create <code>lilac.theme</code> file</a></li>
<li><a href="#h-Ignore-woven-HTML-from--git-diff">3.4.12. Ignore woven HTML from <code>git diff</code></a>
<ul>
<li><a href="#h-git-add--p">3.4.12.1. <code>git add -p</code></a></li>
</ul>
</li>
<li><a href="#h-gitignore">3.4.13. gitignore</a></li>
</ul>
</li>
<li><a href="#h-Tests">3.5. Tests</a>
<ul>
<li><a href="#h-Test-helpers">3.5.1. Test helpers</a>
<ul>
<li><a href="#h-Avoid-cross-abstraction-Noweb-reference-prefix-collision">3.5.1.1. Avoid cross-abstraction Noweb reference prefix collision</a></li>
<li><a href="#h-Setup-and-tear-down-fixture-for-HTML-tests">3.5.1.2. Setup and tear-down fixture for HTML tests</a></li>
</ul>
</li>
<li><a href="#h-Smart-source-code-block-caption-helpers">3.5.2. Smart source code block caption helpers</a></li>
<li><a href="#h-Link-to-child-block-from-parent-block">3.5.3. Link to child block from parent block</a>
<ul>
<li><a href="#h-One--same--child-node-block-referenced-in-two-different-parent-blocks">3.5.3.1. One (same) child node block referenced in two different parent blocks</a></li>
<li><a href="#h-Nested-child-blocks">3.5.3.2. Nested child blocks</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#h-Glossary">4. Glossary</a></li>
<li><a href="#h-References">5. References</a></li>
</ul>
</div>
</div>

<div id="outline-container-h-Introduction" class="outline-2">
<h2 id="h-Introduction"><span class="section-number-2">1.</span> Introduction</h2>
<div class="outline-text-2" id="text-h-Introduction">
<div class="sidenote" id="org0000000">
<p>
The <i>lilac</i> is a <a href="https://en.wikipedia.org/wiki/Syringa">flowering woody plant</a>.
</p>

</div>

<p>
<i>Lilac</i> is an addon for Emacs Org mode to make <a href="https://en.wikipedia.org/wiki/Literate_programming">Literate Programming</a> (LP) using
<a href="#org0000001">Noweb</a>-style <a href="#citeproc_bib_item_1">[1]</a> references easy. It comes in two parts:
</p>

<ol class="org-ol">
<li><code>lilac.el</code>: to be loaded and used when <i>weaving</i> <a href="#citeproc_bib_item_2">[2, p. 98]</a> and
<i>tangling</i> <a href="#citeproc_bib_item_2">[2, p. 98]</a> from your own Org mode files (which use
Noweb references), and</li>
<li><code>lilac.theme</code>: to be sourced by your Org mode files to use Lilac's CSS and
JavaScript on top of the HTML export.</li>
</ol>

<p>
This document itself reuses the <code>lilac.theme</code> file, which gives you a preview
(if you are viewing the HTML output) of what weaving with Lilac looks like.
</p>
</div>

<div id="outline-container-h-Motivation" class="outline-3">
<h3 id="h-Motivation"><span class="section-number-3">1.1.</span> Motivation</h3>
<div class="outline-text-3" id="text-h-Motivation">
<p>
Lilac was created mainly because the existing Org mode features around Noweb
references were lacking in features. There seems to have been a great deal of
effort to make <i>tangling</i> (extracting source code from <a href="#org0000003">source code blocks</a>) work
well, but not much has been done around <i>weaving</i>, where I think most of the
difficulties lie (because making output look good to a human (weaving) is much
more difficult than making output look good to a computer (tangling)).
</p>
</div>

<div id="outline-container-h-Problems-with-Org-mode" class="outline-4">
<h4 id="h-Problems-with-Org-mode"><span class="section-number-4">1.1.1.</span> Problems with Org mode</h4>
<div class="outline-text-4" id="text-h-Problems-with-Org-mode">
<p>
By default, source code blocks do not get any captions in the HTML output. This
is a problem for LP because you have to manually explain the name of each block
to keep track of their usage in other blocks (when referring to them with Noweb
style references). This gets repetitive rather quickly.
</p>

<p>
While Org mode allows source code blocks to refer to other blocks (Noweb
references), it does not do any kind of linking. So you can write blocks like
</p>

<div class="org-src-container"><pre class="src src-org" id="nil-1"><span class="org-org-meta-line">#+name: example-parent-block</span>
<span class="org-org-block-begin-line">#+begin_src bash</span>
<span class="org-org-block"><span class="org-builtin">echo</span></span><span class="org-org-block"> </span><span class="org-org-block"><span class="org-string">"Hello from the parent block"</span></span>
<span class="org-org-block">&lt;&lt;some-other-block&gt;&gt;</span>
<span class="org-org-block-end-line">#+end_src</span>

...

<span class="org-org-meta-line">#+name: some-child-block</span>
<span class="org-org-block-begin-line">#+begin_src bash</span>
<span class="org-org-block"><span class="org-builtin">echo</span></span><span class="org-org-block"> </span><span class="org-org-block"><span class="org-string">"I am child 1"</span></span>
<span class="org-org-block-end-line">#+end_src</span>
</pre></div><p>
but when this is exported to HTML neither <code>example-parent-block</code> nor
<code>some-child-block</code> have any links to each other. This is frustrating because it
makes navigating between them difficult.
</p>

<p>
Org mode does not create link anchors for headings, which makes referring to
them from other external documents slightly annoying. Org mode does not add link
anchors to source code blocks.
</p>

<p>
Org mode generates random link ID's on every export. That is, even if you change
nothing in your Org mode file, if you export to HTML there <b>will</b> be a diff
because all of the linked objects will get a new link ID.
</p>
</div>
</div>

<div id="outline-container-h-Enter--Lilac" class="outline-4">
<h4 id="h-Enter--Lilac"><span class="section-number-4">1.1.2.</span> Enter <i>Lilac</i></h4>
<div class="outline-text-4" id="text-h-Enter--Lilac">
<p>
Lilac addresses all of the issues presented above.
</p>

<p>
Lilac frees you from having to write
a custom <code>#+caption: ...</code> text for every source code block, because it generates
them automatically based on the name of the Noweb reference. And Lilac
automatically links child blocks and parent blocks together. Lilac automatically
adds link anchors to all source code blocks as well as headlines, making it
easier to link to different parts of an Org file while browsing it.
</p>

<p>
Lilac makes HTML generation deterministic. This makes it VCS and CI-friendly
because the output changes if and only if the input changes. Speaking of
CI-friendliness, Lilac was designed to be run from outside of Emacs by default
(and not interactively).
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-h-User-Guide" class="outline-2">
<h2 id="h-User-Guide"><span class="section-number-2">2.</span> User Guide</h2>
<div class="outline-text-2" id="text-h-User-Guide">
<p>
First create an Org mode file that uses LP. Then either clone this repo or add
it as a submodule to your project. The point is to get the <code>lilac.el</code> (and its
dependencies, themselves submodules) and <code>lilac.theme</code> (and associated
CSS/JavaScript files) available locally. Then for the Org mode file you are
using, you can load <code>lilac.el</code> and run <code>(lilac-publish)</code> to generate the HTML
file, or run <code>(org-babel-tangle)</code> to generate the source code from it. See the
<code>Makefile</code> that this project uses as a reference.
</p>

<p>
The main thing that you need to keep in mind when writing Org mode files for
consumption by Lilac is that the source code blocks must use Noweb references
using <code>__NREF__</code> as a prefix. See the discussion below.
</p>
</div>

<div id="outline-container-h-Source-code-blocks--monoblocks-and-polyblocks" class="outline-3">
<h3 id="h-Source-code-blocks--monoblocks-and-polyblocks"><span class="section-number-3">2.1.</span> Source code blocks: monoblocks and polyblocks</h3>
<div class="outline-text-3" id="text-h-Source-code-blocks--monoblocks-and-polyblocks">
<p>
In Org mode, Noweb-style references by default must be enclosed in double angle
brackets <code>&lt;&lt;</code> and <code>&gt;&gt;</code>. While this works, it's problematic because it can mean
different things syntactically based on the source code language. Your source
code block's language might think that the angle brackets are operators or
keywords and colorize them differently, for example.
</p>

<p>
Instead, Lilac expects Noweb-style references in the form <code>__NREF__foo</code> (where
the "NREF" stands for "Noweb reference"). Then you are free to name your child
block with this same <code>__NREF__foo</code> name. This is better because now you can
search for this word <code>__NREF__foo</code> in your raw Org mode document and you'll
instantly be able to see where it is used. Contrast this with the default Org
mode behavior where you'll have to search for <code>&lt;&lt;foo&gt;&gt;</code> and <code>foo</code> separately
(because searching for just <code>foo</code> may collide with other names that are not
source code block names).
</p>

<p>
In the example below, the <code>parent-block</code> refers to 2 other child blocks for its
definition.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><label class="org-src-name">Sample Org-mode Noweb-style references</label><span class="lilac-caption-link-symbol"><a href="#Sample-Org-mode-Noweb-style-references-1">&#x1f517;</a></span></div><pre class="src src-org" id="Sample-Org-mode-Noweb-style-references-1"><span class="org-org-meta-line">#+name: parent-block</span>
<span class="org-org-block-begin-line">#+begin_src bash</span>
<span class="org-org-block"><span class="org-builtin">echo</span></span><span class="org-org-block"> </span><span class="org-org-block"><span class="org-string">"Hello from the parent block"</span></span>
<span class="org-org-block">__NREF__child-block-1</span>
<span class="org-org-block">__NREF__child-block-2</span>
<span class="org-org-block-end-line">#+end_src</span>

...

<span class="org-org-meta-line">#+name: __NREF__child-block-1</span>
<span class="org-org-block-begin-line">#+begin_src bash</span>
<span class="org-org-block"><span class="org-builtin">echo</span></span><span class="org-org-block"> </span><span class="org-org-block"><span class="org-string">"I am child 1"</span></span>
<span class="org-org-block-end-line">#+end_src</span>

...

<span class="org-org-meta-line">#+header: :noweb-ref __NREF__child-block-2</span>
<span class="org-org-block-begin-line">#+begin_src bash</span>
<span class="org-org-block"><span class="org-builtin">echo</span></span><span class="org-org-block"> -n </span><span class="org-org-block"><span class="org-string">"I am "</span></span>
<span class="org-org-block-end-line">#+end_src</span>

<span class="org-org-meta-line">#+header: :noweb-ref __NREF__child-block-2</span>
<span class="org-org-block-begin-line">#+begin_src bash</span>
<span class="org-org-block"><span class="org-builtin">echo</span></span><span class="org-org-block"> </span><span class="org-org-block"><span class="org-string">"child 2"</span></span>
<span class="org-org-block-end-line">#+end_src</span>
</pre></div></div><p>
This example illustrates the two ways to define a child block: either as a
single code block with <code>#+name: __NREF__foo</code>, or as multiple blocks with
<code>#+header: :noweb-ref __NREF__foo</code>. Lilac calls them <a href="#org0000009">monoblocks</a> and <a href="#org000000b">polyblocks</a>
respectively. Polyblocks are concatenated together in the order they appear in
the overall Org file; this final concatenated version is what gets inserted into
the Noweb reference in the parent block.
</p>
</div>

<div id="outline-container-h-Examples-of-source-code-blocks" class="outline-4">
<h4 id="h-Examples-of-source-code-blocks"><span class="section-number-4">2.1.1.</span> Examples of source code blocks</h4>
<div class="outline-text-4" id="text-h-Examples-of-source-code-blocks">
<p>
Below is an example of the usage described above. Notice how the child blocks
referenced in the parent block are linked to their definitions.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><label class="org-src-name">example-parent-block</label><span class="lilac-caption-link-symbol"><a href="#example-parent-block">&#x1f517;</a></span></div><pre class="src src-bash" id="example-parent-block"><span class="org-builtin">echo</span> <span class="org-string">"Hello from the parent block"</span>
<span class="lilac-child-link-from-parent"><a href="#__NREF__example-child-block-foo">example-child-block-foo</a></span>
<span class="org-builtin">echo</span> <span class="org-string">""</span>
<span class="lilac-child-link-from-parent"><a href="#__NREF__example-child-block-bar-1">example-child-block-bar</a></span>
</pre></div></div><p>
Below are the child blocks. The first is a monoblock. Every child block's name
links back up to the parent block where it is referenced.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#example-parent-block">example-child-block-foo</a></span><span class="lilac-caption-link-symbol"><a href="#__NREF__example-child-block-foo">&#x1f517;</a></span></div><pre class="src src-bash" id="__NREF__example-child-block-foo"><span class="org-builtin">echo</span> <span class="org-string">"I am child 1"</span>
</pre></div></div><p>
The blocks below are polyblocks.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#example-parent-block">example-child-block-bar</a></span>(1/2) <span class="lilac-caption-link-symbol"><a href="#__NREF__example-child-block-bar-1">&#x1f517;</a></span></div><pre class="src src-bash" id="__NREF__example-child-block-bar-1"><span class="org-builtin">echo</span> -n <span class="org-string">"I am "</span>
</pre></div></div><p>
Note the fraction after the name which denotes the position of the block in the
overall polyblock "chain".
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#example-parent-block">example-child-block-bar</a></span>(2/2) <span class="lilac-caption-link-symbol"><a href="#__NREF__example-child-block-bar-2">&#x1f517;</a></span></div><pre class="src src-bash" id="__NREF__example-child-block-bar-2"><span class="org-builtin">echo</span> <span class="org-string">"child 2"</span>
</pre></div></div>
</div>

<div id="outline-container-h-Multi-parent-child-blocks" class="outline-5">
<h5 id="h-Multi-parent-child-blocks"><span class="section-number-5">2.1.1.1.</span> Multi-parent child blocks</h5>
<div class="outline-text-5" id="text-h-Multi-parent-child-blocks">
<p>
Sometimes a piece of code will be reused in different source code blocks. You
can think of it as constants in a programming language, but in LP the concept
extends to any arbitrary piece of text.
</p>

<p>
Below is an example where we define a child block once&#x2026;
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#example-parent-1">example-child-block-baz</a></span><span class="lilac-caption-parent-link"><a href="#example-parent-2">2</a></span><span class="lilac-caption-link-symbol"><a href="#__NREF__example-child-block-baz">&#x1f517;</a></span></div><pre class="src src-bash" id="__NREF__example-child-block-baz"><span class="org-builtin">echo</span> <span class="org-string">"Hello from child block baz"</span>
</pre></div></div><p>
&#x2026;but where we also reuse it (reference it) in different parent blocks.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><label class="org-src-name">example-parent-1</label><span class="lilac-caption-link-symbol"><a href="#example-parent-1">&#x1f517;</a></span></div><pre class="src src-bash" id="example-parent-1"><span class="org-builtin">echo</span> <span class="org-string">"Hello from parent 1"</span>
<span class="lilac-child-link-from-parent"><a href="#__NREF__example-child-block-baz">example-child-block-baz</a></span>
</pre></div></div><div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><label class="org-src-name">example-parent-2</label><span class="lilac-caption-link-symbol"><a href="#example-parent-2">&#x1f517;</a></span></div><pre class="src src-bash" id="example-parent-2"><span class="org-builtin">echo</span> <span class="org-string">"Hello from parent 2"</span>
<span class="lilac-child-link-from-parent"><a href="#__NREF__example-child-block-baz">example-child-block-baz</a></span>
</pre></div></div><p>
Notice that the child block has an additional link named "2", which points to
the second parent that references this block (the first parent is linked by the
child block name itself, as in the previous example). If it is referenced in
additional parent blocks, they will show up as links "3", "4", etc.
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-h-Examples" class="outline-3">
<h3 id="h-Examples"><span class="section-number-3">2.2.</span> Examples</h3>
<div class="outline-text-3" id="text-h-Examples">
<p>
Here we have some examples of how certain Org mode features look when exported
to HTML with Lilac. Each section has an orgmode input and HTML output. The input
is what you type into your <code>*.org</code> (plaintext) file, and the output is what you
get in HTML after it is rendered with Lilac's publishing function,
<code>(lilac-publish)</code>.
</p>
</div>

<div id="outline-container-h-Code-blocks" class="outline-4">
<h4 id="h-Code-blocks"><span class="section-number-4">2.2.1.</span> Code blocks</h4>
<div class="outline-text-4" id="text-h-Code-blocks">
</div>

<div id="outline-container-h-Source-blocks" class="outline-5">
<h5 id="h-Source-blocks"><span class="section-number-5">2.2.1.1.</span> Source blocks</h5>
<div class="outline-text-5" id="text-h-Source-blocks">
</div>

<div id="outline-container-h-Plain" class="outline-6">
<h6 id="h-Plain"><span class="section-number-6">2.2.1.1.1.</span> Plain</h6>
<div class="outline-text-6" id="text-h-Plain">
<p>
Orgmode input:
</p>

<div class="org-src-container"><pre class="src src-plaintext" id="nil-2">#+begin_src python
def foo():
    return 42
#+end_src
</pre></div><p>
Rendered HTML output:
</p>

<div class="org-src-container"><pre class="src src-python" id="nil-3"><span class="org-keyword">def</span> <span class="org-function-name">foo</span>():
    <span class="org-keyword">return</span> 42
</pre></div>
</div>
</div>

<div id="outline-container-h-Monoblock" class="outline-6">
<h6 id="h-Monoblock"><span class="section-number-6">2.2.1.1.2.</span> Monoblock</h6>
<div class="outline-text-6" id="text-h-Monoblock">
<p>
Orgmode input:
</p>

<div class="sidenote" id="org000001f">
<p>
Although the <code>ex_monoblock</code> text is linkified here, ignore it. The text that you
need to write in the Orgmode input is literally <code>__NREF__ex_monoblock</code>. Lilac
currently doesn't understand that the block here is an example and that it
should not linkify it.
</p>

</div>

<div class="org-src-container"><pre class="src src-plaintext" id="nil-4">#+caption: A parent block.
#+begin_src python
def foo():
    <span class="lilac-child-link-from-parent"><a href="#__NREF__ex_monoblock">ex_monoblock</a></span>
    return 42
#+end_src

#+name: <span class="lilac-child-link-from-parent"><a href="#__NREF__ex_monoblock">ex_monoblock</a></span>
#+begin_src python
print("hello world")
#+end_src
</pre></div><p>
Rendered HTML output:
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><label class="org-src-name">A parent block.</label><span class="lilac-caption-link-symbol"><a href="#A-parent-block-1">&#x1f517;</a></span></div><pre class="src src-python" id="A-parent-block-1"><span class="org-keyword">def</span> <span class="org-function-name">foo</span>():
    <span class="lilac-child-link-from-parent"><a href="#__NREF__ex_monoblock">ex_monoblock</a></span>
    <span class="org-keyword">return</span> 42
</pre></div></div><div class="sidenote" id="org0000024">
<p>
Similarly, the <code>2</code> link is only here because Lilac thinks that this child block
is referenced in multiple blocks. In a real example this <code>2</code> would not show up.
</p>

</div>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#nil-4">ex_monoblock</a></span><span class="lilac-caption-parent-link"><a href="#A-parent-block-1">2</a></span><span class="lilac-caption-link-symbol"><a href="#__NREF__ex_monoblock">&#x1f517;</a></span></div><pre class="src src-python" id="__NREF__ex_monoblock"><span class="org-builtin">print</span>(<span class="org-string">"hello world"</span>)
</pre></div></div>
</div>
</div>

<div id="outline-container-h-Monoblock--evaluation-result-s-value" class="outline-6">
<h6 id="h-Monoblock--evaluation-result-s-value"><span class="section-number-6">2.2.1.1.3.</span> Monoblock (evaluation result's value)</h6>
<div class="outline-text-6" id="text-h-Monoblock--evaluation-result-s-value">
<p>
Sometimes it's useful to evaluate code and to use the resulting value. This is
in contrast to always inserting the contents of the source code blocks
literally.
</p>

<p>
However you must make sure that the referenced source code block's programming
language is added to the list of <code>org-babel-do-load-languages</code>. Otherwise the
evaluation will be forbidden.
</p>

<p>
Orgmode input:
</p>

<div class="org-src-container"><pre class="src src-plaintext" id="nil-5">#+name: __NREF__ex_evaluate_me
#+begin_src python :exports none
return 4 * 10 + 2
#+end_src

#+caption: This uses an evaluation result.
#+begin_src python :noweb yes
print("The answer is __NREF__ex_evaluate_me()")
#+end_src
</pre></div><p>
Rendered HTML output:
</p>

<div class="sidenote" id="org0000029">
<p>
The "42" here is computed on the fly and injected into the print statement's
string argument.
</p>

</div>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><label class="org-src-name">This uses an evaluation result.</label><span class="lilac-caption-link-symbol"><a href="#This-uses-an-evaluation-result">&#x1f517;</a></span></div><pre class="src src-python" id="This-uses-an-evaluation-result"><span class="org-builtin">print</span>(<span class="org-string">"The answer is 42"</span>)
</pre></div></div>
</div>
</div>

<div id="outline-container-h-Polyblock" class="outline-6">
<h6 id="h-Polyblock"><span class="section-number-6">2.2.1.1.4.</span> Polyblock</h6>
<div class="outline-text-6" id="text-h-Polyblock">
<p>
Orgmode input:
</p>

<div class="sidenote" id="org000002c">
<p>
Like above for monoblocks, Lilac needlessly linkifies the source code body text
of the parent block when it doesn't need to (as this is only an illustrative
example).
</p>

</div>

<div class="org-src-container"><pre class="src src-plaintext" id="nil-6">#+caption: A parent block.
#+begin_src python
def foo():
    <span class="lilac-child-link-from-parent"><a href="#__NREF__ex_polyblock-1">ex_polyblock</a></span>
    return 42
#+end_src

#+header: :noweb-ref <span class="lilac-child-link-from-parent"><a href="#__NREF__ex_polyblock-1">ex_polyblock</a></span>
#+begin_src python
print("hello world")
#+end_src

Some intervening text.

#+header: :noweb-ref <span class="lilac-child-link-from-parent"><a href="#__NREF__ex_polyblock-1">ex_polyblock</a></span>
#+begin_src python
print("abcdefg")
#+end_src
</pre></div><p>
Rendered HTML output:
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><label class="org-src-name">A parent block.</label><span class="lilac-caption-link-symbol"><a href="#A-parent-block-2">&#x1f517;</a></span></div><pre class="src src-python" id="A-parent-block-2"><span class="org-keyword">def</span> <span class="org-function-name">foo</span>():
    <span class="lilac-child-link-from-parent"><a href="#__NREF__ex_polyblock-1">ex_polyblock</a></span>
    <span class="org-keyword">return</span> 42
</pre></div></div><div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#nil-6">ex_polyblock</a></span><span class="lilac-caption-parent-link"><a href="#A-parent-block-2">2</a></span>(1/2) <span class="lilac-caption-link-symbol"><a href="#__NREF__ex_polyblock-1">&#x1f517;</a></span></div><pre class="src src-python" id="__NREF__ex_polyblock-1"><span class="org-builtin">print</span>(<span class="org-string">"hello world"</span>)
</pre></div></div><p>
Some intervening text.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#nil-6">ex_polyblock</a></span><span class="lilac-caption-parent-link"><a href="#A-parent-block-2">2</a></span>(2/2) <span class="lilac-caption-link-symbol"><a href="#__NREF__ex_polyblock-2">&#x1f517;</a></span></div><pre class="src src-python" id="__NREF__ex_polyblock-2"><span class="org-builtin">print</span>(<span class="org-string">"abcdefg"</span>)
</pre></div></div>
</div>
</div>

<div id="outline-container-h-Linking-to-a-line-in-the-code-block-body" class="outline-6">
<h6 id="h-Linking-to-a-line-in-the-code-block-body"><span class="section-number-6">2.2.1.1.5.</span> Linking to a line in the code block body</h6>
<div class="outline-text-6" id="text-h-Linking-to-a-line-in-the-code-block-body">
<div class="sidenote" id="org0000035">
<p>
The <code>-r</code> flag removes these <code>#ref:...</code> labels from the source code. The <code>-l</code>
flag changes the format. In this case we make the format use a leading <code>#</code>
character because that's the comment character in Python. This way they appear
as comments when we are inserting them into the block while still in Orgmode.
</p>

<p>
These links are documented in Org's <a href="https://orgmode.org/manual/Literal-Examples.html">Literal Examples</a> section.
</p>

</div>

<p>
Orgmode input:
</p>

<div class="org-src-container"><pre class="src src-plaintext" id="nil-7">#+begin_src python -r -l "#ref:%s"
print("foo")
print("hi")     #ref:embedded-link
print("bar")
#+end_src

The line at [[(embedded-link)][=embedded-link=]] prints "hi".
</pre></div><p>
Rendered HTML output:
</p>

<div class="org-src-container"><pre class="src src-python" id="nil-8"><span class="org-builtin">print</span>(<span class="org-string">"foo"</span>)
<span id="coderef-embedded-link" class="coderef-off"><span class="org-builtin">print</span>(<span class="org-string">"hi"</span>)</span>
<span class="org-builtin">print</span>(<span class="org-string">"bar"</span>)
</pre></div><p>
The line at <a href="#coderef-embedded-link" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-embedded-link');" onmouseout="CodeHighlightOff(this, 'coderef-embedded-link');"><code>embedded-link</code></a> prints "hi".
</p>
</div>
</div>
</div>

<div id="outline-container-h-Example-blocks" class="outline-5">
<h5 id="h-Example-blocks"><span class="section-number-5">2.2.1.2.</span> Example blocks</h5>
<div class="outline-text-5" id="text-h-Example-blocks">
<p>
Orgmode input:
</p>

<div class="org-src-container"><pre class="src src-plaintext" id="nil-9">#+begin_example
Hello world.
Foo bar.
#+end_example
</pre></div><p>
Rendered HTML output:
</p>

<pre class="example" id="org000003c">
Hello world.
Foo bar.
</pre>
</div>
</div>

<div id="outline-container-h-Quote-blocks" class="outline-5">
<h5 id="h-Quote-blocks"><span class="section-number-5">2.2.1.3.</span> Quote blocks</h5>
<div class="outline-text-5" id="text-h-Quote-blocks">
<p>
Orgmode input:
</p>

<div class="org-src-container"><pre class="src src-plaintext" id="nil-10">#+begin_quote
Hello world.
Foo bar.
#+end_quote
</pre></div><p>
Rendered HTML output:
</p>

<blockquote>
<p>
Hello world.
Foo bar.
</p>
</blockquote>
</div>
</div>
</div>

<div id="outline-container-h-Sidenotes" class="outline-4">
<h4 id="h-Sidenotes"><span class="section-number-4">2.2.2.</span> Sidenotes</h4>
<div class="outline-text-4" id="text-h-Sidenotes">
<p>
Sidenotes are not part of vanilla Orgmode. They are used to insert notes on the
right-hand-side margin, and are inspired by the ones found in Donald Knuth's
books.
</p>

<p>
Note that Lilac only adds some special CSS styling to sidenotes. Orgmode is
generous with source code blocks and accepts any <code>#+begin_foo</code> and <code>#+end_foo</code>
lines.
</p>

<p>
Orgmode input:
</p>

<div class="org-src-container"><pre class="src src-plaintext" id="nil-11">#+begin_sidenote
Hello world.
Foo bar.
#+end_sidenote
</pre></div><p>
Rendered HTML output (see right hand margin):
</p>

<div class="sidenote" id="org0000041">
<p>
Hello world.
Foo bar.
</p>

</div>
</div>
</div>
</div>
</div>

<div id="outline-container-h-Developer-Guide" class="outline-2">
<h2 id="h-Developer-Guide"><span class="section-number-2">3.</span> Developer Guide</h2>
<div class="outline-text-2" id="text-h-Developer-Guide">
<p>
All source code is generated by <i>tangling</i> this Org file (<code>README.org</code>). This
file is the single source of truth for basically everything. Some other things
like COPYRIGHT and LICENSE do not come from this file, but they are exceptions.
</p>

<p>
Tangling is done by loading this file into Emacs and then running
<code>(org-babel-tangle)</code>. This file is also the source of truth for the <i>woven</i>
HTML documentation (<code>README.html</code>), and similarly the HTML is generated by
invoking <code>(lilac-publish)</code>. The outputs of both tangling and weaving are checked
into version control.
</p>

<p>
The <code>Makefile</code> in this repo is used as the main "driver" for both tangling and
weaving. Typically, you would have a browser pointed to <code>README.html</code> and
refresh it after editing the underlying <code>README.org</code> file. After every change to
the Org file, you can run <code>make</code> to tangle, weave, and run unit tests.
</p>
</div>

<div id="outline-container-h-Development-environment--Nix-shell" class="outline-3">
<h3 id="h-Development-environment--Nix-shell"><span class="section-number-3">3.1.</span> Development environment (Nix shell)</h3>
<div class="outline-text-3" id="text-h-Development-environment--Nix-shell">
<p>
This is the main development shell and brings in all of our dependencies to
build all of our code. Taken from <a href="https://github.com/tweag/haskell-stack-nix-example/blob/b9383e35416a2b0e21fbc97ed079538f9f395b6a/shell.nix#L1">here</a>. The <code>Makefile</code> is meant to be executed
from within this environment.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><label class="org-src-name">shell.nix</label><span class="lilac-caption-link-symbol"><a href="#shell-nix">&#x1f517;</a></span></div><pre class="src src-nix" id="shell-nix"><span class="org-nix-keyword">let</span>
  <span class="org-comment"># Nixpkgs snapshot.</span>
  <span class="org-nix-attribute">sources</span> = <span class="org-nix-builtin">import</span> <span class="org-nix-constant">./package/nix/sources.nix</span>;
  <span class="org-comment"># The final "pkgs" attribute.</span>
  <span class="org-nix-attribute">pkgs</span> = <span class="org-nix-builtin">import</span> sources.nixpkgs {};
<span class="org-nix-keyword">in</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">This is our development shell.</span>
pkgs.mkShell ({
  <span class="org-nix-attribute">buildInputs</span> = [
    <span class="org-comment"># Tangling and weaving for Literate Programming.</span>
    pkgs.emacs

    <span class="org-comment"># Update Nix dependencies in package/nix/sources.nix.</span>
    pkgs.niv

    <span class="org-comment"># Misc.</span>
    pkgs.git
    pkgs.less
  ];
})
</pre></div></div>
</div>
</div>

<div id="outline-container-h-Makefile" class="outline-3">
<h3 id="h-Makefile"><span class="section-number-3">3.2.</span> Makefile</h3>
<div class="outline-text-3" id="text-h-Makefile">
<p>
We have a top-level <code>Makefile</code> so that we can run some <code>make</code> commands on the
command line. The overall idea is to tangle and weave, while also running any
associated tests.
</p>

<p>
Note that we make use of the fake file <code>tangle</code>, so that we can write the
top-level <code>test</code> rule as <code>test: tangle</code>, which reads more naturally than the
equivalent <code>test: Makefile</code> or <code>test: lilac.el</code>.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><label class="org-src-name">Makefile</label><span class="lilac-caption-link-symbol"><a href="#Makefile">&#x1f517;</a></span></div><pre class="src src-makefile" id="Makefile"><span class="org-makefile-targets">all</span>: test weave
<span class="org-makefile-targets">.PHONY</span>: all

<span class="org-makefile-targets">test</span>: tangle
    <span class="org-variable-name">LILAC_ROOT</span>=$(<span class="org-variable-name">LILAC_ROOT</span>) emacs --quick --batch --kill --load ert \
        --load lilac.el \
        --load lilac-tests.el \
        --funcall ert-run-tests-batch-and-exit
<span class="org-makefile-targets">.PHONY</span>: test

<span class="lilac-child-link-from-parent"><a href="#__NREF__Makefile-weave">Makefile-weave</a></span>
<span class="lilac-child-link-from-parent"><a href="#__NREF__Makefile-tangle">Makefile-tangle</a></span>
<span class="lilac-child-link-from-parent"><a href="#__NREF__Makefile-run_emacs">Makefile-run_emacs</a></span>
<span class="lilac-child-link-from-parent"><a href="#__NREF__Makefile-update-deps">Makefile-update-deps</a></span>
</pre></div></div><p>
Weaving just depends on the main <code>README.html</code> file being generated. Before we
call <code>(lilac-publish)</code>, we have to first call <code>(lilac-gen-css-and-exit
\"README.org\")</code> because otherwise the source code blocks do not get any syntax
highlighting.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#Makefile">Makefile-weave</a></span><span class="lilac-caption-link-symbol"><a href="#__NREF__Makefile-weave">&#x1f517;</a></span></div><pre class="src src-makefile" id="__NREF__Makefile-weave"><span class="org-makefile-targets">weave</span>: README.html
<span class="org-makefile-targets">.PHONY</span>: weave

<span class="org-makefile-targets">README.html syntax-highlighting.css &amp;</span>: README.org
    $(<span class="org-variable-name">call</span> run_emacs,(lilac-gen-css-and-exit),$<span class="org-constant">&lt;</span>)
    $(<span class="org-variable-name">call</span> run_emacs,(lilac-publish),$<span class="org-constant">&lt;</span>)
</pre></div></div><p>
Tangling is pretty straightforward &#x2014; we just need to call
<code>(org-babel-tangle)</code> on <code>README.org</code>. This generates a number of files, such as
<code>Makefile</code> and <code>shell.nix</code>.
</p>

<p>
The key here is to enumerate these generated files, because we need to tell the
<code>make</code> utility that it should run the rule if <code>README.org</code> has a newer
modification timestamp than any of the generated files. Technically speaking,
because all of the tangled files are tangled together at once with
<code>(org-babel-tangle)</code>, we could just list one of them such as <code>Makefile</code> (instead
of enumerating all of them). However we still enumerate them all here for
completeness.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#Makefile">Makefile-tangle</a></span><span class="lilac-caption-link-symbol"><a href="#__NREF__Makefile-tangle">&#x1f517;</a></span></div><pre class="src src-makefile" id="__NREF__Makefile-tangle"><span class="org-comment-delimiter"># </span><span class="org-comment">tangled_output are all files that are generated by tangling README.org.</span>
<span class="org-variable-name">tangled_output</span> = \
    citations.bib \
    lilac.css \
    lilac.el \
    lilac-tests.el \
    lilac.js \
    lilac.theme \
    .gitattributes \
    .gitignore \
    Makefile \
    shell.nix

<span class="org-makefile-targets">tangle $(</span><span class="org-variable-name"><span class="org-makefile-targets">tangled_output</span></span><span class="org-makefile-targets">) &amp;</span>: README.org
<span class="org-makefile-space">    #</span><span class="org-comment-delimiter"> </span><span class="org-comment">Generate the toplevel Makefile (this file) and others as described in</span>
<span class="org-makefile-space">    #</span><span class="org-comment-delimiter"> </span><span class="org-comment">tangled_output. In a way this bootstraps the whole literate-programming</span>
<span class="org-makefile-space">    #</span><span class="org-comment-delimiter"> </span><span class="org-comment">pipeline.</span>
    $(<span class="org-variable-name">call</span> run_emacs,(org-babel-tangle),README.org)
    touch tangle
</pre></div></div><p>
The <code>run_emacs</code> function is used for both weaving and tangling. The main thing
of interest here is that it loads the <code>lilac.el</code> (tangled) file before
evaluating the given expression.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#Makefile">Makefile-run_emacs</a></span><span class="lilac-caption-link-symbol"><a href="#__NREF__Makefile-run_emacs">&#x1f517;</a></span></div><pre class="src src-makefile" id="__NREF__Makefile-run_emacs">define run_emacs
    <span class="org-variable-name">LILAC_ROOT</span>=$(<span class="org-variable-name">LILAC_ROOT</span>) emacs $(<span class="org-variable-name">2</span>) --quick --batch --kill \
        --load $(<span class="org-variable-name">LILAC_ROOT</span>)/lilac.el --eval=<span class="org-string">"$(</span><span class="org-string"><span class="org-variable-name">1</span></span><span class="org-string">)"</span>
endef

<span class="org-variable-name">LILAC_ROOT</span> := $(<span class="org-variable-name">shell</span> git rev-parse --show-toplevel)
</pre></div></div><p>
We use <a href="https://github.com/nmattia/niv"><code>niv</code></a> to update the dependencies sourced by <code>shell.nix</code>. Niv uses two
sources of truth: the niv repository itself on GitHub, and a branch of nixpkgs.
The former tracks the <code>master</code> branch, and the latter tracks the stable channels
(example: <code>nixos-23.05</code> branch). Whenever we run <code>niv update</code>, <code>niv</code> will update
the HEAD commit SHA of these branches.
</p>

<p>
One problem with the nixpkgs stable channel is that it will eventually become
obsolete as newer stable channels get created. So we have to manually track
these channels ourselves.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#Makefile">Makefile-update-deps</a></span><span class="lilac-caption-link-symbol"><a href="#__NREF__Makefile-update-deps">&#x1f517;</a></span></div><pre class="src src-makefile" id="__NREF__Makefile-update-deps"><span class="org-variable-name">nixpkgs_stable_channel</span> := nixos-23.05
<span class="org-makefile-targets">update-deps</span>: package/nix/sources.json package/nix/sources.nix
    cd package &amp;&amp; niv update nixpkgs --branch $(<span class="org-variable-name">nixpkgs_stable_channel</span>)
    cd package &amp;&amp; niv update
    touch update-deps
</pre></div></div>
</div>
</div>

<div id="outline-container-h-Tangling--generating-the-source-code" class="outline-3">
<h3 id="h-Tangling--generating-the-source-code"><span class="section-number-3">3.3.</span> Tangling (generating the source code)</h3>
<div class="outline-text-3" id="text-h-Tangling--generating-the-source-code">
<p>
Tangling is simply the act of collecting the <code>#+begin_src ... #+end_src</code> blocks
and arranging them into the various target (source code) files. Every source
code block is given a unique name.
</p>

<p>
We simply tangle the <code>README.org</code> file to get all the code we need.
</p>

<p>
The only thing that we customize in terms of tangling is how we define Noweb
references inside source code blocks.
</p>
</div>

<div id="outline-container-h-Custom-Noweb-delimiters" class="outline-4">
<h4 id="h-Custom-Noweb-delimiters"><span class="section-number-4">3.3.1.</span> Custom Noweb delimiters</h4>
<div class="outline-text-4" id="text-h-Custom-Noweb-delimiters">
<p>
By default, Org mode requires Noweb source code references to be delimited with
double angled brackeds (<code>&lt;&lt;</code> and <code>&gt;&gt;</code>). This presents two problems:
</p>

<ol class="org-ol">
<li>The biggest problem with this is that it interferes with syntax highlighting,
especially because different programming languages treat these brackets in a
different manner (it may be a particular type of token in one language, but a
different one in another).</li>
<li>It's also slightly annoying because when searching inside an editor such as
Vim (or even Emacs with the Org mode on), the angle brackets are not
considered part of the word being searched. This means that if the source
code block shares the same name as another (unrelated) string, the search
results for both are combined into one.</li>
</ol>

<p>
To avoid these problems, we simply make Noweb references use a <code>__NREF__</code>
prefix. We also define a suffix group such that the refernce can take an
argument to the code block itself. See the example in FIXME.
</p>

<p>
Note that because this is a customizaion, we cannot run <code>C-c C-v t</code> to tangle
code blocks properly in an interactive manner from an Emacs editing session of
this Org file, without first evaluating the bits of code in the following code
block.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-el">lilac_dot_el-custom-noweb-delimiters</a></span><span class="lilac-caption-link-symbol"><a href="#__NREF__lilac_dot_el-custom-noweb-delimiters">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__lilac_dot_el-custom-noweb-delimiters">(<span class="org-keyword">setq</span> org-babel-noweb-wrap-start <span class="org-string">"__NREF__"</span>)
(<span class="org-keyword">setq</span> org-babel-noweb-wrap-end <span class="org-string">""</span>)

(<span class="org-keyword">defun</span> <span class="org-function-name">lilac-nref-rx</span> (match-optional-params)
  (rx-to-string
   (lilac-nref-rx-primitive match-optional-params)))

(<span class="org-keyword">defun</span> <span class="org-function-name">lilac-nref-rx-primitive</span> (match-optional-params)
  (<span class="org-keyword">if</span> match-optional-params
   `(group
           <span class="org-string">"__NREF__"</span>
          <span class="org-comment-delimiter">;; </span><span class="org-comment">Noweb reference must start with a letter...</span>
          (any alpha)
          <span class="org-comment-delimiter">;; </span><span class="org-comment">...and must be followed by</span>
          <span class="org-comment-delimiter">;; </span><span class="org-comment">letters,numbers,dashes,underscores,periods...</span>
          (* (<span class="org-keyword">or</span> (any alnum) <span class="org-string">"-"</span> <span class="org-string">"_"</span> <span class="org-string">"."</span>))
          <span class="org-comment-delimiter">;; </span><span class="org-comment">...and may terminate with a "(...)" where the "..." may be an empty</span>
          <span class="org-comment-delimiter">;; </span><span class="org-comment">string, or some other argument.</span>
          (* (<span class="org-keyword">or</span> <span class="org-string">"()"</span>
                 (<span class="org-keyword">and</span> <span class="org-string">"("</span>
                      (* (not <span class="org-string">")"</span>))
                      <span class="org-string">")"</span>))))
   `(group
          <span class="org-string">"__NREF__"</span>
          (any alpha)
          (* (<span class="org-keyword">or</span> (any alnum) <span class="org-string">"-"</span> <span class="org-string">"_"</span> <span class="org-string">"."</span>)))))

<span class="org-comment-delimiter">;; </span><span class="org-comment">Customize noweb delimiters. Unlike traditional &lt;&lt; and &gt;&gt; delimiters, we just</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">use the "__NREF__" prefix as our only delimiter. This has the advantage of</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">being encoded the same way into HTML, which makes our HTML modifications</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">easier and more consistent across different source code languages.</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">See https://emacs.stackexchange.com/a/73720/13006.</span>
(<span class="org-keyword">defun</span> <span class="org-function-name">org-babel-noweb-wrap</span> (<span class="org-type">&amp;optional</span> regexp)
  <span class="org-doc">"Return regexp matching a Noweb reference.</span>

<span class="org-doc">Match any reference, or only those matching REGEXP, if non-nil.</span>
<span class="org-doc">When matching, reference is stored in match group 1."</span>
  (lilac-nref-rx t))
</pre></div></div>
</div>
</div>

<div id="outline-container-h-Allow-evaluation-of-code-blocks" class="outline-4">
<h4 id="h-Allow-evaluation-of-code-blocks"><span class="section-number-4">3.3.2.</span> Allow evaluation of code blocks</h4>
<div class="outline-text-4" id="text-h-Allow-evaluation-of-code-blocks">
<p>
Some code blocks are generated by evaluting code in other blocks. This way, you
can use all the power of Org mode (as well as any supported programming
language) as a kind of meta-programming system.
</p>

<p>
Orgmode by default disables automatic evaluation of source code blocks, because
it is a big security risk. For us, we know that we want to allow code
evaluation, so we disable the evaluation confirmation check. This way,
evaluation can still work even in batch mode.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-el">lilac_dot_el-allow-code-evaluation</a></span>(1/2) <span class="lilac-caption-link-symbol"><a href="#__NREF__lilac_dot_el-allow-code-evaluation-1">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__lilac_dot_el-allow-code-evaluation-1">(<span class="org-keyword">setq</span> org-confirm-babel-evaluate nil)
</pre></div></div><p>
The following is needed to evaluate the example for source code block evaluation
in <a href="#h-Monoblock--evaluation-result-s-value">2.2.1.1.3</a>, which evaluates Python. We don't
need to add in Emacs lisp here because it's already supported by default (which
we take advantage of in <a href="#h-Create--lilac-theme--file">3.4.11</a>).
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-el">lilac_dot_el-allow-code-evaluation</a></span>(2/2) <span class="lilac-caption-link-symbol"><a href="#__NREF__lilac_dot_el-allow-code-evaluation-2">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__lilac_dot_el-allow-code-evaluation-2">(org-babel-do-load-languages 'org-babel-load-languages
                             (append org-babel-load-languages
                              '((python     . t))))
</pre></div></div>
</div>
</div>
</div>

<div id="outline-container-h-Weaving--generating-the-HTML" class="outline-3">
<h3 id="h-Weaving--generating-the-HTML"><span class="section-number-3">3.4.</span> Weaving (generating the HTML)</h3>
<div class="outline-text-3" id="text-h-Weaving--generating-the-HTML">
<p>
Weaving is conceptually simpler than tangling because there is no extra step &#x2014;
the output is an HTML page and that is something that we can use directly
(unlike program source code, which may require additional compilation into a
binary, depending on the language). We limit ourselves to HTML output because
HTML support is ubiquitous; plus we don't have to worry about page breaks such
as in PDF output.
</p>

<p>
Although weaving is conceptually simple, most of the code in <a href="lilac.el"><code>lilac.el</code></a> have to
do with weaving because the default infrastructure that ships with Org mode is
too rigid for our needs. For example, we make heavy use of Noweb-style
<a href="#citeproc_bib_item_1">[1]</a> references, but also add in extensive HTML links to allow
the reader to jump around code easily because Org does not cross-link these
references by default.
</p>

<p>
Weaving currently requires the following dependencies:
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Dependency</th>
<th scope="col" class="org-left">Why</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><a href="https://www.gnu.org/software/make/">GNU Make</a></td>
<td class="org-left">to run "make"</td>
</tr>

<tr>
<td class="org-left"><a href="https://www.gnu.org/software/emacs/">GNU Emacs</a></td>
<td class="org-left">for tangling and weaving</td>
</tr>
</tbody>
</table>

<p>
Note that all of the above can be brought in by using the <a href="https://github.com/NixOS/nix">Nix package manager</a>.
This is why we provide a <a href="shell.nix"><code>shell.nix</code></a> file in this repo.
</p>
</div>

<div id="outline-container-h-Emacs-customizations---lilac-el-" class="outline-4">
<h4 id="h-Emacs-customizations---lilac-el-"><span class="section-number-4">3.4.1.</span> Emacs customizations (<code>lilac.el</code>)</h4>
<div class="outline-text-4" id="text-h-Emacs-customizations---lilac-el-">
<p>
Below is the overall structure of <a href="lilac.el"><code>lilac.el</code></a>. The <code>gc-cons-threshold</code>
setting is to prevent <code>emacs</code> from entering garbage collection pauses, because
we invoke <code>emacs</code> from the command line in a non-interactive manner.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><label class="org-src-name">lilac.el</label><span class="lilac-caption-link-symbol"><a href="#lilac-el">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="lilac-el"><span class="org-comment-delimiter">; </span><span class="org-comment">Set garbage-collection threshold to 16 GiB.</span>
(<span class="org-keyword">setq</span> gc-cons-threshold #x400000000)
<span class="lilac-child-link-from-parent"><a href="#__NREF__lilac_dot_el-imports">lilac_dot_el-imports</a></span>
<span class="lilac-child-link-from-parent"><a href="#__NREF__lilac_dot_el-fix-nondeterminism-1">lilac_dot_el-fix-nondeterminism</a></span>
<span class="lilac-child-link-from-parent"><a href="#__NREF__lilac_dot_el-custom-noweb-delimiters">lilac_dot_el-custom-noweb-delimiters</a></span>
<span class="lilac-child-link-from-parent"><a href="#__NREF__lilac_dot_el-allow-code-evaluation-1">lilac_dot_el-allow-code-evaluation</a></span>
<span class="lilac-child-link-from-parent"><a href="#__NREF__lilac_dot_el-lilac-publish-1">lilac_dot_el-lilac-publish</a></span>
<span class="lilac-child-link-from-parent"><a href="#__NREF__lilac_dot_el-lilac-publish-helpers-1">lilac_dot_el-lilac-publish-helpers</a></span>
<span class="lilac-child-link-from-parent"><a href="#__NREF__lilac_dot_el-search-replace-1">lilac_dot_el-search-replace</a></span>
<span class="lilac-child-link-from-parent"><a href="#__NREF__lilac_dot_el-autogenerate-css">lilac_dot_el-autogenerate-css</a></span>
<span class="lilac-child-link-from-parent"><a href="#__NREF__lilac_dot_el-misc-1">lilac_dot_el-misc</a></span>
(<span class="org-keyword">provide</span> '<span class="org-constant">lilac</span>)
</pre></div></div>
</div>
</div>

<div id="outline-container-h-Fix-non-determinism" class="outline-4">
<h4 id="h-Fix-non-determinism"><span class="section-number-4">3.4.2.</span> Fix non-determinism</h4>
<div class="outline-text-4" id="text-h-Fix-non-determinism">
<p>
Nondeterminism is problematic because it results in a different HTML file
every time we run <code>org-babel-tangle</code>, <i>even if the Org files have not changed</i>.
Here we take care to set things right so that we can have reprducible, stable
HTML output.
</p>
</div>

<div id="outline-container-h-Do-not-insert-current-time-as-HTML-comment" class="outline-5">
<h5 id="h-Do-not-insert-current-time-as-HTML-comment"><span class="section-number-5">3.4.2.1.</span> Do not insert current time as HTML comment</h5>
<div class="outline-text-5" id="text-h-Do-not-insert-current-time-as-HTML-comment">
<p>
Org mode also injects an HTML comment (not visible to the user) to record the
time that the HTML was generated. We disable this because it breaks
deterministic output. See <a href="https://emacs.stackexchange.com/questions/50117/how-to-disable-commented-date-in-org-mode-html-export">this link</a> for more info.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-el">lilac_dot_el-fix-nondeterminism</a></span>(1/3) <span class="lilac-caption-link-symbol"><a href="#__NREF__lilac_dot_el-fix-nondeterminism-1">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__lilac_dot_el-fix-nondeterminism-1">(<span class="org-keyword">setq</span> org-export-time-stamp-file nil)
</pre></div></div>
</div>
</div>

<div id="outline-container-h-Do-not-insert-current-Org-mode-version" class="outline-5">
<h5 id="h-Do-not-insert-current-Org-mode-version"><span class="section-number-5">3.4.2.2.</span> Do not insert current Org mode version</h5>
<div class="outline-text-5" id="text-h-Do-not-insert-current-Org-mode-version">
<p>
By default Org mode appends visible metadata at the bottom of the HTML document,
including the Org version used to generate the document. We suppress this
information.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-el">lilac_dot_el-fix-nondeterminism</a></span>(2/3) <span class="lilac-caption-link-symbol"><a href="#__NREF__lilac_dot_el-fix-nondeterminism-2">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__lilac_dot_el-fix-nondeterminism-2">(<span class="org-keyword">setq</span> org-html-postamble nil)
</pre></div></div>
</div>
</div>

<div id="outline-container-h-Do-not-use-random-numbers-for-the-HTML--id--attribute" class="outline-5">
<h5 id="h-Do-not-use-random-numbers-for-the-HTML--id--attribute"><span class="section-number-5">3.4.2.3.</span> Do not use random numbers for the HTML <code>id</code> attribute</h5>
<div class="outline-text-5" id="text-h-Do-not-use-random-numbers-for-the-HTML--id--attribute">
<p>
Stop randomized IDs from being generated every time. Instead count from 0 and
work our way up.
</p>

<p>
See <a href="https://www.reddit.com/r/orgmode/comments/aagmfh/comment/hk6upbf">https://www.reddit.com/r/orgmode/comments/aagmfh/comment/hk6upbf</a>.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-el">lilac_dot_el-fix-nondeterminism</a></span>(3/3) <span class="lilac-caption-link-symbol"><a href="#__NREF__lilac_dot_el-fix-nondeterminism-3">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__lilac_dot_el-fix-nondeterminism-3">(<span class="org-keyword">defun</span> <span class="org-function-name">org-export-deterministic-reference</span> (references)
  (<span class="org-keyword">let</span> ((new (length references)))
     (<span class="org-keyword">while</span> (rassq new references) (<span class="org-keyword">setq</span> new (1+ new)))
     new))
(advice-add #'org-export-new-reference
            <span class="org-builtin">:override</span> #'org-export-deterministic-reference)
</pre></div></div>
</div>
</div>
</div>

<div id="outline-container-h-Toplevel-publishing-function---lilac-publish-" class="outline-4">
<h4 id="h-Toplevel-publishing-function---lilac-publish-"><span class="section-number-4">3.4.3.</span> Toplevel publishing function (<code>lilac-publish</code>)</h4>
<div class="outline-text-4" id="text-h-Toplevel-publishing-function---lilac-publish-">
<p>
The toplevel function is <code>lilac-publish</code>. This actually publishes to HTML twice,
with two separate calls to <code>org-html-export-to-html</code>. The reason we publish
twice is because we need to examine the HTML output twice in order to build up a
database of parent/child source code block links (which is then used to link
between these parent/child source code blocks).
</p>

<p>
Also note that we do some modifications to the Org buffer directly before
exporting to HTML. The main reason is so that the source code blocks that are
named <code>__NREF__...</code> get an automatic <code>#+caption: ...</code> text to go along with it
(because for these Noweb-style blocks, the captions should always look uniform).
</p>

<p>
The full code listing for <code>lilac-publish</code> is below.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><label class="org-src-name">lilac-publish</label><span class="lilac-caption-link-symbol"><a href="#lilac-publish">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="lilac-publish">(<span class="org-keyword">defun</span> <span class="org-function-name">lilac-publish</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">setq</span> org-html-htmlize-output-type 'css)
  (<span class="org-keyword">setq</span> org-export-before-parsing-hook
   '(lilac-UID-for-all-src-blocks
     lilac-insert-noweb-source-code-block-captions
     lilac-UID-for-all-headlines))
  (<span class="org-keyword">setq</span> org-export-filter-src-block-functions
   '(lilac-populate-child-HTML_ID-hash-table
     lilac-populate-org_id-human_id-hash-table))

  (org-html-export-to-html)
  (clrhash lilac-polyblock-names-totals)
  (<span class="org-keyword">setq</span> org-export-filter-src-block-functions
   '(lilac-link-to-children-from-parent-body
     lilac-prettify-source-code-captions))
  (<span class="org-keyword">setq</span> org-export-filter-final-output-functions
   '(lilac-replace-org_ids-with-human_ids))

  (org-html-export-to-html)
  (lilac-replace-from-to-html
   <span class="org-string">"&lt;h2&gt;Table of Contents&lt;/h2&gt;"</span>
   <span class="org-string">""</span>)
  (lilac-replace-from-to-html
   <span class="org-string">".csl-right-inline{margin: 0 0 0 2em;"</span>
   <span class="org-string">".csl-right-inline{margin: 0 0 0 2em;"</span>)
  (lilac-replace-from-to-html
   <span class="org-string">"\"csl-entry\"&gt;&lt;a </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">id=\"[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">\"]+\"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">&gt;&lt;/a&gt;"</span>
   <span class="org-string">"\"csl-entry\" \\1&gt;"</span>
   t)
  (lilac-replace-from-to-html
   <span class="org-string">"&lt;dt&gt;"</span>
   <span class="org-string">"&lt;div class=\"lilac-description-list-entry\"&gt;&lt;dt&gt;"</span>
   t)
  (lilac-replace-from-to-html
   <span class="org-string">"\"lilac-description-list-entry\"&gt;&lt;dt&gt;&lt;a </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">id=\"[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">\"]+\"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">&gt;&lt;/a&gt;"</span>
   <span class="org-string">"\"lilac-description-list-entry\" \\1&gt;&lt;dt&gt;"</span>
   t)
  (lilac-replace-from-to-html
   <span class="org-string">"&lt;/dd&gt;"</span>
   <span class="org-string">"&lt;/dd&gt;&lt;/div&gt;"</span>))
</pre></div></div><p>
Now let's go through <code>lilac-publish</code> in detail.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-el">lilac_dot_el-lilac-publish</a></span>(1/6) <span class="lilac-caption-link-symbol"><a href="#__NREF__lilac_dot_el-lilac-publish-1">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__lilac_dot_el-lilac-publish-1">(<span class="org-keyword">defun</span> <span class="org-function-name">lilac-publish</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">setq</span> org-html-htmlize-output-type 'css)
</pre></div></div><p>
Do not hardcode colors into the HTML. Instead refer to CSS class names, to be
stylized by an external CSS file.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-el">lilac_dot_el-lilac-publish</a></span>(2/6) <span class="lilac-caption-link-symbol"><a href="#__NREF__lilac_dot_el-lilac-publish-2">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__lilac_dot_el-lilac-publish-2">  (<span class="org-keyword">setq</span> org-export-before-parsing-hook
   '(lilac-UID-for-all-src-blocks
     lilac-insert-noweb-source-code-block-captions
     lilac-UID-for-all-headlines))
</pre></div></div><p>
Here we modify the Org mode buffer, by using <code>org-export-before-parsing-hook</code>.
This takes a list of functions that are free to modify the Org mode buffer
before each Org element in the buffer gets converted into HTML.
</p>

<p>
As for the actual modifications, see:
</p>

<ul class="org-ul">
<li><code>lilac-UID-for-all-src-blocks</code> (<a href="#h-Give-all-source-code-blocks-a----name-------field--HTML-ID">3.4.4.1</a>)</li>
<li><code>lilac-insert-noweb-source-code-block-captions</code> (<a href="#h-Automatic-captions-for-Noweb-source-code-blocks">3.4.4.2</a>)</li>
<li><code>lilac-UID-for-all-headlines</code> (<a href="#h-Human-readable-UIDs--Headings--aka-headlines">3.4.4.3</a>)</li>
</ul>

<p>
In brief, the <code>lilac-UID-for-all-*</code> functions make it so that the links to
headlines and source code blocks are both deterministic and human-readable. The
<code>lilac-insert-noweb-source-code-block-captions</code> function
</p>

<p>
Now we start modifying the HTML.
</p>

<p>
This is useful for adding in final tweaks to the HTML that is difficult to
accomplish at the Org-mode buffer level.
</p>

<p>
Phase 1: In the first phase, we use the generated HTML data to populate the
<code>lilac-child-HTML_ID-hash-table</code>. This data structure is used to link to child
blocks from parent blocks. We also populate the
<code>lilac-org_id-human_id-hash-table</code> which is used to convert HTML IDs to be more
human-readable.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-el">lilac_dot_el-lilac-publish</a></span>(3/6) <span class="lilac-caption-link-symbol"><a href="#__NREF__lilac_dot_el-lilac-publish-3">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__lilac_dot_el-lilac-publish-3">  (<span class="org-keyword">setq</span> org-export-filter-src-block-functions
   '(lilac-populate-child-HTML_ID-hash-table
     lilac-populate-org_id-human_id-hash-table))

  (org-html-export-to-html)
</pre></div></div><p>
In between these phases we have to call
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-el">lilac_dot_el-lilac-publish</a></span>(4/6) <span class="lilac-caption-link-symbol"><a href="#__NREF__lilac_dot_el-lilac-publish-4">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__lilac_dot_el-lilac-publish-4">  (clrhash lilac-polyblock-names-totals)
</pre></div></div><p>
because of some internal housekeeping we have to do.
</p>

<p>
Phase 2: In this phase we perform the linking from parent blocks to child blocks
(<code>lilac-link-to-children-from-parent-body</code>), and also convert the child source
code captions to look prettier (<code>lilac-prettify-source-code-captions</code>).
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-el">lilac_dot_el-lilac-publish</a></span>(5/6) <span class="lilac-caption-link-symbol"><a href="#__NREF__lilac_dot_el-lilac-publish-5">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__lilac_dot_el-lilac-publish-5">  (<span class="org-keyword">setq</span> org-export-filter-src-block-functions
   '(lilac-link-to-children-from-parent-body
     lilac-prettify-source-code-captions))
  (<span class="org-keyword">setq</span> org-export-filter-final-output-functions
   '(lilac-replace-org_ids-with-human_ids))

  (org-html-export-to-html)
</pre></div></div><p>
The final bits are
</p>

<ol class="org-ol">
<li>the deletion of the "Table of Contents" text from the autogenerated
Table of Contents section, which we'll <a href="#h-Table-of-contents-sidebar">convert into a sidebar</a>; and</li>
<li>the cleaning up of some inline CSS styles that get injected into the HTML as
part of citation styles.</li>
</ol>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-el">lilac_dot_el-lilac-publish</a></span>(6/6) <span class="lilac-caption-link-symbol"><a href="#__NREF__lilac_dot_el-lilac-publish-6">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__lilac_dot_el-lilac-publish-6">  <span class="lilac-child-link-from-parent"><a href="#__NREF__lilac-publish-delete-toc-text">lilac-publish-delete-toc-text</a></span>
  <span class="lilac-child-link-from-parent"><a href="#__NREF__lilac-publish-fix-inline-styles">lilac-publish-fix-inline-styles</a></span>
  <span class="lilac-child-link-from-parent"><a href="#__NREF__lilac-publish-fix-bibliography-ids">lilac-publish-fix-bibliography-ids</a></span>
  <span class="lilac-child-link-from-parent"><a href="#__NREF__lilac-publish-fix-description-lists">lilac-publish-fix-description-lists</a></span>)
</pre></div></div>
</div>

<div id="outline-container-h-Helper-functions" class="outline-5">
<h5 id="h-Helper-functions"><span class="section-number-5">3.4.3.1.</span> Helper functions</h5>
<div class="outline-text-5" id="text-h-Helper-functions">
<p>
These are for modifying the Org buffer.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-el">lilac_dot_el-lilac-publish-helpers</a></span>(1/2) <span class="lilac-caption-link-symbol"><a href="#__NREF__lilac_dot_el-lilac-publish-helpers-1">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__lilac_dot_el-lilac-publish-helpers-1"><span class="lilac-child-link-from-parent"><a href="#__NREF__UID-for-all-src-blocks">UID-for-all-src-blocks</a></span>
<span class="lilac-child-link-from-parent"><a href="#__NREF__smart-source-code-block-captions">smart-source-code-block-captions</a></span>
<span class="lilac-child-link-from-parent"><a href="#__NREF__UID-for-all-headlines">UID-for-all-headlines</a></span>
</pre></div></div><p>
These are for modifying the HTML.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-el">lilac_dot_el-lilac-publish-helpers</a></span>(2/2) <span class="lilac-caption-link-symbol"><a href="#__NREF__lilac_dot_el-lilac-publish-helpers-2">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__lilac_dot_el-lilac-publish-helpers-2"><span class="lilac-child-link-from-parent"><a href="#__NREF__lilac-link-to-child-blocks-from-parent-1">lilac-link-to-child-blocks-from-parent</a></span>
<span class="lilac-child-link-from-parent"><a href="#__NREF__lilac-prettify-source-code-captions-1">lilac-prettify-source-code-captions</a></span>
<span class="lilac-child-link-from-parent"><a href="#__NREF__lilac-human-readable-src-block-ids">lilac-human-readable-src-block-ids</a></span>
</pre></div></div>
</div>
</div>
</div>

<div id="outline-container-h-Org-modifications" class="outline-4">
<h4 id="h-Org-modifications"><span class="section-number-4">3.4.4.</span> Org modifications</h4>
<div class="outline-text-4" id="text-h-Org-modifications">
</div>

<div id="outline-container-h-Give-all-source-code-blocks-a----name-------field--HTML-ID" class="outline-5">
<h5 id="h-Give-all-source-code-blocks-a----name-------field--HTML-ID"><span class="section-number-5">3.4.4.1.</span> Give all source code blocks a <code>#+name: ...</code> field (HTML ID)</h5>
<div class="outline-text-5" id="text-h-Give-all-source-code-blocks-a----name-------field--HTML-ID">
<p>
Only source code blocks that have a <code>#+name: ...</code> field (org name field) get an
HTML ID (org ID) assigned to it. The problem with polyblocks is that they are
not assigned an org name field by default.
</p>

<p>
Of course, we still want all polyblock to have an HTML ID, which can then be
extracted by <a href="#coderef-lilac-get-src-block-HTML_ID" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-lilac-get-src-block-HTML_ID');" onmouseout="CodeHighlightOff(this, 'coderef-lilac-get-src-block-HTML_ID');"><code>lilac-get-src-block-HTML_ID</code></a> to build up the
<code>lilac-child-HTML_ID-hash-table</code> in <a href="#h-Link-noweb-references--link-to-child-block-from-parent-block">3.4.5.3</a>. If we don't do this then parent source code blocks won't
be able to link to the polyblock at all (or vice versa).
</p>

<p>
Monoblocks with a <code>#+name: ...</code> field get a unique HTML ID assigned to it in
the form <code>orgN</code> where <code>N</code> is a hexadecimal number. By default Org generates a
random number for <code>N</code>, but we use a simple counter that increments, starting
from 0 (see <a href="#h-Do-not-use-random-numbers-for-the-HTML--id--attribute">3.4.2.3</a>).
</p>

<p>
Some source code blocks may not even be monoblocks, because a <code>#+name: ...</code>
field may simply be missing.
</p>

<p>
What we can do is inject a <code>#+name: ___anonymous-src-block-N</code> line (where <code>N</code> is
an incrementing number) into the beginning of the source code section of all
source code blocks that need it. Then we can construct an HTML link to any
source code block.
</p>

<p>
Note that the actual name <code>__anonymous-src-block-N</code> is not important, because it
gets erased and replaced with an <code>orgN</code> ID during HTML export. At that point we
make these <code>orgN</code> strings human-readable in <a href="#h-Use-human-readable-HTML-IDs-for-source-code-links">3.4.5.1</a>.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#__NREF__lilac_dot_el-lilac-publish-helpers-1">UID-for-all-src-blocks</a></span><span class="lilac-caption-link-symbol"><a href="#__NREF__UID-for-all-src-blocks">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__UID-for-all-src-blocks">(<span class="org-keyword">defun</span> <span class="org-function-name">lilac-UID-for-all-src-blocks</span> (_backend)
  (<span class="org-keyword">let*</span> ((all-src-blocks
           <span class="lilac-child-link-from-parent"><a href="#__NREF__all-src-blocks">all-src-blocks</a></span>)
         (counter 0)
         (auto-names
           (-remove 'null
             (<span class="org-keyword">cl-loop</span> for src-block in all-src-blocks collect
               (<span class="org-keyword">let*</span> ((pos (org-element-property <span class="org-builtin">:begin</span> src-block))
                      (parent-name-struct (lilac-get-src-block-name src-block))
                      (direct-name (org-element-property <span class="org-builtin">:name</span> src-block))
                      (no-direct-name (s-blank? direct-name))
                      (prefix
                        (<span class="org-keyword">cond</span> ((s-blank? (car parent-name-struct))
                               <span class="org-string">"___anonymous-src-block"</span>)
                              (t
                               (car parent-name-struct))))
                      (name-final
                       (format <span class="org-string">"#+name: %s-%x\n"</span> prefix counter)))
                 (<span class="org-keyword">setq</span> counter (1+ counter))
                 (<span class="org-keyword">when</span> no-direct-name
                   (cons pos name-final)))))))
    (lilac-insert-strings-into-buffer auto-names)))
</pre></div></div>
</div>
</div>

<div id="outline-container-h-Automatic-captions-for-Noweb-source-code-blocks" class="outline-5">
<h5 id="h-Automatic-captions-for-Noweb-source-code-blocks"><span class="section-number-5">3.4.4.2.</span> Automatic captions for Noweb source code blocks</h5>
<div class="outline-text-5" id="text-h-Automatic-captions-for-Noweb-source-code-blocks">
<p>
For the parent/child source code blocks, we simply build these up by having
blocks named <code>#+name: __NREF__foo</code> or <code>#+header: :noweb-ref __NREF__foo</code>. Each
of these blocks can also reference other blocks by having a line <code>__NREF__bar</code>
inside its body. When defining such blocks, we really don't want to define the
<code>#+caption: ...</code> part manually because it gets tedious rather quickly. Yet we
still have to have these <code>#+caption: ...</code> bits (<i>for every <code>__NREF__...</code>
block!</i>) because that's the only way that Org's HTML exporter knows how to label
these blocks.
</p>

<p>
The code in this section automatically generates <code>#+caption: ...</code> text for these
<code>__NREF__...</code> blocks.
</p>

<p>
We want each <code>#+caption: ...</code> text to have the following items:
</p>

<dl class="org-dl">
<div class="lilac-description-list-entry"><dt><a href="#coderef-NSCB_NAME" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-NSCB_NAME');" onmouseout="CodeHighlightOff(this, 'coderef-NSCB_NAME');"><code>NSCB_NAME</code></a></dt><dd>name of the Noweb source code block,</dd></div>
<div class="lilac-description-list-entry"><dt><a href="#coderef-NSCB_POLYBLOCK_INDICATOR" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-NSCB_POLYBLOCK_INDICATOR');" onmouseout="CodeHighlightOff(this, 'coderef-NSCB_POLYBLOCK_INDICATOR');"><code>NSCB_POLYBLOCK_INDICATOR</code></a></dt><dd>an indicator to show whether this block is
broken up over multiple blocks, and</dd></div>
<div class="lilac-description-list-entry"><dt><a href="#coderef-NSCB_LINKS_TO_PARENTS" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-NSCB_LINKS_TO_PARENTS');" onmouseout="CodeHighlightOff(this, 'coderef-NSCB_LINKS_TO_PARENTS');"><code>NSCB_LINKS_TO_PARENTS</code></a></dt><dd>a link back up to a parent block (if any) where
this block is used; can contain more than 1 parent if multiple parents refer
to this same child block</dd></div>
</dl>

<p>
<i>NSCB</i> here means <i>Noweb source code block</i>. We loop through every source code
block and insert a <code>#+caption: ...</code> text into the buffer. This modified buffer
(with the three bits of information from above) is what is sent down the
pipeline for final export to HTML (i.e., the buffer modification does not affect
the actual buffer (<code>*.org</code> file)).
</p>

<p>
So assume that we already have the smart captions in a sorted <a href="https://www.gnu.org/software/emacs/manual/html_node/elisp/Association-Lists.html">association list</a>
(aka alist), where the KEY is the integer buffer position where this caption
should be inserted, and the VALUE is the caption itself (a string), like this:
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><label class="org-src-name">Caption locations</label><span class="lilac-caption-link-symbol"><a href="#Caption-locations">&#x1f517;</a></span></div><pre class="src src-elisp" id="Caption-locations">'((153  . <span class="org-string">"#+caption: ..."</span>)
  (384  . <span class="org-string">"#+caption: ..."</span>)
  (555  . <span class="org-string">"#+caption: ..."</span>)
  (684  . <span class="org-string">"#+caption: ..."</span>)
  (1051 . <span class="org-string">"#+caption: ..."</span>))
</pre></div></div><p>
We can use the KEY to go to that buffer position and insert the caption. However
the insertion operation mutates the buffer. This means if we perform the
insertions top-to-bottom, the subsequent KEY values will become obsolete. The
trick then is to just do the insertions in reverse order (bottom-to-top), so
that the remaining KEY values remain valid. This is what we do below, where
<code>smart-captions</code> is an alist like the one just described.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#__NREF__lilac_dot_el-lilac-publish-helpers-1">smart-source-code-block-captions</a></span><span class="lilac-caption-link-symbol"><a href="#__NREF__smart-source-code-block-captions">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__smart-source-code-block-captions">(<span class="org-keyword">defun</span> <span class="org-function-name">lilac-insert-noweb-source-code-block-captions</span> (_backend)
  (<span class="org-keyword">let*</span> ((parent-blocks
           <span class="lilac-child-link-from-parent"><a href="#__NREF__parent-blocks">parent-blocks</a></span>)
         (child-parents-hash-table
           <span class="lilac-child-link-from-parent"><a href="#__NREF__child-parents-hash-table">child-parents-hash-table</a></span>)
         (all-src-blocks
           <span class="lilac-child-link-from-parent"><a href="#__NREF__all-src-blocks">all-src-blocks</a></span>)
         (smart-captions
           <span class="lilac-child-link-from-parent"><a href="#__NREF__smart-captions">smart-captions</a></span>))
    (lilac-insert-strings-into-buffer smart-captions)))

<span class="lilac-child-link-from-parent"><a href="#__NREF__smart-source-code-block-captions-helpers-1">smart-source-code-block-captions-helpers</a></span>
</pre></div></div><p>
(We'll get to the helper functions <code>smart-source-code-block-captions-helpers</code>
later as they obscure the big picture.)
</p>

<p>
Now we just have to construct <code>smart-captions</code>. The main difficulty is the
construction of <a href="#coderef-NSCB_LINKS_TO_PARENTS" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-NSCB_LINKS_TO_PARENTS');" onmouseout="CodeHighlightOff(this, 'coderef-NSCB_LINKS_TO_PARENTS');"><code>NSCB_LINKS_TO_PARENTS</code></a>, so most of the code will be concerned
about child-parent associations.
</p>

<p>
Why do we even need these source code blocks to link back to their parents? The
point is to make things easier to navigate. For example, if we have
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><label class="org-src-name">Sample Org-mode Noweb-style references</label><span class="lilac-caption-link-symbol"><a href="#Sample-Org-mode-Noweb-style-references-2">&#x1f517;</a></span></div><pre class="src src-org" id="Sample-Org-mode-Noweb-style-references-2"><span class="org-org-meta-line">#+name: parent-block</span>
<span class="org-org-block-begin-line">#+begin_src bash</span>
<span class="org-org-block"><span class="org-builtin">echo</span></span><span class="org-org-block"> </span><span class="org-org-block"><span class="org-string">"Hello from the parent block"</span></span>
<span class="org-org-block">__NREF__child-block-1</span>
<span class="org-org-block">__NREF__child-block-2</span>
<span class="org-org-block-end-line">#+end_src</span>

...

<span class="org-org-meta-line">#+name: __NREF__child-block-1</span>
<span class="org-org-block-begin-line">#+begin_src bash</span>
<span class="org-org-block"><span class="org-builtin">echo</span></span><span class="org-org-block"> </span><span class="org-org-block"><span class="org-string">"I am child 1"</span></span>
<span class="org-org-block-end-line">#+end_src</span>

...

<span class="org-org-meta-line">#+header: :noweb-ref __NREF__child-block-2</span>
<span class="org-org-block-begin-line">#+begin_src bash</span>
<span class="org-org-block"><span class="org-builtin">echo</span></span><span class="org-org-block"> -n </span><span class="org-org-block"><span class="org-string">"I am "</span></span>
<span class="org-org-block-end-line">#+end_src</span>

<span class="org-org-meta-line">#+header: :noweb-ref __NREF__child-block-2</span>
<span class="org-org-block-begin-line">#+begin_src bash</span>
<span class="org-org-block"><span class="org-builtin">echo</span></span><span class="org-org-block"> </span><span class="org-org-block"><span class="org-string">"child 2"</span></span>
<span class="org-org-block-end-line">#+end_src</span>
</pre></div></div><p>
and we export this to HTML, ideally we would want both <code>__NREF__child-block-1</code>
and each of the <code>__NREF__child-block-2</code> blocks to include an HTML link back up
to <code>parent-block</code>. This would make it easier to skim the document and not get
too lost (any time you are looking at any particular source code block, you
would be able to just click on the link back to the parent (if there is one) to
see a higher-level view).
</p>

<p>
The key idea here is to build a hash table (<code>child-parents-hash-table</code>) where
the KEY is a child source code block and the VALUE is the parent block(s). Then
in order to construct <a href="#coderef-NSCB_LINKS_TO_PARENTS" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-NSCB_LINKS_TO_PARENTS');" onmouseout="CodeHighlightOff(this, 'coderef-NSCB_LINKS_TO_PARENTS');"><code>NSCB_LINKS_TO_PARENTS</code></a> we just do a lookup against this
hash table to find the parent(s), if any.
</p>

<p>
The first thing we need is a list of parent source code blocks. We consider a
source code block a parent block if it has any Noweb references within its body.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#__NREF__smart-source-code-block-captions">parent-blocks</a></span><span class="lilac-caption-link-symbol"><a href="#__NREF__parent-blocks">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__parent-blocks">(lilac-get-parent-blocks)
</pre></div></div><p>
Then we construct the <code>child-parents-hash-table</code>. For each parent block, we get
all of its children (<code>child-names</code>), and use this data to construct a
child-parent association. Note that we use <code>cl-pushnew</code> instead of <code>push</code> to
deduplicate parents (i.e., when a single parent refers to the same child more
than once we do not want to link back to this same parent more than once from
the child block's caption).
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#__NREF__smart-source-code-block-captions">child-parents-hash-table</a></span><span class="lilac-caption-link-symbol"><a href="#__NREF__child-parents-hash-table">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__child-parents-hash-table">(lilac-mk-child-parents-hash-table parent-blocks)
</pre></div></div><p>
Now that we have the child-parent associations, we have to look at all source
code blocks and check if
</p>

<ol class="org-ol">
<li>this source code block's name shows up at all in <code>child-parents-hash-table</code>,
and if so</li>
<li>add a link to the parent (<a href="#coderef-NSCB_LINKS_TO_PARENTS" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-NSCB_LINKS_TO_PARENTS');" onmouseout="CodeHighlightOff(this, 'coderef-NSCB_LINKS_TO_PARENTS');"><code>NSCB_LINKS_TO_PARENTS</code></a>).</li>
</ol>

<p>
Let's grab all source code blocks:
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#__NREF__UID-for-all-src-blocks">all-src-blocks</a></span><span class="lilac-caption-parent-link"><a href="#__NREF__smart-source-code-block-captions">2</a></span><span class="lilac-caption-parent-link"><a href="#__NREF__smart-source-code-block-captions-helpers-4">3</a></span><span class="lilac-caption-link-symbol"><a href="#__NREF__all-src-blocks">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__all-src-blocks">(org-element-map (org-element-parse-buffer) 'src-block 'identity)
</pre></div></div><p>
And now we can finally construct <code>smart-captions</code>:
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#__NREF__smart-source-code-block-captions">smart-captions</a></span><span class="lilac-caption-link-symbol"><a href="#__NREF__smart-captions">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__smart-captions">(lilac-mk-smart-captions child-parents-hash-table)
</pre></div></div><p>
We used some helper functions up in <a href="#__NREF__smart-source-code-block-captions"><code>__NREF__smart-source-code-block-captions</code></a>;
let's examine them now.
</p>

<p>
<code>lilac-is-parent-block</code> checks whether a source code block is a parent (contains
noweb references to other child blocks in the form <code>__NREF__child-name</code>).
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#__NREF__smart-source-code-block-captions">smart-source-code-block-captions-helpers</a></span>(1/9) <span class="lilac-caption-link-symbol"><a href="#__NREF__smart-source-code-block-captions-helpers-1">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__smart-source-code-block-captions-helpers-1">(<span class="org-keyword">defun</span> <span class="org-function-name">lilac-is-parent-block</span> (src-block)
  (<span class="org-keyword">let</span> ((body (org-element-property <span class="org-builtin">:value</span> src-block)))
    (lilac-get-noweb-children body)))
</pre></div></div><p>
<code>lilac-get-parent-blocks</code> retrieves all source code blocks that are parents
(which have <code>__NREF__...</code> references).
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#__NREF__smart-source-code-block-captions">smart-source-code-block-captions-helpers</a></span>(2/9) <span class="lilac-caption-link-symbol"><a href="#__NREF__smart-source-code-block-captions-helpers-2">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__smart-source-code-block-captions-helpers-2">(<span class="org-keyword">defun</span> <span class="org-function-name">lilac-get-parent-blocks</span> ()
  (org-element-map (org-element-parse-buffer) 'src-block
    (<span class="org-keyword">lambda</span> (src-block)
       (<span class="org-keyword">if</span> (lilac-is-parent-block src-block) src-block))))
</pre></div></div><p>
<code>lilac-mk-child-parents-hash-table</code> takes all parent source code blocks and
generates a hash table where the KEY is the child block name and the VALUE is
the list of parents that refer to the child. When we loop through
<code>parent-blocks</code> below, we have to first <code>reverse</code> it because the function
<code>cl-pushnew</code> grows the list by prepending to it.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#__NREF__smart-source-code-block-captions">smart-source-code-block-captions-helpers</a></span>(3/9) <span class="lilac-caption-link-symbol"><a href="#__NREF__smart-source-code-block-captions-helpers-3">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__smart-source-code-block-captions-helpers-3">(<span class="org-keyword">defun</span> <span class="org-function-name">lilac-mk-child-parents-hash-table</span> (parent-blocks)
  (<span class="org-keyword">let</span> ((hash-table (make-hash-table <span class="org-builtin">:test</span> 'equal)))
    (mapc
     (<span class="org-keyword">lambda</span> (parent-block)
      (<span class="org-keyword">let*</span> ((parent-name (org-element-property <span class="org-builtin">:name</span> parent-block))
             (parent-body (org-element-property <span class="org-builtin">:value</span> parent-block))
             (child-names (lilac-get-noweb-children parent-body)))
        (mapc (<span class="org-keyword">lambda</span> (child-name)
                (<span class="org-keyword">let*</span> ((parents (gethash child-name hash-table)))
                  (<span class="org-keyword">if</span> parents
                    (puthash child-name
                             (<span class="org-keyword">cl-pushnew</span> parent-name parents)
                             hash-table)
                    (puthash child-name (list parent-name) hash-table))))
              child-names)))
     (reverse parent-blocks))
    hash-table))
</pre></div></div><p>
<code>lilac-mk-smart-captions</code> generates an alist of buffer positions (positive
integer) and the literal <code>#+caption: ...</code> text that needs to be inserted back
into the buffer.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#__NREF__smart-source-code-block-captions">smart-source-code-block-captions-helpers</a></span>(4/9) <span class="lilac-caption-link-symbol"><a href="#__NREF__smart-source-code-block-captions-helpers-4">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__smart-source-code-block-captions-helpers-4">(<span class="org-keyword">defun</span> <span class="org-function-name">lilac-mk-smart-captions</span> (child-parents-hash-table)
  (-remove 'null
    (<span class="org-keyword">cl-loop</span> for src-block in <span class="lilac-child-link-from-parent"><a href="#__NREF__all-src-blocks">all-src-blocks</a></span> collect
      (<span class="org-keyword">let*</span> ((child (lilac-get-src-block-name src-block))
             (child-name (car child))
<span id="coderef-NSCB_NAME" class="coderef-off">             (NSCB_NAME (format <span class="org-string">"=%s= "</span> child-name))</span>
<span id="coderef-NSCB_POLYBLOCK_INDICATOR" class="coderef-off">             (NSCB_POLYBLOCK_INDICATOR</span>
               (<span class="org-keyword">if</span> (lilac-get-noweb-ref-polyblock-name src-block)
                   <span class="org-string">"(polyblock)"</span>
                 <span class="org-string">""</span>))
             (polyblock-counter
              (gethash child-name lilac-polyblock-names-totals 0))
             (polyblock-counter-incremented
              (puthash child-name (1+ polyblock-counter)
                       lilac-polyblock-names-totals))
             (parents (gethash child-name child-parents-hash-table))
             (parents-zipped (lilac-enumerate parents))
             (pos (org-element-property <span class="org-builtin">:begin</span> src-block))
<span id="coderef-NSCB_LINKS_TO_PARENTS" class="coderef-off">             (NSCB_LINKS_TO_PARENTS</span>
              (mapconcat (<span class="org-keyword">lambda</span> (parent-with-idx)
                           (format <span class="org-string">" [[%s][%d]]"</span>
                                   (nth 1 parent-with-idx)
                                   (1+ (nth 0 parent-with-idx))))
                         parents-zipped <span class="org-string">" "</span>))
             (smart-caption
              (concat
                <span class="org-string">"#+caption: "</span>
                NSCB_NAME
                NSCB_POLYBLOCK_INDICATOR
                NSCB_LINKS_TO_PARENTS
                <span class="org-string">"\n"</span>)))
        (<span class="org-keyword">when</span> parents (cons pos smart-caption))))))
</pre></div></div><p>
<code>lilac-insert-strings-into-buffer</code> takes an alist of buffer positions and
strings and inserts them all into the buffer.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#__NREF__smart-source-code-block-captions">smart-source-code-block-captions-helpers</a></span>(5/9) <span class="lilac-caption-link-symbol"><a href="#__NREF__smart-source-code-block-captions-helpers-5">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__smart-source-code-block-captions-helpers-5">(<span class="org-keyword">defun</span> <span class="org-function-name">lilac-insert-strings-into-buffer</span> (pos-strings)
  (<span class="org-keyword">cl-loop</span> for pos-string in (reverse pos-strings) do
        (<span class="org-keyword">let</span> ((pos (car pos-string))
              (str (cdr pos-string)))
          (goto-char pos)
          (insert str))))
</pre></div></div><p>
<code>lilac-get-noweb-children</code> extracts all Noweb references in the form
"<code>__NREF__foo</code>" from a given multiline string, returning a list of all such
references. This function expects at most 1 Noweb reference per line. The return
type is a list of strings.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#__NREF__smart-source-code-block-captions">smart-source-code-block-captions-helpers</a></span>(6/9) <span class="lilac-caption-link-symbol"><a href="#__NREF__smart-source-code-block-captions-helpers-6">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__smart-source-code-block-captions-helpers-6">(<span class="org-keyword">defun</span> <span class="org-function-name">lilac-get-noweb-children</span> (s)
  (<span class="org-keyword">let*</span> ((lines (split-string s <span class="org-string">"\n"</span>))
         (refs (-remove 'null
                 (mapcar
                  (<span class="org-keyword">lambda</span> (line)
                   (<span class="org-keyword">if</span> (string-match (lilac-nref-rx nil) line)
                       (match-string-no-properties 1 line)))
                  lines))))
    refs))
</pre></div></div><p>
<code>lilac-get-noweb-ref-polyblock-name</code> gets the string <code>__NREF__foo</code> in a
<code>#+header: :noweb-ref __NREF__foo</code> line for a source code block.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#__NREF__smart-source-code-block-captions">smart-source-code-block-captions-helpers</a></span>(7/9) <span class="lilac-caption-link-symbol"><a href="#__NREF__smart-source-code-block-captions-helpers-7">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__smart-source-code-block-captions-helpers-7">(<span class="org-keyword">defun</span> <span class="org-function-name">lilac-get-noweb-ref-polyblock-name</span> (source-code-block)
  (<span class="org-keyword">let*</span> ((headers (org-element-property <span class="org-builtin">:header</span> source-code-block))
         (noweb-ref-name
          (nth 0
           (-remove 'null
            (mapcar
             (<span class="org-keyword">lambda</span> (header)
               (<span class="org-keyword">if</span> (string-match <span class="org-string">":noweb-ref </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> header)
                   (match-string-no-properties 1 header)))
             headers)))))
    noweb-ref-name))
</pre></div></div><p>
Note that a child source block can have two ways of defining its name. The first
is with the direct <code>#+name: __NREF__foo</code> style (<a href="#org0000009">monoblock</a>), and the second way
is with a line like <code>#+header: :noweb-ref __NREF__foo</code> (<a href="#org000000b">polyblock</a>). Here
<code>lilac-get-src-block-name</code> grabs the name of a (child) source code block, taking
into account these two styles. For polyblock names, we mark it as such with a
<code>(polyblock)</code> string, which is used later for the <a href="#coderef-NSCB_POLYBLOCK_INDICATOR" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-NSCB_POLYBLOCK_INDICATOR');" onmouseout="CodeHighlightOff(this, 'coderef-NSCB_POLYBLOCK_INDICATOR');"><code>NSCB_POLYBLOCK_INDICATOR</code></a>.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#__NREF__smart-source-code-block-captions">smart-source-code-block-captions-helpers</a></span>(8/9) <span class="lilac-caption-link-symbol"><a href="#__NREF__smart-source-code-block-captions-helpers-8">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__smart-source-code-block-captions-helpers-8">(<span class="org-keyword">defun</span> <span class="org-function-name">lilac-get-src-block-name</span> (src-block)
  (<span class="org-keyword">let*</span> ((name-direct (org-element-property <span class="org-builtin">:name</span> src-block))
         (name-indirect (lilac-get-noweb-ref-polyblock-name src-block)))
    (<span class="org-keyword">if</span> name-indirect
        `(,name-indirect <span class="org-string">"(polyblock)"</span>)
        `(,name-direct <span class="org-string">""</span>))))
</pre></div></div><p>
Next we have some helpers to enumerate through a list just like in Python. The
index starts at 0 (same as Python).
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#__NREF__smart-source-code-block-captions">smart-source-code-block-captions-helpers</a></span>(9/9) <span class="lilac-caption-link-symbol"><a href="#__NREF__smart-source-code-block-captions-helpers-9">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__smart-source-code-block-captions-helpers-9">(<span class="org-keyword">defun</span> <span class="org-function-name">lilac-enumerate</span> (lst <span class="org-type">&amp;optional</span> start)
  (<span class="org-keyword">let</span> ((ret ()))
    (<span class="org-keyword">cl-loop</span> for index from (<span class="org-keyword">if</span> start start 0)
           for item in lst
           do (<span class="org-keyword">push</span> (list index item) ret))
    (reverse ret)))

<span class="org-comment-delimiter">; </span><span class="org-comment">See https://emacs.stackexchange.com/a/7150.</span>
(<span class="org-keyword">defun</span> <span class="org-function-name">lilac-matches</span> (regexp s <span class="org-type">&amp;optional</span> group)
  <span class="org-doc">"Get a list of all regexp matches in a string"</span>
  (<span class="org-keyword">if</span> (= (length s) 0)
      ()
      (<span class="org-keyword">save-match-data</span>
        (<span class="org-keyword">let</span> ((pos 0)
              (matches ()))
          (<span class="org-keyword">while</span> (string-match regexp s pos)
            (<span class="org-keyword">push</span> (match-string (<span class="org-keyword">if</span> group group 0) s) matches)
            (<span class="org-keyword">setq</span> pos (match-end 0)))
          (reverse matches)))))
</pre></div></div>
</div>
</div>

<div id="outline-container-h-Human-readable-UIDs--Headings--aka-headlines" class="outline-5">
<h5 id="h-Human-readable-UIDs--Headings--aka-headlines"><span class="section-number-5">3.4.4.3.</span> Human-readable UIDs (Headings, aka headlines)</h5>
<div class="outline-text-5" id="text-h-Human-readable-UIDs--Headings--aka-headlines">
<p>
By default Org does a terrible job of naming HTML <code>id</code> fields for headings. By
default it uses a randomly-generated number. In <a href="#h-Do-not-use-random-numbers-for-the-HTML--id--attribute">3.4.2.3</a> we tweak this behavior to use a deterministic,
incrementing number starting from 0. However while this solution gets rid of the
nondeterminism, it still results in human-unfriendly <code>id</code> attributes because
they are all numeric (e.g. <code>org00000a1</code>, <code>org00000f3</code>, etc).
</p>

<p>
For headings, we can do better because in practice they already mostly have
unique contents, which should work most of the time to act as an <code>id</code>. In other
words, we want all headings to have HTML IDs that are patterned after their
contents. This way we can have IDs like <code>some-heading-name-1</code> (where the
trailing <code>-1</code> is only used to disambiguate against another heading of the same
name) instead of <code>org00000a1</code> (numeric hex).
</p>

<p>
For each heading, we insert a <code>CUSTOM_ID</code> property. This makes Org refer to this
<code>CUSTOM_ID</code> instead of the numeric <code>org...</code> link names. We append this headline
property just below every headline we find in the buffer. The actual
construction of the <code>CUSTOM_ID</code> (<code>headline-UID</code> in the code below) is done by
<code>lilac-get-unique-id</code>.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#__NREF__lilac_dot_el-lilac-publish-helpers-1">UID-for-all-headlines</a></span><span class="lilac-caption-link-symbol"><a href="#__NREF__UID-for-all-headlines">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__UID-for-all-headlines">(<span class="org-keyword">defun</span> <span class="org-function-name">lilac-UID-for-all-headlines</span> (_backend)
  (<span class="org-keyword">let*</span> ((all-headlines
           (org-element-map (org-element-parse-buffer) 'headline 'identity))

         (headline-uid-hash-table (make-hash-table <span class="org-builtin">:test</span> 'equal))
         (headline-UIDs
           (-remove 'null
             (<span class="org-keyword">cl-loop</span> for headline in all-headlines collect
               (<span class="org-keyword">let*</span> ((headline-UID
                       (lilac-get-unique-id headline headline-uid-hash-table))
                      <span class="org-comment-delimiter">;; </span><span class="org-comment">Get the position just after the headline (just</span>
                      <span class="org-comment-delimiter">;; </span><span class="org-comment">underneath it).</span>
                      (pos (<span class="org-keyword">progn</span>
                             (goto-char (org-element-property <span class="org-builtin">:begin</span> headline))
                             (re-search-forward <span class="org-string">"\n"</span>))))
                 (cons pos (concat
                            <span class="org-string">":PROPERTIES:\n"</span>
                            <span class="org-string">":CUSTOM_ID: "</span> headline-UID <span class="org-string">"\n"</span>
                            <span class="org-string">":END:\n"</span>)))))))
    (lilac-insert-strings-into-buffer headline-UIDs)))

<span class="lilac-child-link-from-parent"><a href="#__NREF__get-unique-id">get-unique-id</a></span>
</pre></div></div><p>
<code>lilac-get-unique-id</code> converts a given headline to its canonical form (every
non-word character converted to a dash) and performs a lookup against the hash
table. If the entry exists, it looks up a <code>entry-N</code> value in a loop with <code>N</code>
increasing until it sees that no such key exists (at which point we know that we
have a unique ID).
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#__NREF__UID-for-all-headlines">get-unique-id</a></span><span class="lilac-caption-link-symbol"><a href="#__NREF__get-unique-id">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__get-unique-id">(<span class="org-keyword">defun</span> <span class="org-function-name">lilac-get-unique-id</span> (headline hash-table)
  (<span class="org-keyword">let*</span> ((name (org-element-property <span class="org-builtin">:raw-value</span> headline))
         (disambiguation-number 0)
         (key (concat <span class="org-string">"h-"</span> (lilac-normalize-string name)))
         (val (gethash key hash-table)))
    <span class="org-comment-delimiter">;; </span><span class="org-comment">Discard the key if a value already exists. This drives up the</span>
    <span class="org-comment-delimiter">;; </span><span class="org-comment">disambiguation number.</span>
    (<span class="org-keyword">while</span> val
      (<span class="org-keyword">setq</span> disambiguation-number (1+ disambiguation-number))
      (<span class="org-keyword">setq</span> key (concat <span class="org-string">"h-"</span>
                        (lilac-normalize-string
                         (format <span class="org-string">"%s-%s"</span> name disambiguation-number))))
      (<span class="org-keyword">setq</span> val (gethash key hash-table)))
    (puthash key t hash-table)
    key))

(<span class="org-keyword">defun</span> <span class="org-function-name">lilac-normalize-string</span> (s)
  (string-trim
    (replace-regexp-in-string <span class="org-string">"[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">A-Za-z0-9]"</span> <span class="org-string">"-"</span> s)
    <span class="org-string">"-"</span>
    <span class="org-string">"-"</span>))
</pre></div></div>
</div>
</div>
</div>

<div id="outline-container-h-HTML-modifications" class="outline-4">
<h4 id="h-HTML-modifications"><span class="section-number-4">3.4.5.</span> HTML modifications</h4>
<div class="outline-text-4" id="text-h-HTML-modifications">
</div>

<div id="outline-container-h-Use-human-readable-HTML-IDs-for-source-code-links" class="outline-5">
<h5 id="h-Use-human-readable-HTML-IDs-for-source-code-links"><span class="section-number-5">3.4.5.1.</span> Use human-readable HTML IDs for source code links</h5>
<div class="outline-text-5" id="text-h-Use-human-readable-HTML-IDs-for-source-code-links">
<p>
Recall that there are 2 types of source code blocks: <a href="#org0000009">monoblocks</a> and <a href="#org000000b">polyblocks</a>.
</p>

<p>
Polyblocks do get a name field attached to them during the <a href="#h-Give-all-source-code-blocks-a----name-------field--HTML-ID">Org
modification stage</a>, in the format <code>___anonymous-src-block-N</code>. These names are
for HTML link generation only, because the user won't see them &#x2014; they will
instead just see <code>org000012</code> or some such. In fact, all monoblocks are also
given these random-looking (and unstable) <code>org...</code> HTML IDs.
</p>

<p>
And therein lies the problem: if a user decides to bookmark a particular source
code block, whether a monoblock or polyblock, they will link to an
<code>org...</code>-style ID and chances are that this link will break over time.
</p>

<p>
This is exactly the same problem we have for headlines. For headlines we solved
the problem with a <a href="#h-Human-readable-UIDs--Headings--aka-headlines">hash table</a>, and we need to do the same thing here. The major
difference, though, is that unlike headlines which can accept a <code>CUSTOM_ID</code> Org
property, source code blocks have no such facility. So instead of modifying the
buffer (as we do for headlines), we have to modify the final HTML output
instead.
</p>

<p>
The solution is to simply look at all source code block links, then modify the
<code>id=...</code> part so that it looks like a more human-readable ID. We can extract the
human-readable ID by looking at the smart captions inside the
<code>&lt;label&gt;...&lt;/label&gt;</code> area for both monoblocks and polyblocks. And then it's just
a matter of doing a basic search-and-replace across the entire buffer (HTML
file).
</p>

<p>
We have to do a search-and-replace across the entire file because we may also
have manual links to source code blocks (although &#x2014; maybe it's just not worth
it because we can't refer to polyblocks anyway by name).
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#__NREF__lilac_dot_el-lilac-publish-helpers-2">lilac-human-readable-src-block-ids</a></span><span class="lilac-caption-link-symbol"><a href="#__NREF__lilac-human-readable-src-block-ids">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__lilac-human-readable-src-block-ids">(<span class="org-keyword">setq</span> lilac-org_id-human_id-hash-table (make-hash-table <span class="org-builtin">:test</span> 'equal))
(<span class="org-keyword">setq</span> lilac-human_id-count-hash-table (make-hash-table <span class="org-builtin">:test</span> 'equal))
(<span class="org-keyword">setq</span> lilac-human_id-org_id-hash-table (make-hash-table <span class="org-builtin">:test</span> 'equal))

(<span class="org-keyword">defun</span> <span class="org-function-name">lilac-populate-org_id-human_id-hash-table</span> (src-block-html backend info)
  (<span class="org-keyword">when</span> (org-export-derived-backend-p backend 'html)
    (<span class="org-keyword">let*</span> ((block-name (lilac-get-src-block-name-from-html src-block-html))
           (block-name-count (gethash block-name
                                      lilac-human_id-count-hash-table
                                      0))
           (orgid (lilac-get-src-block-HTML_ID src-block-html)))
      (<span class="org-keyword">when</span> orgid
        (puthash block-name
                 (1+ block-name-count)
                 lilac-human_id-count-hash-table)
        (<span class="org-keyword">cond</span> ((= block-name-count 0)
                (<span class="org-keyword">progn</span>
                  (puthash orgid
                           block-name
                           lilac-org_id-human_id-hash-table)
                  (puthash block-name
                           orgid
                           lilac-human_id-org_id-hash-table)))
              ((= block-name-count 1)
                (<span class="org-keyword">let*</span> ((orgid-first-block
                        (gethash block-name lilac-human_id-org_id-hash-table)))
                  (puthash orgid-first-block
                           (format <span class="org-string">"%s-1"</span> block-name)
                           lilac-org_id-human_id-hash-table)
                  (puthash orgid
                           (format <span class="org-string">"%s-%d"</span> block-name (1+ block-name-count))
                           lilac-org_id-human_id-hash-table)))
              (t
                 (puthash orgid
                          (format <span class="org-string">"%s-%d"</span> block-name (1+ block-name-count))
                          lilac-org_id-human_id-hash-table))))
      src-block-html)))

(<span class="org-keyword">defun</span> <span class="org-function-name">lilac-replace-org_ids-with-human_ids</span> (entire-html backend info)
  (<span class="org-keyword">when</span> (org-export-derived-backend-p backend 'html)
    (<span class="org-keyword">let</span> ((html-oneline (lilac-to-single-line entire-html)))
      (maphash
       (<span class="org-keyword">lambda</span> (k v)
        (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> k v)
         (<span class="org-keyword">setq</span> html-oneline
               (replace-regexp-in-string
                (rx-to-string `(<span class="org-keyword">and</span> <span class="org-string">" id="</span> (* (not <span class="org-string">"\""</span>)) <span class="org-string">"\""</span> ,k <span class="org-string">"\""</span>))
                (format <span class="org-string">" id=\"%s\""</span> v) html-oneline))
         (<span class="org-keyword">setq</span> html-oneline
               (replace-regexp-in-string
                (rx-to-string `(<span class="org-keyword">and</span> <span class="org-string">" href="</span> (* (not <span class="org-string">"\""</span>)) <span class="org-string">"\"#"</span> ,k <span class="org-string">"\""</span>))
                (format <span class="org-string">" href=\"#%s\""</span> v) html-oneline))))
       lilac-org_id-human_id-hash-table)
      (lilac-to-multi-line html-oneline))))

(<span class="org-keyword">defun</span> <span class="org-function-name">lilac-to-single-line</span> (s)
  (replace-regexp-in-string <span class="org-string">"\n"</span> <span class="org-string">"&lt;&lt;&lt;LILAC_NEWLINE&gt;&gt;&gt;"</span> s))

(<span class="org-keyword">defun</span> <span class="org-function-name">lilac-to-multi-line</span> (s)
  (replace-regexp-in-string <span class="org-string">"&lt;&lt;&lt;LILAC_NEWLINE&gt;&gt;&gt;"</span> <span class="org-string">"\n"</span> s))
</pre></div></div>
</div>
</div>

<div id="outline-container-h-Pretty-source-code-captions" class="outline-5">
<h5 id="h-Pretty-source-code-captions"><span class="section-number-5">3.4.5.2.</span> Pretty source code captions</h5>
<div class="outline-text-5" id="text-h-Pretty-source-code-captions">
<p>
The default HTML export creates a <code>&lt;div&gt;</code> around the entire source code block.
This <code>&lt;div&gt;</code> will have a <code>&lt;pre&gt;</code> tag with the source code contents, along with a
preceding <code>&lt;label&gt;</code> if there was a <code>#+caption: ...</code> for this block. Because of
automatic generation of <code>#+caption: ...</code> bits for all Noweb-style references in
Section <a href="#h-Automatic-captions-for-Noweb-source-code-blocks">3.4.4.2</a>, the vast majority of
source code blocks will have this <code>&lt;label&gt;</code> tag.
</p>

<p>
By default the <code>&lt;label&gt;</code> tag includes a Listing number ("Listing 1: &#x2026;",
"Listing 17: &#x2026;", etc), because Org likes to numerically number every single
source code block. We simply drop these listing numbers and instead link back to
the parent block(s) that refer to this source code block (as a Noweb reference),
if any.
</p>

<p>
For polyblock chains, we also have to keep track of how long each chain is. This
way, each block in the chain will get a unique fraction denoting the position of
that block in the overall chain. (If we don't do this, then all of the captions
for all polyblocks in the same chain will look identical, which can be a bit
confusing). In order to generate these fractions we have to keep around a couple
hash tables for bookkeeping.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#__NREF__lilac_dot_el-lilac-publish-helpers-2">lilac-prettify-source-code-captions</a></span>(1/3) <span class="lilac-caption-link-symbol"><a href="#__NREF__lilac-prettify-source-code-captions-1">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__lilac-prettify-source-code-captions-1">(<span class="org-keyword">setq</span> lilac-polyblock-names (make-hash-table <span class="org-builtin">:test</span> 'equal))
(<span class="org-keyword">setq</span> lilac-polyblock-names-totals (make-hash-table <span class="org-builtin">:test</span> 'equal))
</pre></div></div><p>
First here is the overall shape of the function. If there is no caption
(<code>&lt;label&gt;</code> tag in the HTML), then we return the original HTML unmodified.
Otherwise we prettify this label (removing the "Listing N: &#x2026;" text, including
a link back to the parent, etc) along with the body text (linkifying references
to child Noweb references), and return both inside a new
<code>lilac-pre-with-caption</code> div.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#__NREF__lilac_dot_el-lilac-publish-helpers-2">lilac-prettify-source-code-captions</a></span>(2/3) <span class="lilac-caption-link-symbol"><a href="#__NREF__lilac-prettify-source-code-captions-2">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__lilac-prettify-source-code-captions-2">(<span class="org-keyword">defun</span> <span class="org-function-name">lilac-prettify-source-code-captions</span> (src-block-html backend info)
  (<span class="org-keyword">when</span> (org-export-derived-backend-p backend 'html)
    (<span class="org-keyword">let*</span> (
           <span class="lilac-child-link-from-parent"><a href="#__NREF__lilac-prettify-source-code-captions-let-bindings-1">lilac-prettify-source-code-captions-let-bindings</a></span>)
      (<span class="org-keyword">if</span> (s-blank? caption)
          src-block-html
        (concat
          leading-div
            <span class="org-string">"&lt;div class=\"lilac-pre-with-caption\"&gt;"</span>
              caption-text
              body-with-replaced-pre
            <span class="org-string">"&lt;/div&gt;"</span>
          <span class="org-string">"&lt;/div&gt;"</span>)))))
</pre></div></div><p>
Now let's get into the bindings. The first order of business is parsing the HTML
bits into separate parts.
</p>

<p>
<code>div-caption-body</code> is the original HTML but all on a single line. We need to
work with the text without newlines because Emacs Lisp's regular expressions
don't work well with newlines. That's why we call
<code>lilac-get-source-block-html-parts-without-newlines</code>.
</p>

<p>
We need <code>leading-div</code> because this outermost <code>div</code> contains various class and
other information that Org generates. We don't want to lose any of that info.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#__NREF__lilac-prettify-source-code-captions-2">lilac-prettify-source-code-captions-let-bindings</a></span>(1/9) <span class="lilac-caption-link-symbol"><a href="#__NREF__lilac-prettify-source-code-captions-let-bindings-1">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__lilac-prettify-source-code-captions-let-bindings-1">(div-caption-body (lilac-get-source-block-html-parts-without-newlines
                   src-block-html))
(leading-div (nth 0 div-caption-body))
(caption (nth 1 div-caption-body))
(body (nth 2 div-caption-body))
(body-with-newlines
 (lilac-to-multi-line body))
</pre></div></div><p>
<code>lilac-get-source-block-html-parts-without-newlines</code> is defined below. It's just
a list of parsed pieces of HTML.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#__NREF__lilac_dot_el-lilac-publish-helpers-2">lilac-prettify-source-code-captions</a></span>(3/3) <span class="lilac-caption-link-symbol"><a href="#__NREF__lilac-prettify-source-code-captions-3">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__lilac-prettify-source-code-captions-3">(<span class="org-keyword">defun</span> <span class="org-function-name">lilac-get-source-block-html-parts-without-newlines</span> (src-block-html)
    (<span class="org-keyword">let*</span> ((one-line (lilac-to-single-line src-block-html))
           (leading-div
             (<span class="org-keyword">let</span> ((div-match
                    (string-match <span class="org-string">"&lt;div [</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">&gt;]+&gt;"</span> one-line)))
               (match-string-no-properties 0 one-line)))
           (caption
             (<span class="org-keyword">let*</span> ((caption-match
                      (string-match <span class="org-string">"&lt;label [</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">&gt;]+&gt;.*?&lt;/label&gt;"</span> one-line)))
               (<span class="org-keyword">if</span> caption-match
                   (match-string-no-properties 0 one-line)
                   <span class="org-string">""</span>)))
           (body (<span class="org-keyword">progn</span> (string-match <span class="org-string">"&lt;pre [</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">&gt;]+&gt;.*?&lt;/pre&gt;"</span> one-line)
                        (match-string-no-properties 0 one-line))))
      `(,leading-div ,caption ,body)))
</pre></div></div><p>
Now come the bits for identifying the human-readable source code block name by
looking at the caption (<code>&lt;label&gt;</code>). We extract it from the <code>&lt;code&gt;</code> tags that we
expect to see inside the <code>&lt;label&gt;</code> tag.
</p>

<p>
It may very well be the case that the block will not have a name, in which
case we just name it as <code>anonymous</code>. A source code block is anonymous if:
</p>

<ol class="org-ol">
<li>it does not have a <code>"#+name: ..."</code> line, or</li>
<li>it does not have a <code>"#+header: :noweb-ref ..."</code> line.</li>
</ol>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#__NREF__lilac-prettify-source-code-captions-2">lilac-prettify-source-code-captions-let-bindings</a></span>(2/9) <span class="lilac-caption-link-symbol"><a href="#__NREF__lilac-prettify-source-code-captions-let-bindings-2">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__lilac-prettify-source-code-captions-let-bindings-2">(caption-parts
  (<span class="org-keyword">let*</span> ((caption-match
           (string-match <span class="org-string">"&lt;label [</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">&gt;]+&gt;</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">&lt;/label&gt;"</span> caption)))
    (<span class="org-keyword">if</span> caption-match
        (match-string-no-properties 1 caption)
        <span class="org-string">""</span>)))
(source-block-name-match
  (string-match
    (rx-to-string
      '(and
            <span class="org-string">"&lt;code&gt;"</span>
            (group (+ (not <span class="org-string">"&lt;"</span>)))
            <span class="org-string">"&lt;/code&gt;"</span>))
    caption-parts))
</pre></div></div><p>
Because the name <code>anonymous</code> is meaningless (there can be more than one such
block), we need to disambiguate it. We do this by appending a numeric suffix to
all source code blocks with the same human-readable <code>source-block-name</code>.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#__NREF__lilac-prettify-source-code-captions-2">lilac-prettify-source-code-captions-let-bindings</a></span>(3/9) <span class="lilac-caption-link-symbol"><a href="#__NREF__lilac-prettify-source-code-captions-let-bindings-3">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__lilac-prettify-source-code-captions-let-bindings-3">(source-block-name
  (<span class="org-keyword">if</span> source-block-name-match
      (match-string-no-properties 1 caption-parts)
      <span class="org-string">"anonymous"</span>))
(source-block-counter
 (gethash source-block-name lilac-polyblock-names 0))
(source-block-counter-incremented
 (puthash source-block-name (1+ source-block-counter)
          lilac-polyblock-names))
</pre></div></div><p>
Here we do some additional introspection into the <code>&lt;pre&gt;</code> tag which holds the
body text (the actual source code in the source code block). The <code>pre-id</code> is
important because it gives us a unique ID (linkable ID) to the body text. We'll
be using this when linking to a child block from a parent block.
</p>

<p>
Sadly, Org does not give every source code block an <code>id=...</code> field. Notably,
polyblocks do not get an <code>id</code> except for the very first block in the chain. And
so we inject an <code>id</code> for every <code>&lt;pre&gt;</code> tag ourselves. But first we have to see
if the <code>&lt;pre&gt;</code> tag has an ID already with <code>pre-id-match</code>.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#__NREF__lilac-prettify-source-code-captions-2">lilac-prettify-source-code-captions-let-bindings</a></span>(4/9) <span class="lilac-caption-link-symbol"><a href="#__NREF__lilac-prettify-source-code-captions-let-bindings-4">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__lilac-prettify-source-code-captions-let-bindings-4">(pre-id-match
  (string-match
    (rx-to-string
      '(and
            <span class="org-string">"&lt;pre "</span>
            (* (not <span class="org-string">"&gt;"</span>))
            <span class="org-string">"id=\""</span>
            (group (+ (not <span class="org-string">"\""</span>)))))
    body))
</pre></div></div><p>
Now we can create a universal <code>pre-id</code> for all <code>&lt;pre&gt;</code> tags, and make sure that
all <code>&lt;pre&gt;</code> tags without a given <code>id</code> can use <code>pre-id-universal</code> as a fallback.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#__NREF__lilac-prettify-source-code-captions-2">lilac-prettify-source-code-captions-let-bindings</a></span>(5/9) <span class="lilac-caption-link-symbol"><a href="#__NREF__lilac-prettify-source-code-captions-let-bindings-5">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__lilac-prettify-source-code-captions-let-bindings-5">(pre-id-universal
  (<span class="org-keyword">if</span> pre-id-match
      (match-string-no-properties 1 body)
    (format <span class="org-string">"%s-%s"</span>
            source-block-name
            source-block-counter-incremented)))
(pre-tag-match
  (string-match
    (rx-to-string
      '(and
            <span class="org-string">"&lt;pre "</span>
            (group (* (not <span class="org-string">"&gt;"</span>)))
            <span class="org-string">"&gt;"</span>))
    body))
(pre-tag-entire (match-string-no-properties 0 body))
(pre-tag-contents (match-string-no-properties 1 body))
(body-with-replaced-pre
  (<span class="org-keyword">if</span> pre-id-match
      body-with-newlines
      (string-replace pre-tag-entire
                      (concat <span class="org-string">"&lt;pre "</span> pre-tag-contents
                              (format <span class="org-string">" id=\"%s\""</span> pre-id-universal) <span class="org-string">"&gt;"</span>)
                      body-with-newlines)))
</pre></div></div><p>
For polyblocks though, we also want to show a fraction in the form <code>(N/TOTAL)</code>
where <code>N</code> is the numeric position of the polyblock (1 for the head, 2 for the
second one in the chain, 3 for the third, and so on), and <code>TOTAL</code> is the total
number of polyblocks in the chain. This way the reader can get some idea about
how many pieces there are as the overall chain is explained in the prose. This
<code>(N/TOTAL)</code> fraction is called a <code>polyblock-indicator</code>.
</p>

<p>
Note that we use the <code>(polyblock)</code> marker text from <a href="#coderef-NSCB_POLYBLOCK_INDICATOR" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-NSCB_POLYBLOCK_INDICATOR');" onmouseout="CodeHighlightOff(this, 'coderef-NSCB_POLYBLOCK_INDICATOR');"><code>NSCB_POLYBLOCK_INDICATOR</code></a>
to detect whether we're dealing with a polyblock, because otherwise all of those
anonymous blocks will get treated as part of a single polyblock chain.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#__NREF__lilac-prettify-source-code-captions-2">lilac-prettify-source-code-captions-let-bindings</a></span>(6/9) <span class="lilac-caption-link-symbol"><a href="#__NREF__lilac-prettify-source-code-captions-let-bindings-6">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__lilac-prettify-source-code-captions-let-bindings-6">(polyblock-chain-total
 (gethash source-block-name lilac-polyblock-names-totals 0))
(polyblock-indicator
 (<span class="org-keyword">if</span> (<span class="org-keyword">and</span>
      (&gt; polyblock-chain-total 0)
      (string-match <span class="org-string">"</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">(polyblock</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">)"</span> caption-parts))
     (format <span class="org-string">"(%s/%s) "</span>
             source-block-counter-incremented
             polyblock-chain-total)
   <span class="org-string">""</span>))
</pre></div></div><p>
Most source code blocks have a parent where this code block's contents should be
inserted into. There could be more than one parent if the code is reused
verbatim in multiple places.
</p>

<p>
We generate a link back to the parent (or parents), by extracting the links
(<code>href</code> bits in the <code>&lt;a&gt;</code> (aka anchor) tags) found in the caption. These links
were generated for us in Section <a href="#h-Automatic-captions-for-Noweb-source-code-blocks">3.4.4.2</a>; our job is to prettify them with CSS classes and such.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#__NREF__lilac-prettify-source-code-captions-2">lilac-prettify-source-code-captions-let-bindings</a></span>(7/9) <span class="lilac-caption-link-symbol"><a href="#__NREF__lilac-prettify-source-code-captions-let-bindings-7">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__lilac-prettify-source-code-captions-let-bindings-7">(parent-id-regexp
    (rx-to-string
      '(and
            <span class="org-string">" &lt;a href=\""</span>
            (group (+ (not <span class="org-string">"\""</span>))))))
(parent-ids-with-idx
 (lilac-enumerate
  (lilac-matches parent-id-regexp caption-parts 1) 1))
(parent-links
  (mapconcat (<span class="org-keyword">lambda</span> (parent-id-with-idx)
               (<span class="org-keyword">let</span> ((parent-id (car (cdr parent-id-with-idx)))
                     (idx (car parent-id-with-idx)))
                  (format (concat
                           <span class="org-string">"&lt;span class="</span>
                           <span class="org-string">"\"lilac-caption-parent-link\"&gt;"</span>
                           <span class="org-string">"&lt;a href=\"%s\"&gt;%s&lt;/a&gt;&lt;/span&gt;"</span>)
                    parent-id
                    (<span class="org-keyword">if</span> (= idx 1)
                        (string-remove-prefix
                         <span class="org-string">"__NREF__"</span> source-block-name)
                      idx))))
             parent-ids-with-idx <span class="org-string">""</span>))
</pre></div></div><p>
Every source code block gets a self-link back to itself (shown as a link icon
""). This goes at the very end of the caption on the far right (top right
corner of the source code block's rectangular area).
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#__NREF__lilac-prettify-source-code-captions-2">lilac-prettify-source-code-captions-let-bindings</a></span>(8/9) <span class="lilac-caption-link-symbol"><a href="#__NREF__lilac-prettify-source-code-captions-let-bindings-8">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__lilac-prettify-source-code-captions-let-bindings-8">(link-symbol
  (format (concat <span class="org-string">"&lt;span class=\"lilac-caption-link-symbol\"&gt;"</span>
                  <span class="org-string">"&lt;a href=\"#%s\"&gt;&amp;#x1f517;&lt;/a&gt;&lt;/span&gt;"</span>)
    pre-id-universal))
</pre></div></div><p>
Finally, we're ready to recompose the overall source code block. We make a
distinction for source code blocks that have links back to a parent (or multiple
parents). In all cases we make sure to remove Org's default "Listing N:" prefix.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#__NREF__lilac-prettify-source-code-captions-2">lilac-prettify-source-code-captions-let-bindings</a></span>(9/9) <span class="lilac-caption-link-symbol"><a href="#__NREF__lilac-prettify-source-code-captions-let-bindings-9">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__lilac-prettify-source-code-captions-let-bindings-9">(caption-without-listing-prefix
 (replace-regexp-in-string <span class="org-string">"&lt;span.+?span&gt;"</span> <span class="org-string">""</span> caption))
(caption-text
 (<span class="org-keyword">if</span> (&gt; (length parent-links) 0)
     (concat
       <span class="org-string">"&lt;div class=\"lilac-caption\"&gt;"</span>
         parent-links
         polyblock-indicator
         link-symbol
       <span class="org-string">"&lt;/div&gt;"</span>)
     (concat
       <span class="org-string">"&lt;div class=\"lilac-caption\"&gt;"</span>
         caption-without-listing-prefix
         link-symbol
       <span class="org-string">"&lt;/div&gt;"</span>)))
</pre></div></div>
</div>
</div>

<div id="outline-container-h-Link-noweb-references--link-to-child-block-from-parent-block" class="outline-5">
<h5 id="h-Link-noweb-references--link-to-child-block-from-parent-block"><span class="section-number-5">3.4.5.3.</span> Link noweb references (link to child block from parent block)</h5>
<div class="outline-text-5" id="text-h-Link-noweb-references--link-to-child-block-from-parent-block">
<p>
In <a href="#h-Pretty-source-code-captions">3.4.5.2</a> we tweaked the HTML so that source code blocks
could link back up to their parents. In this section we are concerned with the
opposite &#x2014; linking to child blocks from the parents. For example, consider the
following code:
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><label class="org-src-name">Sample Org-mode Noweb-style references</label><span class="lilac-caption-link-symbol"><a href="#Sample-Org-mode-Noweb-style-references-3">&#x1f517;</a></span></div><pre class="src src-org" id="Sample-Org-mode-Noweb-style-references-3"><span class="org-org-meta-line">#+name: parent-block</span>
<span class="org-org-block-begin-line">#+begin_src bash</span>
<span class="org-org-block"><span class="org-builtin">echo</span></span><span class="org-org-block"> </span><span class="org-org-block"><span class="org-string">"Hello from the parent block"</span></span>
<span class="org-org-block">__NREF__child-block-1</span>
<span class="org-org-block">__NREF__child-block-2</span>
<span class="org-org-block-end-line">#+end_src</span>

...

<span class="org-org-meta-line">#+name: __NREF__child-block-1</span>
<span class="org-org-block-begin-line">#+begin_src bash</span>
<span class="org-org-block"><span class="org-builtin">echo</span></span><span class="org-org-block"> </span><span class="org-org-block"><span class="org-string">"I am child 1"</span></span>
<span class="org-org-block-end-line">#+end_src</span>

...

<span class="org-org-meta-line">#+header: :noweb-ref __NREF__child-block-2</span>
<span class="org-org-block-begin-line">#+begin_src bash</span>
<span class="org-org-block"><span class="org-builtin">echo</span></span><span class="org-org-block"> -n </span><span class="org-org-block"><span class="org-string">"I am "</span></span>
<span class="org-org-block-end-line">#+end_src</span>

<span class="org-org-meta-line">#+header: :noweb-ref __NREF__child-block-2</span>
<span class="org-org-block-begin-line">#+begin_src bash</span>
<span class="org-org-block"><span class="org-builtin">echo</span></span><span class="org-org-block"> </span><span class="org-org-block"><span class="org-string">"child 2"</span></span>
<span class="org-org-block-end-line">#+end_src</span>
</pre></div></div><p>
What we want to do is to make the <code>__NREF__child-block-1</code> and
<code>__NREF__child-block-2</code> references inside <code>parent-block</code> to link to their
definitions, so that the reader can just click on them to go to see how they're
defined. Unfortunately Org mode doesn't do this by default so we have to do this
ourselves.
</p>

<p>
In the case of <code>__NREF__child-block-2</code>, it is defined in multiple blocks so we
would want to link to the very first block.
</p>

<p>
We cannot use a <code>org-export-before-parsing-hook</code> like we did in <a href="#h-Toplevel-publishing-function---lilac-publish-">3.4.3</a> because at that stage of processing, we
are dealing with Org mode syntax. Any modifications we make to the parent
source code block will be treated as text upon HTML export. Thankfully Org mode
allows customizations on generated HTML through the
<code>org-export-filter-src-block-functions</code> variable. This variable is analogous to
<code>org-export-before-parsing-hook</code>, but operates at the HTML level (not at the
Org syntax level) for source code blocks, which is exactly what we need.
</p>

<p>
So we have to craft valid HTML links (not Org links) to the child source code
blocks. For this we need the actual <code>id</code> part of the HTML <code>&lt;pre&gt;...</code> block that
will hold the source code. That is, the algorithm should be something like:
</p>

<ol class="org-ol">
<li>for every parent source code block,</li>
<li>for every child block (noweb) referenced in the body, insert an HTML link to
the child block (lookup in <code>lilac-child-HTML_ID-hash-table</code>).</li>
</ol>

<p>
The only thing remaining is the construction of
<code>lilac-child-HTML_ID-hash-table</code>. We can construct this by mapping through all
source code blocks and getting the name which can be just drawn from the <code>&lt;label
...&gt;</code> HTML tag, thanks to the smart captions we inserted for all child blocks
earlier in <a href="#h-Automatic-captions-for-Noweb-source-code-blocks">3.4.4.2</a>. This hash table
will hold mappings from child source block names to ther HTML ID's.
</p>

<p>
Now that we have a high-level understanding, let's walk through the
implementation. First here's the code to populate the
<code>lilac-child-HTML_ID-hash-table</code>.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#__NREF__lilac_dot_el-lilac-publish-helpers-2">lilac-link-to-child-blocks-from-parent</a></span>(1/4) <span class="lilac-caption-link-symbol"><a href="#__NREF__lilac-link-to-child-blocks-from-parent-1">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__lilac-link-to-child-blocks-from-parent-1">(<span class="org-keyword">setq</span> lilac-child-HTML_ID-hash-table (make-hash-table <span class="org-builtin">:test</span> 'equal))

(<span class="org-keyword">defun</span> <span class="org-function-name">lilac-populate-child-HTML_ID-hash-table</span> (src-block-html backend info)
  (<span class="org-keyword">when</span> (org-export-derived-backend-p backend 'html)
    (<span class="org-keyword">let*</span> ((child-name (lilac-get-src-block-name-from-html src-block-html))
           (child-HTML_ID (lilac-get-src-block-HTML_ID src-block-html))
           (child-HTML_ID-exists-already
            (gethash child-name lilac-child-HTML_ID-hash-table nil)))
      <span class="org-comment-delimiter">; </span><span class="org-comment">Only process child blocks that have an HTML ID.</span>
      (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> child-HTML_ID (not child-HTML_ID-exists-already))
          (puthash child-name child-HTML_ID lilac-child-HTML_ID-hash-table))
      <span class="org-comment-delimiter">; </span><span class="org-comment">Return src-block-html as-is (no modifications).</span>
      src-block-html)))

<span id="coderef-lilac-get-src-block-HTML_ID" class="coderef-off"></span>
(<span class="org-keyword">defun</span> <span class="org-function-name">lilac-get-src-block-HTML_ID</span> (src-block-html)
  (<span class="org-keyword">let</span> ((match (string-match <span class="org-string">"&lt;pre [</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">&gt;]+?id=\"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">\"]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">\"&gt;"</span> src-block-html)))
    (<span class="org-keyword">if</span> match (match-string-no-properties 1 src-block-html))))
</pre></div></div><p>
We need to get the source block name (the name of the child) from the HTML. We
do this in <code>lilac-get-src-block-name-from-html</code> below. Either there is a
<code>__NREF__...</code> text in the <code>&lt;code&gt;</code> tag within a <code>&lt;label&gt;</code> tag (from <a href="#h-Automatic-captions-for-Noweb-source-code-blocks">3.4.4.2</a>), or there is just a plain  <code>&lt;label&gt;</code> as
a result of a manually-written <code>#+caption: ...</code> bit. We use either one. Note
that the latter category assumes that the user used unique caption labels for
all blocks; if the user manually creates non-unique captions, this will probably
break. (FIXME: add test to confirm breakage&#x2026;?)
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#__NREF__lilac_dot_el-lilac-publish-helpers-2">lilac-link-to-child-blocks-from-parent</a></span>(2/4) <span class="lilac-caption-link-symbol"><a href="#__NREF__lilac-link-to-child-blocks-from-parent-2">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__lilac-link-to-child-blocks-from-parent-2">(<span class="org-keyword">defun</span> <span class="org-function-name">lilac-get-src-block-name-from-html</span> (src-block-html)
  (<span class="org-keyword">let*</span> ((match-nref (string-match
                      (concat
                       <span class="org-string">"&lt;label.+?&lt;code&gt;"</span>
                       (lilac-nref-rx nil)
                       <span class="org-string">"&lt;/code&gt;"</span>)
                      src-block-html))
         (match-raw (<span class="org-keyword">if</span> (not match-nref)
                        (string-match
                         (rx-to-string
                          '(and
                            <span class="org-string">"&lt;label"</span>
                            (+ (not <span class="org-string">"&gt;"</span>))
                            <span class="org-string">"&gt;"</span>
                            (group (*? anychar))
                            <span class="org-string">"&lt;/label&gt;"</span>))
                         src-block-html)))
         (matched-contents (match-string-no-properties 1 src-block-html)))
    (<span class="org-keyword">if</span> match-nref
        matched-contents
        (<span class="org-keyword">if</span> match-raw
            (lilac-clean-up-match-raw matched-contents)))))
</pre></div></div><p>
If the user used manual captions, we have to remove the "Listing N: &#x2026;" text
that Org automatically inserts.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#__NREF__lilac_dot_el-lilac-publish-helpers-2">lilac-link-to-child-blocks-from-parent</a></span>(3/4) <span class="lilac-caption-link-symbol"><a href="#__NREF__lilac-link-to-child-blocks-from-parent-3">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__lilac-link-to-child-blocks-from-parent-3">(<span class="org-keyword">defun</span> <span class="org-function-name">lilac-clean-up-match-raw</span> (s)
  (<span class="org-keyword">let*</span> ((normalized (lilac-normalize-string s))
         (rx (rx-to-string
                '(and
                  <span class="org-string">"Listing-"</span>
                  (+ (any digit))
                  (+ <span class="org-string">"-"</span>)
                  <span class="org-string">"span"</span>
                  (* <span class="org-string">"-"</span>)
                  (group (+ anychar)))))
         (match (string-match rx normalized)))
    (<span class="org-keyword">if</span> match
        (match-string-no-properties 1 normalized)
        normalized)))
</pre></div></div><p>
Now we have everything we need to add HTML links into the body of the source
code block directly. We search for the child name (which begins with a
<code>__NREF__...</code>, which is defined in <code>lilac-nref-rx</code>), and perform a string
replacement, adding in the link to the child block.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#__NREF__lilac_dot_el-lilac-publish-helpers-2">lilac-link-to-child-blocks-from-parent</a></span>(4/4) <span class="lilac-caption-link-symbol"><a href="#__NREF__lilac-link-to-child-blocks-from-parent-4">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__lilac-link-to-child-blocks-from-parent-4">(<span class="org-keyword">defun</span> <span class="org-function-name">lilac-link-to-children-from-parent-body</span> (src-block-html backend info)
  (<span class="org-keyword">when</span> (org-export-derived-backend-p backend 'html)
    (<span class="org-keyword">let*</span> ((div-caption-body (lilac-get-source-block-html-parts-without-newlines
                              src-block-html))
           (leading-div (nth 0 div-caption-body))
           (caption (nth 1 div-caption-body))
           (body (nth 2 div-caption-body))
           (body-linkified-without-newlines
            (replace-regexp-in-string
             (lilac-nref-rx nil)
             (<span class="org-keyword">lambda</span> (child-name-text)
                 (<span class="org-keyword">let*</span> ((HTML_ID (gethash child-name-text
                                          lilac-child-HTML_ID-hash-table)))
                  (<span class="org-keyword">if</span> HTML_ID
                      (concat <span class="org-string">"&lt;span class=\"lilac-child-link-from-parent\"&gt;"</span>
                              <span class="org-string">"&lt;a href=\"#"</span> HTML_ID <span class="org-string">"\"&gt;"</span>
                              (string-remove-prefix <span class="org-string">"__NREF__"</span> child-name-text)
                              <span class="org-string">"&lt;/a&gt;&lt;/span&gt;"</span>)
                      child-name-text)))
             body))
           (body-linkified-with-newlines
            (lilac-to-multi-line body-linkified-without-newlines)))
      (concat leading-div caption body-linkified-with-newlines <span class="org-string">"&lt;/div&gt;"</span>))))
</pre></div></div>
</div>
</div>

<div id="outline-container-h-Search-and-replace-hardcoded-things" class="outline-5">
<h5 id="h-Search-and-replace-hardcoded-things"><span class="section-number-5">3.4.5.4.</span> Search and replace hardcoded things</h5>
<div class="outline-text-5" id="text-h-Search-and-replace-hardcoded-things">
<p>
Org's HTML export hardcodes some things. We have to do some manual surgery to
set things right. First let's define a generic search-and-replace function. This
function is based on <a href="https://emacs.stackexchange.com/a/2382/13006">this example</a>.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-el">lilac_dot_el-search-replace</a></span>(1/2) <span class="lilac-caption-link-symbol"><a href="#__NREF__lilac_dot_el-search-replace-1">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__lilac_dot_el-search-replace-1">(<span class="org-keyword">defun</span> <span class="org-function-name">lilac-replace-from-to</span> (str repl)
  (<span class="org-keyword">interactive</span> <span class="org-string">"sString: \nsReplacement: "</span>)
  (<span class="org-keyword">save-excursion</span>
    (goto-char (point-min))
    (replace-string str repl)))
</pre></div></div><p>
Here's a basic wrapper to perform the string replacement for an HTML file based
on the current buffer name.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-el">lilac_dot_el-search-replace</a></span>(2/2) <span class="lilac-caption-link-symbol"><a href="#__NREF__lilac_dot_el-search-replace-2">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__lilac_dot_el-search-replace-2">(<span class="org-keyword">defun</span> <span class="org-function-name">lilac-replace-from-to-html</span> (str repl <span class="org-type">&amp;optional</span> regex)
  (<span class="org-keyword">let</span> ((html-file-name (concat
                         (file-name-sans-extension (buffer-file-name))
                         <span class="org-string">".html"</span>)))
    (find-file html-file-name)
    (goto-char 0)
    (<span class="org-keyword">if</span> regex
        (replace-regexp str repl)
        (lilac-replace-from-to str repl))
    (save-buffer)))
</pre></div></div><p>
Now we do some basic search-and-replace commands to clean up the exported HTML
file from Emacs (instead of invoking <code>sed</code>).
</p>
</div>

<div id="outline-container-h-Bibliography--citations" class="outline-6">
<h6 id="h-Bibliography--citations"><span class="section-number-6">3.4.5.4.1.</span> Bibliography (citations)</h6>
<div class="outline-text-6" id="text-h-Bibliography--citations">
<p>
This cleans up the inline styles for citations.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#__NREF__lilac_dot_el-lilac-publish-6">lilac-publish-fix-inline-styles</a></span><span class="lilac-caption-link-symbol"><a href="#__NREF__lilac-publish-fix-inline-styles">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__lilac-publish-fix-inline-styles">(lilac-replace-from-to-html
 <span class="org-string">".csl-right-inline{margin: 0 0 0 2em;"</span>
 <span class="org-string">".csl-right-inline{margin: 0 0 0 2em;"</span>)
</pre></div></div><p>
We also do some replacements for the bibliography entries themselves. Namely,
each entry has the following (odd) structure by default:
</p>

<pre class="example" id="org00000be">
&lt;div class="csl-entry"&gt;&lt;a id="citeproc_bib_item_1"&gt;&lt;/a&gt; ... &lt;/div&gt;
</pre>

<p>
and instead we delete the content-less link anchor and instead move th ID to the
parent div, like this:
</p>

<pre class="example" id="org00000bf">
&lt;div class="csl-entry" id="citeproc_bib_item_1"&gt; ... &lt;/div&gt;
</pre>

<p>
This way we can target this surrounding parent div for the <code>active</code> HTML class
attribute (instead of the empty link anchor) to style the entire entry when we
click a link to go to it.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#__NREF__lilac_dot_el-lilac-publish-6">lilac-publish-fix-bibliography-ids</a></span><span class="lilac-caption-link-symbol"><a href="#__NREF__lilac-publish-fix-bibliography-ids">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__lilac-publish-fix-bibliography-ids">(lilac-replace-from-to-html
 <span class="org-string">"\"csl-entry\"&gt;&lt;a </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">id=\"[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">\"]+\"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">&gt;&lt;/a&gt;"</span>
 <span class="org-string">"\"csl-entry\" \\1&gt;"</span>
 t)
</pre></div></div><p>
And here we style these entries.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-css">css-bibliography</a></span><span class="lilac-caption-link-symbol"><a href="#__NREF__css-bibliography">&#x1f517;</a></span></div><pre class="src src-css" id="__NREF__css-bibliography"><span class="org-css-selector">.csl-entry </span>{
    <span class="org-css-property">padding</span>: 0.5em;
    <span class="org-css-property">border-style</span>: solid;
    <span class="org-css-property">border-width</span>: 1px;
    <span class="org-css-property">border-radius</span>: 5px;
    <span class="org-css-property">border-color</span>: var(<span class="org-variable-name">--clear</span>);
}

<span class="org-css-selector">.outline-2 .csl-bib-body .active </span>{
    <span class="lilac-child-link-from-parent"><a href="#__NREF__css-active-item-headline">css-active-item-headline</a></span>
}
</pre></div></div>
</div>
</div>

<div id="outline-container-h-Glossary--description-lists" class="outline-6">
<h6 id="h-Glossary--description-lists"><span class="section-number-6">3.4.5.4.2.</span> Glossary (description lists)</h6>
<div class="outline-text-6" id="text-h-Glossary--description-lists">
<p>
Similar to the bibliography entries, the description lists in HTML have empty
link anchors in them, because of the way we insert the link anchors manually in
the Org text (this is a convention we follow; see the <a href="#h-Glossary">4</a> for examples).
We get rid of these anchors and instead create a surrounding div around it, so
that we can highlight the enclosed <code>&lt;dt&gt;</code> (description term) and <code>&lt;dd&gt;</code>
(description details).
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#__NREF__lilac_dot_el-lilac-publish-6">lilac-publish-fix-description-lists</a></span><span class="lilac-caption-link-symbol"><a href="#__NREF__lilac-publish-fix-description-lists">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__lilac-publish-fix-description-lists">(lilac-replace-from-to-html
 <span class="org-string">"&lt;dt&gt;"</span>
 <span class="org-string">"&lt;div class=\"lilac-description-list-entry\"&gt;&lt;dt&gt;"</span>
 t)
(lilac-replace-from-to-html
 <span class="org-string">"\"lilac-description-list-entry\"&gt;&lt;dt&gt;&lt;a </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">id=\"[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">\"]+\"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">&gt;&lt;/a&gt;"</span>
 <span class="org-string">"\"lilac-description-list-entry\" \\1&gt;&lt;dt&gt;"</span>
 t)
(lilac-replace-from-to-html
 <span class="org-string">"&lt;/dd&gt;"</span>
 <span class="org-string">"&lt;/dd&gt;&lt;/div&gt;"</span>)
</pre></div></div><p>
And here we style it.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-css">css-description-lists</a></span><span class="lilac-caption-link-symbol"><a href="#__NREF__css-description-lists">&#x1f517;</a></span></div><pre class="src src-css" id="__NREF__css-description-lists"><span class="org-css-selector">.lilac-description-list-entry </span>{
    <span class="org-css-property">padding</span>: 0.2em 0.5em 0.5em 0.5em;
    <span class="org-css-property">border-style</span>: solid;
    <span class="org-css-property">border-width</span>: 1px;
    <span class="org-css-property">border-radius</span>: 5px;
    <span class="org-css-property">border-color</span>: var(<span class="org-variable-name">--clear</span>);
}

<span class="org-css-selector">.org-dl .active </span>{
    <span class="lilac-child-link-from-parent"><a href="#__NREF__css-active-item-headline">css-active-item-headline</a></span>
}
</pre></div></div>
</div>
</div>
</div>
</div>

<div id="outline-container-h-JavaScript" class="outline-4">
<h4 id="h-JavaScript"><span class="section-number-4">3.4.6.</span> JavaScript</h4>
<div class="outline-text-4" id="text-h-JavaScript">
<p>
We use JavaScript to make the HTML document more useful. The primary concern is
to make it easier to navigate around the various intra-document links.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><label class="org-src-name">lilac.js</label><span class="lilac-caption-link-symbol"><a href="#lilac-js">&#x1f517;</a></span></div><pre class="src src-js" id="lilac-js"><span class="lilac-child-link-from-parent"><a href="#__NREF__js-automatically-link-headlines">js-automatically-link-headlines</a></span>
<span class="lilac-child-link-from-parent"><a href="#__NREF__js-toc-scrollspy">js-toc-scrollspy</a></span>
<span class="lilac-child-link-from-parent"><a href="#__NREF__js-highlight-link-destination">js-highlight-link-destination</a></span>
<span class="lilac-child-link-from-parent"><a href="#__NREF__js-scroll-to-history-item">js-scroll-to-history-item</a></span>
</pre></div></div><p>
In the<a href="#h-Create--lilac-theme--file"><code>lilac.theme</code></a> file, we include <code>lilac.js</code> and also jQuery
because we depend on it.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-theme">lilac-theme-js</a></span><span class="lilac-caption-link-symbol"><a href="#__NREF__lilac-theme-js">&#x1f517;</a></span></div><pre class="src src-org" id="__NREF__lilac-theme-js"><span class="org-org-meta-line">#+HTML_HEAD: &lt;script src="<a href="https://code.jquery.com/jquery-3.6.4.min.js">https://code.jquery.com/jquery-3.6.4.min.js</a>"&gt;&lt;/script&gt;</span>
<span class="org-org-meta-line">#+HTML_HEAD: &lt;script src="lilac.js"&gt;&lt;/script&gt;</span>
</pre></div></div>
</div>

<div id="outline-container-h-Self-linked-headlines" class="outline-5">
<h5 id="h-Self-linked-headlines"><span class="section-number-5">3.4.6.1.</span> Self-linked headlines</h5>
<div class="outline-text-5" id="text-h-Self-linked-headlines">
<p>
Every HTML element <code>h2</code> to <code>h6</code> (which encode the Org mode headlines) already
come with a unique ID, but they are not linked to themselves. We add the
self-links here, which makes it easy for users to link to them directly when
they're reading the page.
</p>

<p>
The JavaScript below is taken from <a href="https://github.com/listx/listx_blog/blame/8e6e7b533d89f77a6939e5eda9fd9d990d25a7a9/misc.js#L1">here</a>.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-js">js-automatically-link-headlines</a></span><span class="lilac-caption-link-symbol"><a href="#__NREF__js-automatically-link-headlines">&#x1f517;</a></span></div><pre class="src src-js" id="__NREF__js-automatically-link-headlines">$(<span class="org-keyword">function</span>() {
    $(<span class="org-string">"h2,h3,h4,h5,h6"</span>).each(<span class="org-keyword">function</span>() {
        <span class="org-keyword">var</span> <span class="org-variable-name">$this</span> = $(<span class="org-constant">this</span>);
        <span class="org-keyword">var</span> <span class="org-variable-name">href</span> = $this.attr(<span class="org-string">"id"</span>);
        $this.wrapInner(
            $(<span class="org-string">"&lt;a/&gt;"</span>).attr(<span class="org-string">"href"</span>, <span class="org-string">"#"</span> + href)
                     .addClass(<span class="org-string">"section-heading"</span>));
    });
});
</pre></div></div><p>
Linkifying itself makes all the headlines blue (the default color for links).
This is a bit distracting, so make them black.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-css">css-source-code-section-headlines</a></span>(1/2) <span class="lilac-caption-link-symbol"><a href="#__NREF__css-source-code-section-headlines-1">&#x1f517;</a></span></div><pre class="src src-css" id="__NREF__css-source-code-section-headlines-1"><span class="org-css-selector">a.section-heading </span>{
    <span class="org-css-property">color</span>: <span class="custom">black</span>;
    <span class="org-css-property">text-decoration</span>: none;
    <span class="org-css-property">display</span>: block;
}
</pre></div></div><p>
Lastly, show a link anchor icon when the user hovers over a headline. We have
the icon present at all times; we only make it visible when we hover over the
heading. This way, there is no "jumping" of any kind when the heading is about
the same size as the width of the enclosing <code>div</code> (it can jump when displaying
the icon results in a new line break).
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-css">css-source-code-section-headlines</a></span>(2/2) <span class="lilac-caption-link-symbol"><a href="#__NREF__css-source-code-section-headlines-2">&#x1f517;</a></span></div><pre class="src src-css" id="__NREF__css-source-code-section-headlines-2"><span class="org-css-selector">a.section-heading::after </span>{
    <span class="org-css-property">opacity</span>: 0;
    <span class="org-css-property">transition</span>: opacity 150ms;
    <span class="org-css-property">content</span>: <span class="org-string">"\1f517"</span>;
    <span class="org-css-property">padding-left</span>: 1rem;
}
<span class="org-css-selector">a.section-heading:hover::after </span>{
    <span class="org-css-property">opacity</span>: 1;
    <span class="org-css-property">transition</span>: opacity 150ms;
    <span class="org-css-property">content</span>: <span class="org-string">"\1f517"</span>;
}
</pre></div></div>
</div>
</div>

<div id="outline-container-h-Table-of-contents-sidebar" class="outline-5">
<h5 id="h-Table-of-contents-sidebar"><span class="section-number-5">3.4.6.2.</span> Table of contents sidebar</h5>
<div class="outline-text-5" id="text-h-Table-of-contents-sidebar">
<p>
By default Org's HTML export gives us a "Table of Contents". We make several
modifications to it:
</p>

<ol class="org-ol">
<li>remove the "Table of Contents" phrase because it doesn't add much value,</li>
<li>convert it to a sidebar on the left, and</li>
<li>track the current headline.</li>
</ol>
</div>

<div id="outline-container-h-Delete--Table-of-Contents--text" class="outline-6">
<h6 id="h-Delete--Table-of-Contents--text"><span class="section-number-6">3.4.6.2.1.</span> Delete "Table of Contents" text</h6>
<div class="outline-text-6" id="text-h-Delete--Table-of-Contents--text">
<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#__NREF__lilac_dot_el-lilac-publish-6">lilac-publish-delete-toc-text</a></span><span class="lilac-caption-link-symbol"><a href="#__NREF__lilac-publish-delete-toc-text">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__lilac-publish-delete-toc-text">(lilac-replace-from-to-html
 <span class="org-string">"&lt;h2&gt;Table of Contents&lt;/h2&gt;"</span>
 <span class="org-string">""</span>)
</pre></div></div>
</div>
</div>

<div id="outline-container-h-Convert--Table-of-Contents--to-a-sidebar-on-the-left" class="outline-6">
<h6 id="h-Convert--Table-of-Contents--to-a-sidebar-on-the-left"><span class="section-number-6">3.4.6.2.2.</span> Convert "Table of Contents" to a sidebar on the left</h6>
<div class="outline-text-6" id="text-h-Convert--Table-of-Contents--to-a-sidebar-on-the-left">
<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-css">css-toc</a></span>(1/2) <span class="lilac-caption-link-symbol"><a href="#__NREF__css-toc-1">&#x1f517;</a></span></div><pre class="src src-css" id="__NREF__css-toc-1"><span class="org-css-selector">#table-of-contents </span>{
    <span class="org-css-property">position</span>: fixed;
    <span class="org-css-property">top</span>: 0;
    <span class="org-css-property">float</span>: left;
    <span class="org-css-property">margin-left</span>: -300px;
    <span class="org-css-property">width</span>: 280px;
    <span class="org-css-property">font-size</span>: 90%;
    <span class="org-css-property">border-right-style</span>: solid;
    <span class="org-css-property">border-right-width</span>: 1px;
    <span class="org-css-property">border-right-color</span>: var(<span class="org-variable-name">--border-light</span>);
}
<span class="org-css-selector">#text-table-of-contents </span>{
    <span class="org-css-property">overflow-y</span>: scroll;
    <span class="org-css-property">height</span>: 100vh;
    <span class="org-css-property">padding-right</span>: 20px;
    <span class="org-css-property">padding-left</span>: 5px;
}
<span class="org-css-selector">#text-table-of-contents li </span>{
    <span class="org-css-property">font-family</span>: <span class="org-string">"Source Sans Pro"</span>, sans;
}
<span class="org-css-selector">#text-table-of-contents ul li </span>{
    <span class="org-css-property">font-weight</span>: bold;
}
<span class="org-css-selector">#text-table-of-contents ul li ul li </span>{
    <span class="org-css-property">font-weight</span>: normal;
}
<span class="org-css-selector">#text-table-of-contents ul </span>{
    <span class="org-css-property">margin</span>: 0;
    <span class="org-css-property">padding</span>: 0;
}
<span class="org-css-selector">#text-table-of-contents &gt; ul &gt; li </span>{
    <span class="org-css-property">padding-top</span>: 1em;
}
<span class="org-css-selector">#text-table-of-contents &gt; ul &gt; li:last-child </span>{
    <span class="org-css-property">padding-bottom</span>: 1.5em;
}
</pre></div></div>
</div>
</div>

<div id="outline-container-h-Track-the-current-headline" class="outline-6">
<h6 id="h-Track-the-current-headline"><span class="section-number-6">3.4.6.2.3.</span> Track the current headline</h6>
<div class="outline-text-6" id="text-h-Track-the-current-headline">
<p>
We use some JavaScript to track the current headline when we scroll up or
down the page, forcing it to stay in sync with the content in the main body. We
initially used Bootstrap's "scrollspy" component, but dropped it because it was
too heavy and opinionated.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-js">js-toc-scrollspy</a></span><span class="lilac-caption-link-symbol"><a href="#__NREF__js-toc-scrollspy">&#x1f517;</a></span></div><pre class="src src-js" id="__NREF__js-toc-scrollspy"><span class="org-keyword">function</span> <span class="org-function-name">scrollIntoViewIfNeeded</span>(<span class="org-variable-name">target</span>) {
    <span class="org-keyword">if</span> ((target.getBoundingClientRect().bottom &gt; window.innerHeight)
        || (target.getBoundingClientRect().top &lt; 0)) {
        target.scrollIntoView({ behavior: <span class="org-string">"smooth"</span>,
                                block: <span class="org-string">"center"</span>,
                                inline: <span class="org-string">"center"</span> });
    }
}

<span class="org-keyword">function</span> <span class="org-function-name">deactivate_other_toc_items</span>(<span class="org-variable-name">hash</span>) {
    $(<span class="org-string">"#text-table-of-contents a"</span>).each((index, elt) =&gt; {
        <span class="org-keyword">if</span> (elt.hash !== hash) {
            $(elt).removeClass(<span class="org-string">"active"</span>);
        }
    })
}

<span class="org-keyword">function</span> <span class="org-function-name">get_toc_item</span>(<span class="org-variable-name">hash</span>) {
    <span class="org-keyword">return</span> $(<span class="org-string">`#text-table-of-contents a[href='${hash}']`</span>)[0];
}

$(document).ready(() =&gt; {
    $(<span class="org-string">"#text-table-of-contents a"</span>).click((elt) =&gt; {
        <span class="org-keyword">var</span> <span class="org-variable-name">tocItem</span> = get_toc_item(elt.target.hash);
        $(tocItem).addClass(<span class="org-string">"active"</span>);
        deactivate_other_toc_items(elt.target.hash);
    });

    $(<span class="org-string">"*[id^='outline-container-h-']"</span>).each((index, elt) =&gt; {
        <span class="org-keyword">var</span> <span class="org-variable-name">hash</span> = elt.getAttribute(<span class="org-string">"id"</span>)
        hash = hash.replace(<span class="org-string">"outline-container-"</span>, <span class="org-string">"#"</span>)
        <span class="org-keyword">var</span> <span class="org-variable-name">tocItem</span> = get_toc_item(hash);
        elt.addEventListener(<span class="org-string">"mouseover"</span>, () =&gt; {
            $(tocItem).addClass(<span class="org-string">"active"</span>);
            deactivate_other_toc_items(hash);
        });
        elt.addEventListener(<span class="org-string">"mouseover"</span>, (e) =&gt; {
            <span class="org-comment-delimiter">// </span><span class="org-comment">If we don't call stopPropagation(), we end up scrolling *all*</span>
            <span class="org-comment-delimiter">// </span><span class="org-comment">elements in the stack, which means we will try to scroll e.g.,</span>
            <span class="org-comment-delimiter">// </span><span class="org-comment">Section 5 and Section 5.1.2.3 (when we only want the latter).</span>
            e.stopPropagation();
            <span class="org-comment-delimiter">// </span><span class="org-comment">Unfortunately, scrollIntoViewIfNeeded is not supported on</span>
            <span class="org-comment-delimiter">// </span><span class="org-comment">Firefox. Otherwise we could do</span>
            <span class="org-comment-delimiter">//</span>
            <span class="org-comment-delimiter">//    </span><span class="org-comment">elems[0].scrollIntoViewIfNeeded({ block: "center" });</span>
            <span class="org-comment-delimiter">//</span>
            <span class="org-comment-delimiter">// </span><span class="org-comment">instead. So here we call the custom function that does what we</span>
            <span class="org-comment-delimiter">// </span><span class="org-comment">want.  See https://stackoverflow.com/a/37829643/437583.</span>
            scrollIntoViewIfNeeded(tocItem);
        });
    });
});
</pre></div></div><p>
We add some styling for the "active" headline. The main point is to add a green
background and border around it. For the border, we have to make the non-active
headlines have a white (invisible) border around it because otherwise the active
border makes the item jump a little bit when it's applied.
</p>

<p>
We have to colorize the foreground color of the link because otherwise it
becomes the color of all other links as per <a href="#h-Links">3.4.10.8</a>.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-css">css-toc</a></span>(2/2) <span class="lilac-caption-link-symbol"><a href="#__NREF__css-toc-2">&#x1f517;</a></span></div><pre class="src src-css" id="__NREF__css-toc-2"><span class="org-css-selector">#table-of-contents a </span>{
    <span class="org-css-property">display</span>: block;
    <span class="org-css-property">transition</span>: all 300ms ease-in-out;
    <span class="org-css-property">padding</span>: 5px;
    <span class="org-css-property">border-radius</span>: 4px;
    <span class="org-css-property">border-style</span>: solid;
    <span class="org-css-property">border-width</span>: 1px;
    <span class="org-css-property">border-color</span>: var(<span class="org-variable-name">--clear</span>);
    <span class="org-css-property">color</span>: var(<span class="org-variable-name">--fg-heading</span>);
}
<span class="org-css-selector">#table-of-contents .active </span>{
    <span class="org-css-property">color</span>: var(<span class="org-variable-name">--fg-heading</span>);
    <span class="lilac-child-link-from-parent"><a href="#__NREF__css-active-item">css-active-item</a></span>
}
<span class="org-css-selector">#table-of-contents a:hover </span>{
    <span class="org-css-property">text-decoration</span>: none;
}
</pre></div></div>
</div>
</div>
</div>

<div id="outline-container-h-Highlight-and-scroll-to-just-clicked-on-item" class="outline-5">
<h5 id="h-Highlight-and-scroll-to-just-clicked-on-item"><span class="section-number-5">3.4.6.3.</span> Highlight and scroll to just-clicked-on item</h5>
<div class="outline-text-5" id="text-h-Highlight-and-scroll-to-just-clicked-on-item">
<p>
When we click on any link (typically a code block but it can also be a headline
or some other intra-document link destination), the browser shifts the page
there.  But sometimes we are already near the link destination so the page
doesn't move.  Other times we get moved all the way to the top or the bottom of
the page, so by the time the browser finishes moving there, the user can be
confused as to know which destination the browser wanted to go to. This can be
somewhat disorienting.
</p>

<p>
The solution is to highlight the just-clicked-on link's destination element.
Every time we click on anything, we add a class to the destination element. Then
from CSS we can make this visually compelling. This way we give the user a
visual cue when clicking on links that navigate to a destination within the same
document.
</p>

<p>
We adapt the code in <a href="#h-Track-the-current-headline">3.4.6.2.3</a> to do what we need here. The
main difference is that while the code there is concerned with adding and
removing the <code>active</code> class from the <code>#text-table-of-contents</code> div, here we want
to do the same but for the <code>outline-2</code> div which contains the outline text
(There can be multiple <code>outline-2</code> divs, but this is immaterial.)
</p>

<p>
We also use the <code>scrollIntoViewIfNeeded</code> function to scroll the item into view,
but only if we need to. This way we minimize the need to scroll, resulting in a
much less "jumpy" experience.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-js">js-highlight-link-destination</a></span><span class="lilac-caption-link-symbol"><a href="#__NREF__js-highlight-link-destination">&#x1f517;</a></span></div><pre class="src src-js" id="__NREF__js-highlight-link-destination"><span class="org-keyword">function</span> <span class="org-function-name">deactivate_other_non_toc_items</span>(<span class="org-variable-name">hash</span>) {
    $(<span class="org-string">".outline-2 *"</span>).each((index, elt) =&gt; {
        <span class="org-keyword">if</span> (<span class="org-string">`#${elt.id}`</span> !== hash) {
            $(elt).removeClass(<span class="org-string">"active"</span>);
        }
    })
}

$(document).ready(() =&gt; {
    $(<span class="org-string">"a"</span>).click((elt) =&gt; {
        <span class="org-keyword">var</span> <span class="org-variable-name">destination</span>;
        <span class="org-keyword">if</span> (elt.target.nodeName === <span class="org-string">"CODE"</span>) {
            destination = elt.target.parentElement.hash;
        } <span class="org-keyword">else</span> {
            destination = elt.target.hash;
        }
        <span class="org-comment-delimiter">// </span><span class="org-comment">Only disable the browser's "jump to the link immediately" behavior if</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">we are dealing with an intra-document link. For links to other pages,</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">we want the default behavior. The destination is empty if the link</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">goes to another page.</span>
        <span class="org-keyword">if</span> (destination === <span class="org-string">""</span>) {
            <span class="org-keyword">return</span>;
        } <span class="org-keyword">else</span> {
            elt.preventDefault();
        }
        $(destination).addClass(<span class="org-string">"active"</span>);
        deactivate_other_non_toc_items(destination);
        scrollIntoViewIfNeeded($(destination)[0]);
        <span class="org-comment-delimiter">// </span><span class="org-comment">Save intra-document link into history, but only if it's not a repeat</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">of one already there.</span>
        <span class="org-keyword">var</span> <span class="org-variable-name">hash</span> = destination;
        <span class="org-keyword">if</span> (history.state === <span class="org-constant">null</span>) {
            <span class="org-keyword">return</span>;
        }
        <span class="org-keyword">if</span> (history.state.hash != hash) {
<span id="coderef-HISTORY_PUSHSTATE" class="coderef-off">            history.pushState(</span>
                {hash: destination},
                <span class="org-string">""</span>, destination);
        }
    });
});
</pre></div></div><p>
Now we just need to style the active element.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#__NREF__css-toc-2">css-active-item</a></span><span class="lilac-caption-parent-link"><a href="#__NREF__css-active-item-headline">2</a></span><span class="lilac-caption-parent-link"><a href="#__NREF__css-active-item-span">3</a></span><span class="lilac-caption-parent-link"><a href="#__NREF__css-active-non-toc-item">4</a></span><span class="lilac-caption-link-symbol"><a href="#__NREF__css-active-item">&#x1f517;</a></span></div><pre class="src src-css" id="__NREF__css-active-item"><span class="org-css-property">background-color</span>: var(<span class="org-variable-name">--bg-toc-item</span>);
<span class="org-css-property">border-color</span>: var(<span class="org-variable-name">--fg-toc-item</span>);
</pre></div></div><p>
For headlines, we draw a border around it.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#__NREF__css-bibliography">css-active-item-headline</a></span><span class="lilac-caption-parent-link"><a href="#__NREF__css-description-lists">2</a></span><span class="lilac-caption-parent-link"><a href="#__NREF__css-active-non-toc-item">3</a></span><span class="lilac-caption-link-symbol"><a href="#__NREF__css-active-item-headline">&#x1f517;</a></span></div><pre class="src src-css" id="__NREF__css-active-item-headline"><span class="org-css-property">border-style</span>: solid;
<span class="org-css-property">border-width</span>: 1px;
<span class="org-css-property">border-radius</span>: 5px;
<span class="lilac-child-link-from-parent"><a href="#__NREF__css-active-item">css-active-item</a></span>
</pre></div></div><p>
For span nodes, we also draw a border around it. Spans can be the destination
when we link to a line inside a source code block.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#__NREF__css-active-non-toc-item">css-active-item-span</a></span><span class="lilac-caption-link-symbol"><a href="#__NREF__css-active-item-span">&#x1f517;</a></span></div><pre class="src src-css" id="__NREF__css-active-item-span"><span class="org-css-property">display</span>: inline-block;
<span class="org-css-property">width</span>: 100%;
<span class="org-css-property">border-style</span>: solid;
<span class="org-css-property">border-width</span>: 1px;
<span class="org-css-property">border-radius</span>: 5px;
<span class="lilac-child-link-from-parent"><a href="#__NREF__css-active-item">css-active-item</a></span>
</pre></div></div><p>
Different destination elements need different selectors. We cover most of them
here.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-css">css-active-non-toc-item</a></span>(1/1) <span class="lilac-caption-link-symbol"><a href="#__NREF__css-active-non-toc-item">&#x1f517;</a></span></div><pre class="src src-css" id="__NREF__css-active-non-toc-item"><span class="org-css-selector">.outline-2 h2.active </span>{
    <span class="lilac-child-link-from-parent"><a href="#__NREF__css-active-item-headline">css-active-item-headline</a></span>
}
<span class="org-css-selector">.outline-2 h3.active </span>{
    <span class="lilac-child-link-from-parent"><a href="#__NREF__css-active-item-headline">css-active-item-headline</a></span>
}
<span class="org-css-selector">.outline-2 h4.active </span>{
    <span class="lilac-child-link-from-parent"><a href="#__NREF__css-active-item-headline">css-active-item-headline</a></span>
}
<span class="org-css-selector">.outline-2 h5.active </span>{
    <span class="lilac-child-link-from-parent"><a href="#__NREF__css-active-item-headline">css-active-item-headline</a></span>
}
<span class="org-css-selector">.outline-2 h6.active </span>{
    <span class="lilac-child-link-from-parent"><a href="#__NREF__css-active-item-headline">css-active-item-headline</a></span>
}
<span class="org-css-selector">.outline-2 pre.active </span>{
    <span class="lilac-child-link-from-parent"><a href="#__NREF__css-active-item">css-active-item</a></span>
}
<span class="org-css-selector">.outline-2 span.active </span>{
    <span class="lilac-child-link-from-parent"><a href="#__NREF__css-active-item-span">css-active-item-span</a></span>
}
</pre></div></div>
</div>
</div>

<div id="outline-container-h-Scroll-to-history-item" class="outline-5">
<h5 id="h-Scroll-to-history-item"><span class="section-number-5">3.4.6.4.</span> Scroll to history item</h5>
<div class="outline-text-5" id="text-h-Scroll-to-history-item">
<p>
Normally, browsers only treat links across URLs as new points in history; this
means that for links <i>within</i> the page, their history is not saved. We make sure
to save it explicitly with <code>history.pushState()</code> though in <a href="#coderef-HISTORY_PUSHSTATE" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-HISTORY_PUSHSTATE');" onmouseout="CodeHighlightOff(this, 'coderef-HISTORY_PUSHSTATE');"><code>HISTORY_PUSHSTATE</code></a>.
So then every time we want to go back in history (by pressing the "back" arrow
button in the browser), we just need to scroll to it.  We already scroll to the
element we click on when we push on a new history item into the stack, so
there's no need to keep it symmetric here.
</p>

<p>
We have to activate the restored history item (to re-highlight it with the
<code>active</code> class), so we do that also.
</p>

<p>
Lastly, setting the <code>scrollRestoration</code> property is critical because otherwise
the browser will want to restore the custom scroll position (instead of going to
the history item location we've saved).
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-js">js-scroll-to-history-item</a></span><span class="lilac-caption-link-symbol"><a href="#__NREF__js-scroll-to-history-item">&#x1f517;</a></span></div><pre class="src src-js" id="__NREF__js-scroll-to-history-item">$(document).ready(() =&gt; {
    history.scrollRestoration = <span class="org-string">"manual"</span>;
    window.addEventListener(<span class="org-string">"popstate"</span>, <span class="org-keyword">function</span> (<span class="org-variable-name">e</span>) {
        <span class="org-keyword">var</span> <span class="org-variable-name">hash</span> = e.state.hash;
        e.preventDefault();
        scrollIntoViewIfNeeded($(hash)[0]);
        $(hash).addClass(<span class="org-string">"active"</span>);
        deactivate_other_non_toc_items(hash);
    });
});
</pre></div></div>
</div>
</div>
</div>

<div id="outline-container-h-Autogenerate-CSS-for-syntax-highlighting-of-source-code-blocks" class="outline-4">
<h4 id="h-Autogenerate-CSS-for-syntax-highlighting-of-source-code-blocks"><span class="section-number-4">3.4.7.</span> Autogenerate CSS for syntax highlighting of source code blocks</h4>
<div class="outline-text-4" id="text-h-Autogenerate-CSS-for-syntax-highlighting-of-source-code-blocks">
<p>
See <a href="https://emacs.stackexchange.com/questions/31439/how-to-get-colored-syntax-highlighting-of-code-blocks-in-asynchronous-org-mode-e">this</a>, specifically <a href="https://emacs.stackexchange.com/a/36759">https://emacs.stackexchange.com/a/36759</a>.
</p>

<p>
Generate <code>syntax-highlighting.css</code> and quit emacs. This function is designed to
be run from the command line on a fresh emacs instance (dedicated OS process).
Unfortunately, by itself it is almost useless (see
<a href="#__NREF__enable-syntax-highlighting-from-batch-mode"><code>__NREF__enable-syntax-highlighting-from-batch-mode</code></a>), because there appears to
be a <a href="https://debbugs.gnu.org/cgi/bugreport.cgi?bug=61521">bug</a> in Emacs 28 which <a href="https://emacs.stackexchange.com/questions/75814/org-html-htmlize-generate-css-not-generating-styles">breaks</a> <code>org-html-htmlize-generate-css</code>.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-el">lilac_dot_el-autogenerate-css</a></span><span class="lilac-caption-link-symbol"><a href="#__NREF__lilac_dot_el-autogenerate-css">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__lilac_dot_el-autogenerate-css">(<span class="org-keyword">defun</span> <span class="org-function-name">lilac-gen-css-and-exit</span> ()
  (font-lock-flush)
  (font-lock-fontify-buffer)
  (org-html-htmlize-generate-css)
  (<span class="org-keyword">with-current-buffer</span> <span class="org-string">"*html*"</span>
    (write-file <span class="org-string">"syntax-highlighting.css"</span>))
  (kill-emacs))

<span class="org-comment-delimiter">;; </span><span class="org-comment">Without this, lilac-gen-css-and-exit produces a near-empty CSS file.</span>
<span class="lilac-child-link-from-parent"><a href="#__NREF__enable-syntax-highlighting-from-batch-mode">enable-syntax-highlighting-from-batch-mode</a></span>
</pre></div></div><p>
Sadly, <code>lilac-gen-css-and-exit</code> by itself generates a near-blank CSS file.
So we have to use code from <a href="https://emacs.stackexchange.com/questions/38437/org-mode-batch-export-missing-syntax-highlighting">here</a>:
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#__NREF__lilac_dot_el-autogenerate-css">enable-syntax-highlighting-from-batch-mode</a></span><span class="lilac-caption-link-symbol"><a href="#__NREF__enable-syntax-highlighting-from-batch-mode">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__enable-syntax-highlighting-from-batch-mode">(<span class="org-keyword">require</span> '<span class="org-constant">font-lock</span>)
(<span class="org-keyword">require</span> '<span class="org-constant">subr-x</span>) <span class="org-comment-delimiter">;; </span><span class="org-comment">for `</span><span class="org-comment"><span class="org-constant">when-let</span></span><span class="org-comment">'</span>

(<span class="org-keyword">unless</span> (boundp 'maximal-integer)
  (<span class="org-keyword">defconst</span> <span class="org-variable-name">maximal-integer</span> (lsh -1 -1)
    <span class="org-doc">"Maximal integer value representable natively in emacs lisp."</span>))

(<span class="org-keyword">defun</span> <span class="org-function-name">face-spec-default</span> (spec)
  <span class="org-doc">"Get list containing at most the default entry of face SPEC.</span>
<span class="org-doc">Return nil if SPEC has no default entry."</span>
  (<span class="org-keyword">let*</span> ((first (car-safe spec))
     (display (car-safe first)))
    (<span class="org-keyword">when</span> (eq display 'default)
      (list (car-safe spec)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">face-spec-min-color</span> (display-atts)
  <span class="org-doc">"Get min-color entry of DISPLAY-ATTS pair from face spec."</span>
  (<span class="org-keyword">let*</span> ((display (car-safe display-atts)))
    (<span class="org-keyword">or</span> (car-safe (cdr (assoc 'min-colors display)))
    maximal-integer)))

(<span class="org-keyword">defun</span> <span class="org-function-name">face-spec-highest-color</span> (spec)
  <span class="org-doc">"Search face SPEC for highest color.</span>
<span class="org-doc">That means the DISPLAY entry of SPEC</span>
<span class="org-doc">with class 'color and highest min-color value."</span>
  (<span class="org-keyword">let</span> ((color-list (cl-remove-if-not
             (<span class="org-keyword">lambda</span> (display-atts)
               (<span class="org-keyword">when-let</span> ((display (car-safe display-atts))
                  (class (<span class="org-keyword">and</span> (listp display)
                          (assoc 'class display)))
                  (background (assoc 'background display)))
             (<span class="org-keyword">and</span> (member 'light (cdr background))
                  (member 'color (cdr class)))))
             spec)))
    (cl-reduce (<span class="org-keyword">lambda</span> (display-atts1 display-atts2)
         (<span class="org-keyword">if</span> (&gt; (face-spec-min-color display-atts1)
            (face-spec-min-color display-atts2))
             display-atts1
           display-atts2))
           (cdr color-list)
           <span class="org-builtin">:initial-value</span> (car color-list))))

(<span class="org-keyword">defun</span> <span class="org-function-name">face-spec-t</span> (spec)
  <span class="org-doc">"Search face SPEC for fall back."</span>
  (cl-find-if (<span class="org-keyword">lambda</span> (display-atts)
        (eq (car-safe display-atts) t))
          spec))

<span class="org-comment-delimiter">; </span><span class="org-comment">This is slightly tweaked from the original, because the incoming "face" value</span>
<span class="org-comment-delimiter">; </span><span class="org-comment">can look like (fixed-pitch face-name) --- so we take the second element.</span>
(<span class="org-keyword">defun</span> <span class="org-function-name">my-face-attribute</span> (face attribute <span class="org-type">&amp;optional</span> frame inherit)
  <span class="org-doc">"Get FACE ATTRIBUTE from `</span><span class="org-doc"><span class="org-constant">face-user-default-spec</span></span><span class="org-doc">' and not from</span>
<span class="org-doc">`</span><span class="org-doc"><span class="org-constant">face-attribute</span></span><span class="org-doc">'."</span>
  (<span class="org-keyword">let*</span>
    ((face-spec (face-user-default-spec (<span class="org-keyword">if</span> (listp face)
                                            (car (cdr face))
                                          face)))
     (display-attr (<span class="org-keyword">or</span> (face-spec-highest-color face-spec)
               (face-spec-t face-spec)))
     (attr (cdr display-attr))
     (val (<span class="org-keyword">or</span> (plist-get attr attribute)
              (car-safe (cdr (assoc attribute attr))))))
    (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (null (eq attribute <span class="org-builtin">:inherit</span>))
           (null val))
      (<span class="org-keyword">let</span> ((inherited-face (my-face-attribute face <span class="org-builtin">:inherit</span>)))
    (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> inherited-face
           (null (eq inherited-face 'unspecified)))
      (<span class="org-keyword">setq</span> val (my-face-attribute inherited-face attribute)))))
    (<span class="org-keyword">or</span> val 'unspecified)))

(advice-add 'face-attribute <span class="org-builtin">:override</span> #'my-face-attribute)
</pre></div></div>
</div>
</div>

<div id="outline-container-h-Misc-settings" class="outline-4">
<h4 id="h-Misc-settings"><span class="section-number-4">3.4.8.</span> Misc settings</h4>
<div class="outline-text-4" id="text-h-Misc-settings">
</div>

<div id="outline-container-h-Use-HTML5-export--not-XML--to-un-break-MathJax" class="outline-5">
<h5 id="h-Use-HTML5-export--not-XML--to-un-break-MathJax"><span class="section-number-5">3.4.8.1.</span> Use HTML5 export, not XML (to un-break MathJax)</h5>
<div class="outline-text-5" id="text-h-Use-HTML5-export--not-XML--to-un-break-MathJax">
<p>
By default on Org 9.6, MathJax settings (JavaScript snippet) gets wrapped in a
CDATA tag, and we run into the same problem described on this email that has
gone unanswered:
<a href="https://www.mail-archive.com/emacs-orgmode@gnu.org/msg140821.html">https://www.mail-archive.com/emacs-orgmode@gnu.org/msg140821.html</a>. It appears
that this is because the document is exported as XML, not HTML. Setting the
document type to <code>html5</code>, as below, appears to make the CDATA tag magically
disappear.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-el">lilac_dot_el-misc</a></span>(1/7) <span class="lilac-caption-link-symbol"><a href="#__NREF__lilac_dot_el-misc-1">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__lilac_dot_el-misc-1">(<span class="org-keyword">setq</span> org-html-doctype <span class="org-string">"html5"</span>)
</pre></div></div>
</div>
</div>

<div id="outline-container-h-Set-citeproc-styles-folder" class="outline-5">
<h5 id="h-Set-citeproc-styles-folder"><span class="section-number-5">3.4.8.2.</span> Set citeproc styles folder</h5>
<div class="outline-text-5" id="text-h-Set-citeproc-styles-folder">
<p>
For some reason we cannot specify citeproc styles based on a relative path in
our Org file. The solution is to set the <code>org-cite-csl-styles-dir</code> variable. See
<a href="https://list.orgmode.org/CAFyQvY2SZ3jMWo2uwVq0bzTkZGog8eyDSEwhdBZVc8ui9K54vQ@mail.gmail.com/">this post</a>.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-el">lilac_dot_el-misc</a></span>(2/7) <span class="lilac-caption-link-symbol"><a href="#__NREF__lilac_dot_el-misc-2">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__lilac_dot_el-misc-2">(<span class="org-keyword">setq</span> org-cite-csl-styles-dir
      (concat (getenv <span class="org-string">"LILAC_ROOT"</span>) <span class="org-string">"/deps/styles/"</span>))
</pre></div></div>
</div>
</div>

<div id="outline-container-h-Code-references" class="outline-5">
<h5 id="h-Code-references"><span class="section-number-5">3.4.8.3.</span> Code references</h5>
<div class="outline-text-5" id="text-h-Code-references">
</div>

<div id="outline-container-h-Define--CodeHighlightOn--and--CodeHighlightOff" class="outline-6">
<h6 id="h-Define--CodeHighlightOn--and--CodeHighlightOff"><span class="section-number-6">3.4.8.3.1.</span> Define <code>CodeHighlightOn</code> and <code>CodeHighlightOff</code></h6>
<div class="outline-text-6" id="text-h-Define--CodeHighlightOn--and--CodeHighlightOff">
<p>
If we don't do this, we get an error because the "coderef" links (the links
inside code blocks, for example <code>;ref:NSCB_NAME</code>) will still try to run the
<code>CodeHighlightOn</code> and <code>CodeHighlightOff</code> JavaScript functions. Turning this
setting on here injects the definitions of these functions into the HTML.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-el">lilac_dot_el-misc</a></span>(3/7) <span class="lilac-caption-link-symbol"><a href="#__NREF__lilac_dot_el-misc-3">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__lilac_dot_el-misc-3">(<span class="org-keyword">setq</span> org-html-head-include-scripts t)
</pre></div></div>
</div>
</div>

<div id="outline-container-h-Do-not-highlight-coderefs" class="outline-6">
<h6 id="h-Do-not-highlight-coderefs"><span class="section-number-6">3.4.8.3.2.</span> Do not highlight coderefs</h6>
<div class="outline-text-6" id="text-h-Do-not-highlight-coderefs">
<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-css">css-coderef-disable-background-color</a></span><span class="lilac-caption-link-symbol"><a href="#__NREF__css-coderef-disable-background-color">&#x1f517;</a></span></div><pre class="src src-css" id="__NREF__css-coderef-disable-background-color"><span class="org-css-selector">.code-highlighted </span>{
    <span class="org-css-property">background-color</span>: inherit;
}
</pre></div></div>
</div>
</div>
</div>

<div id="outline-container-h-Preserve-leading-whitespace-characters-on-export" class="outline-5">
<h5 id="h-Preserve-leading-whitespace-characters-on-export"><span class="section-number-5">3.4.8.4.</span> Preserve leading whitespace characters on export</h5>
<div class="outline-text-5" id="text-h-Preserve-leading-whitespace-characters-on-export">
<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-el">lilac_dot_el-misc</a></span>(4/7) <span class="lilac-caption-link-symbol"><a href="#__NREF__lilac_dot_el-misc-4">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__lilac_dot_el-misc-4">(<span class="org-keyword">setq</span> org-src-preserve-indentation t)
</pre></div></div>
</div>
</div>

<div id="outline-container-h-Set-tab-width-to-4-spaces" class="outline-5">
<h5 id="h-Set-tab-width-to-4-spaces"><span class="section-number-5">3.4.8.5.</span> Set tab width to 4 spaces</h5>
<div class="outline-text-5" id="text-h-Set-tab-width-to-4-spaces">
<p>
This matters for languages that require tabs, such as Makefiles.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-el">lilac_dot_el-misc</a></span>(5/7) <span class="lilac-caption-link-symbol"><a href="#__NREF__lilac_dot_el-misc-5">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__lilac_dot_el-misc-5">(<span class="org-keyword">setq-default</span> tab-width 4)
</pre></div></div>
</div>
</div>

<div id="outline-container-h-Disable-backups" class="outline-5">
<h5 id="h-Disable-backups"><span class="section-number-5">3.4.8.6.</span> Disable backups</h5>
<div class="outline-text-5" id="text-h-Disable-backups">
<p>
Disable backup files for <code>lilac.el</code> (that look like <code>lilac.el~</code>) when we invoke
Emacs from the <a href="#Makefile">Makefile</a>.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-el">lilac_dot_el-misc</a></span>(6/7) <span class="lilac-caption-link-symbol"><a href="#__NREF__lilac_dot_el-misc-6">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__lilac_dot_el-misc-6">(<span class="org-keyword">setq</span> make-backup-files nil)
</pre></div></div>
</div>
</div>

<div id="outline-container-h-Profiling" class="outline-5">
<h5 id="h-Profiling"><span class="section-number-5">3.4.8.7.</span> Profiling</h5>
<div class="outline-text-5" id="text-h-Profiling">
<p>
We don't use this very often, but it's mainly for determining cost centers for
weaving and tangling.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-el">lilac_dot_el-misc</a></span>(7/7) <span class="lilac-caption-link-symbol"><a href="#__NREF__lilac_dot_el-misc-7">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__lilac_dot_el-misc-7">(<span class="org-keyword">defun</span> <span class="org-function-name">lilac-publish-profile</span> ()
  (<span class="org-keyword">interactive</span>)
  (profiler-start 'cpu)
  (lilac-publish)
  (profiler-stop)
  (profiler-report)
  (profiler-report-write-profile <span class="org-string">"emacs-profile-weave.txt"</span>) t)

(<span class="org-keyword">defun</span> <span class="org-function-name">lilac-tangle-profile</span> ()
  (<span class="org-keyword">interactive</span>)
  (profiler-start 'cpu)
  (org-babel-tangle)
  (profiler-stop)
  (profiler-report)
  (profiler-report-write-profile <span class="org-string">"emacs-profile-tangle.txt"</span>) t)
</pre></div></div>
</div>
</div>
</div>

<div id="outline-container-h-Imports" class="outline-4">
<h4 id="h-Imports"><span class="section-number-4">3.4.9.</span> Imports</h4>
<div class="outline-text-4" id="text-h-Imports">
<p>
If we want syntax-highlighting to work for a code block, that code block's major
mode (language) must be loaded in here.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-el">lilac_dot_el-imports</a></span><span class="lilac-caption-link-symbol"><a href="#__NREF__lilac_dot_el-imports">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__lilac_dot_el-imports"><span class="org-comment-delimiter">;; </span><span class="org-comment">Built-in packages (distributed with Emacs).</span>
(<span class="org-keyword">require</span> '<span class="org-constant">elisp-mode</span>)

(<span class="org-keyword">defun</span> <span class="org-function-name">lilac-load</span> (p)
  (add-to-list 'load-path
    (concat (getenv <span class="org-string">"LILAC_ROOT"</span>) p)))

<span class="org-comment-delimiter">;; </span><span class="org-comment">Third-party packages (checked in as Git submodules)</span>
(lilac-load <span class="org-string">"/deps/elisp/s.el"</span>)
(<span class="org-keyword">require</span> '<span class="org-constant">s</span>)
(lilac-load <span class="org-string">"/deps/elisp/compat.el"</span>)
(<span class="org-keyword">require</span> '<span class="org-constant">compat</span>)
(lilac-load <span class="org-string">"/deps/elisp/dash.el"</span>)
(<span class="org-keyword">require</span> '<span class="org-constant">dash</span>)
(lilac-load <span class="org-string">"/deps/elisp/dr-qubit.org"</span>)
(lilac-load <span class="org-string">"/deps/elisp/f.el"</span>)
(lilac-load <span class="org-string">"/deps/elisp/parsebib"</span>)
(lilac-load <span class="org-string">"/deps/elisp/citeproc-el"</span>)
(<span class="org-keyword">require</span> '<span class="org-constant">citeproc</span>)
(<span class="org-keyword">require</span> '<span class="org-constant">oc-csl</span>)
(lilac-load <span class="org-string">"/deps/elisp/emacs-htmlize"</span>)
(<span class="org-keyword">require</span> '<span class="org-constant">htmlize</span>)
(lilac-load <span class="org-string">"/deps/elisp/magit/lisp"</span>)
(<span class="org-keyword">require</span> '<span class="org-constant">magit-section</span>)
(lilac-load <span class="org-string">"/deps/elisp/nix-mode"</span>)
(<span class="org-keyword">require</span> '<span class="org-constant">nix-mode</span>)
(lilac-load <span class="org-string">"/deps/elisp/elquery"</span>)
(<span class="org-keyword">require</span> '<span class="org-constant">elquery</span>)
</pre></div></div>
</div>
</div>

<div id="outline-container-h-Additional--hand-tweaked--CSS" class="outline-4">
<h4 id="h-Additional--hand-tweaked--CSS"><span class="section-number-4">3.4.10.</span> Additional (hand-tweaked) CSS</h4>
<div class="outline-text-4" id="text-h-Additional--hand-tweaked--CSS">
<p>
We add some additional CSS tweaks on top of what we get from Org.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><label class="org-src-name">lilac.css</label><span class="lilac-caption-link-symbol"><a href="#lilac-css">&#x1f517;</a></span></div><pre class="src src-css" id="lilac-css"><span class="lilac-child-link-from-parent"><a href="#__NREF__css-general-1">css-general</a></span>
<span class="lilac-child-link-from-parent"><a href="#__NREF__css-headline-font-size">css-headline-font-size</a></span>
<span class="lilac-child-link-from-parent"><a href="#__NREF__css-coderef-disable-background-color">css-coderef-disable-background-color</a></span>
<span class="lilac-child-link-from-parent"><a href="#__NREF__css-source-code-section-headlines-1">css-source-code-section-headlines</a></span>
<span class="lilac-child-link-from-parent"><a href="#__NREF__css-source-code-block-body">css-source-code-block-body</a></span>
<span class="lilac-child-link-from-parent"><a href="#__NREF__css-source-code-block-captions">css-source-code-block-captions</a></span>
<span class="lilac-child-link-from-parent"><a href="#__NREF__css-source-code-block-child-link-from-parent">css-source-code-block-child-link-from-parent</a></span>
<span class="lilac-child-link-from-parent"><a href="#__NREF__css-sidenotes">css-sidenotes</a></span>
<span class="lilac-child-link-from-parent"><a href="#__NREF__css-description-lists">css-description-lists</a></span>
<span class="lilac-child-link-from-parent"><a href="#__NREF__css-bibliography">css-bibliography</a></span>
<span class="lilac-child-link-from-parent"><a href="#__NREF__css-toc-1">css-toc</a></span>
<span class="lilac-child-link-from-parent"><a href="#__NREF__css-active-non-toc-item">css-active-non-toc-item</a></span>
</pre></div></div>
</div>

<div id="outline-container-h-Colors" class="outline-5">
<h5 id="h-Colors"><span class="section-number-5">3.4.10.1.</span> Colors</h5>
<div class="outline-text-5" id="text-h-Colors">
<p>
We define colors in one place and reuse them throughout the rest of the CSS,
with the <code>var()</code> function.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-css">css-general</a></span>(1/8) <span class="lilac-caption-link-symbol"><a href="#__NREF__css-general-1">&#x1f517;</a></span></div><pre class="src src-css" id="__NREF__css-general-1"><span class="org-css-selector">:root</span> {
    <span class="org-variable-name">--bg-code</span>: <span class="custom-11">#f7f7f7</span>;
    <span class="org-variable-name">--border-code</span>: <span class="custom-10">#777</span>;
    <span class="org-variable-name">--border-light</span>: <span class="custom-9">#ccc</span>;
    <span class="org-variable-name">--fg-link</span>: <span class="custom-8">#0000ff</span>;
    <span class="org-variable-name">--fg-nref-link</span>: <span class="custom-7">#21618c</span>;
    <span class="org-variable-name">--bg-nref-link</span>: <span class="custom-6">#d8f6ff</span>;
    <span class="org-variable-name">--fg-nref-link-hover</span>: <span class="custom-5">#7d3c98</span>;
    <span class="org-variable-name">--bg-nref-link-hover</span>: <span class="custom-4">#f8e9ff</span>;
    <span class="org-variable-name">--fg-toc-item</span>: <span class="custom-3">green</span>;
    <span class="org-variable-name">--bg-toc-item</span>: <span class="custom-2">#f1ffef</span>;
    <span class="org-variable-name">--fg-heading</span>: <span class="custom-1">black</span>;
    <span class="org-variable-name">--clear</span>: <span class="custom">rgba(255, 255, 255, 0)</span>;
}
</pre></div></div>
</div>
</div>

<div id="outline-container-h-General-body-text" class="outline-5">
<h5 id="h-General-body-text"><span class="section-number-5">3.4.10.2.</span> General body text</h5>
<div class="outline-text-5" id="text-h-General-body-text">
<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-css">css-general</a></span>(2/8) <span class="lilac-caption-link-symbol"><a href="#__NREF__css-general-2">&#x1f517;</a></span></div><pre class="src src-css" id="__NREF__css-general-2"><span class="org-css-selector">body </span>{
    <span class="org-css-property">font-size</span>: 1.25em;
    <span class="org-css-property">width</span>: 800px;
    <span class="org-css-property">margin-left</span>: 310px;
    <span class="org-css-property">overflow-x</span>: hidden;
}

<span class="org-css-selector">body, p, li, legend </span>{
    <span class="org-css-property">font-family</span>: <span class="org-string">"Source Serif Pro"</span>, serif;
}

<span class="org-css-selector">h2, h3, h4, h5, h6 </span>{
    <span class="org-css-property">margin</span>: 1em 0 0 -4px;
    <span class="org-css-property">padding</span>: 0 4px;
    <span class="org-css-property">display</span>: inline-block;
    <span class="org-css-property">border-style</span>: solid;
    <span class="org-css-property">border-width</span>: 1px;
    <span class="org-css-property">border-color</span>: var(<span class="org-variable-name">--clear</span>);
}

<span class="org-css-selector">h1, h2, h3, h4, h5, h6, dt </span>{
    <span class="org-css-property">font-family</span>: <span class="org-string">"Source Sans Pro"</span>, sans;
}

<span class="org-css-selector">h3, h4, h5, h6 </span>{
    <span class="org-css-property">font-weight</span>: normal;
}

<span class="org-css-selector">p, li </span>{
    <span class="org-css-property">line-height</span>: 1.2em;
}

<span class="org-css-selector">p, ol, ul </span>{
    <span class="org-css-property">margin-top</span>: 0;
    <span class="org-css-property">margin-bottom</span>: 0;
    <span class="org-css-property">padding-top</span>: 1em;
}

<span class="org-css-selector">li </span>{
    <span class="org-css-property">margin-bottom</span>: 0;
}
</pre></div></div>
</div>
</div>

<div id="outline-container-h-Headline-font-sizes" class="outline-5">
<h5 id="h-Headline-font-sizes"><span class="section-number-5">3.4.10.3.</span> Headline font sizes</h5>
<div class="outline-text-5" id="text-h-Headline-font-sizes">
<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-css">css-headline-font-size</a></span>(1/1) <span class="lilac-caption-link-symbol"><a href="#__NREF__css-headline-font-size">&#x1f517;</a></span></div><pre class="src src-css" id="__NREF__css-headline-font-size"><span class="org-css-selector">h1 </span>{
    <span class="org-css-property">font-size</span>: 3em;
}

<span class="org-css-selector">h2 </span>{
    <span class="org-css-property">font-size</span>: 2.4em;
}

<span class="org-css-selector">h3 </span>{
    <span class="org-css-property">font-size</span>: 2em;
}

<span class="org-css-selector">h4 </span>{
    <span class="org-css-property">font-size</span>: 1.6em;
}

<span class="org-css-selector">h5 </span>{
    <span class="org-css-property">font-size</span>: 1.2em;
}

<span class="org-css-selector">h6 </span>{
    <span class="org-css-property">font-size</span>: 1em;
}
</pre></div></div>
</div>
</div>

<div id="outline-container-h-Tables" class="outline-5">
<h5 id="h-Tables"><span class="section-number-5">3.4.10.4.</span> Tables</h5>
<div class="outline-text-5" id="text-h-Tables">
<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-css">css-general</a></span>(3/8) <span class="lilac-caption-link-symbol"><a href="#__NREF__css-general-3">&#x1f517;</a></span></div><pre class="src src-css" id="__NREF__css-general-3"><span class="org-css-selector">table </span>{
    <span class="org-css-property">margin</span>: 1em auto 0em auto;
    <span class="org-css-property">border-spacing</span>: 0;
    <span class="org-css-property">border-radius</span>: 4px;
    <span class="org-css-property">border</span>: 1px solid var(<span class="org-variable-name">--border-code</span>);
    <span class="org-css-property">border-collapse</span>: unset;
    <span class="org-css-property">overflow</span>: hidden;
}

<span class="org-css-selector">th, td </span>{
    <span class="org-css-property">padding</span>: 3px 6px;
    <span class="org-css-property">border-right</span>: 1px solid var(<span class="org-variable-name">--border-code</span>);
    <span class="org-css-property">border-bottom</span>: 1px solid var(<span class="org-variable-name">--border-code</span>);
}

<span class="org-css-selector">th:last-child, td:last-child  </span>{
    <span class="org-css-property">border-right</span>: none;
}

<span class="org-css-selector">tr:last-child td </span>{
    <span class="org-css-property">border-bottom</span>: none;
}

<span class="org-css-selector">thead </span>{
    <span class="org-css-property">background-color</span>: var(<span class="org-variable-name">--bg-code</span>);
}
</pre></div></div>
</div>
</div>

<div id="outline-container-h-Description-lists" class="outline-5">
<h5 id="h-Description-lists"><span class="section-number-5">3.4.10.5.</span> Description lists</h5>
<div class="outline-text-5" id="text-h-Description-lists">
<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-css">css-general</a></span>(4/8) <span class="lilac-caption-link-symbol"><a href="#__NREF__css-general-4">&#x1f517;</a></span></div><pre class="src src-css" id="__NREF__css-general-4"><span class="org-css-selector">dl </span>{
    <span class="org-css-property">margin</span>: 0;
    <span class="org-css-property">padding-top</span>: 1em;
}
</pre></div></div>
</div>
</div>

<div id="outline-container-h-Images" class="outline-5">
<h5 id="h-Images"><span class="section-number-5">3.4.10.6.</span> Images</h5>
<div class="outline-text-5" id="text-h-Images">
<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-css">css-general</a></span>(5/8) <span class="lilac-caption-link-symbol"><a href="#__NREF__css-general-5">&#x1f517;</a></span></div><pre class="src src-css" id="__NREF__css-general-5"><span class="org-css-selector">img </span>{
    <span class="org-css-property">display</span>: block;
    <span class="org-css-property">margin</span>: 0 auto;
}
</pre></div></div>
</div>
</div>

<div id="outline-container-h-Monospaced" class="outline-5">
<h5 id="h-Monospaced"><span class="section-number-5">3.4.10.7.</span> Monospaced</h5>
<div class="outline-text-5" id="text-h-Monospaced">
<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-css">css-general</a></span>(6/8) <span class="lilac-caption-link-symbol"><a href="#__NREF__css-general-6">&#x1f517;</a></span></div><pre class="src src-css" id="__NREF__css-general-6"><span class="org-css-selector">code </span>{
    <span class="org-css-property">background-color</span>: var(<span class="org-variable-name">--bg-code</span>);
    <span class="org-css-property">padding-left</span>: 5px;
    <span class="org-css-property">padding-right</span>: 5px;
    <span class="org-css-property">white-space</span>: nowrap;
    <span class="org-css-property">border-radius</span>: 4px;
    <span class="org-css-property">border-style</span>: solid;
    <span class="org-css-property">border-width</span>: 1px;
    <span class="org-css-property">border-color</span>: var(<span class="org-variable-name">--border-code</span>);
}

<span class="org-css-selector">pre </span>{
    <span class="org-css-property">font-size</span>: 0.8em;
    <span class="org-css-property">border-radius</span>: 5px;
    <span class="org-css-property">margin</span>: 1em 0 0 0;
    <span class="org-css-property">background-color</span>: var(<span class="org-variable-name">--bg-code</span>);
    <span class="org-css-property">border-color</span>: var(<span class="org-variable-name">--border-code</span>);
    <span class="org-css-property">min-width</span>: fit-content;
}
</pre></div></div><p>
Also make the background color of the programming language hover text the same
as what we have elsewhere. This hover text comes with Org mode's HTML export of
source code blocks.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-css">css-general</a></span>(7/8) <span class="lilac-caption-link-symbol"><a href="#__NREF__css-general-7">&#x1f517;</a></span></div><pre class="src src-css" id="__NREF__css-general-7"><span class="org-css-selector">pre.src::before </span>{
    <span class="org-css-property">background-color</span>: var(<span class="org-variable-name">--bg-code</span>);
}
</pre></div></div>
</div>
</div>

<div id="outline-container-h-Links" class="outline-5">
<h5 id="h-Links"><span class="section-number-5">3.4.10.8.</span> Links</h5>
<div class="outline-text-5" id="text-h-Links">
<p>
Force all links to have a blue color. This is mainly to override whatever Org
gives us by default.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-css">css-general</a></span>(8/8) <span class="lilac-caption-link-symbol"><a href="#__NREF__css-general-8">&#x1f517;</a></span></div><pre class="src src-css" id="__NREF__css-general-8"><span class="org-css-selector">a </span>{
    <span class="org-css-property">color</span>: var(<span class="org-variable-name">--fg-link</span>);
}
</pre></div></div>
</div>
</div>

<div id="outline-container-h-Source-code-block-body" class="outline-5">
<h5 id="h-Source-code-block-body"><span class="section-number-5">3.4.10.9.</span> Source code block body</h5>
<div class="outline-text-5" id="text-h-Source-code-block-body">
<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-css">css-source-code-block-body</a></span><span class="lilac-caption-link-symbol"><a href="#__NREF__css-source-code-block-body">&#x1f517;</a></span></div><pre class="src src-css" id="__NREF__css-source-code-block-body"><span class="org-css-selector">.org-src-container </span>{
    <span class="org-css-property">padding-top</span>: 1em;
}

<span class="org-css-selector">.org-src-container pre </span>{
    <span class="org-css-property">margin</span>: 0;
    <span class="org-css-property">font-family</span>: <span class="org-string">"Source Code Pro"</span>, monospace;
    <span class="org-css-property">border-width</span>: 0;
    <span class="org-css-property">scroll-margin-top</span>: 100px;
    <span class="org-css-property">border-style</span>: solid;
    <span class="org-css-property">border-width</span>: 1px;
    <span class="org-css-property">border-color</span>: var(<span class="org-variable-name">--border-code</span>);
    <span class="org-css-property">border-radius</span>: 5px;
}

<span class="org-comment-delimiter">/* </span><span class="org-comment">Source code block body.</span><span class="org-comment-delimiter"> */</span>
<span class="org-css-selector">.org-src-container pre.src </span>{
    <span class="org-css-property">background-color</span>: var(<span class="org-variable-name">--bg-code</span>);
}

</pre></div></div>
</div>
</div>

<div id="outline-container-h-Source-code-block-captions" class="outline-5">
<h5 id="h-Source-code-block-captions"><span class="section-number-5">3.4.10.10.</span> Source code block captions</h5>
<div class="outline-text-5" id="text-h-Source-code-block-captions">
<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-css">css-source-code-block-captions</a></span><span class="lilac-caption-link-symbol"><a href="#__NREF__css-source-code-block-captions">&#x1f517;</a></span></div><pre class="src src-css" id="__NREF__css-source-code-block-captions"><span class="org-css-selector">.lilac-caption </span>{
    <span class="org-css-property">font-family</span>: <span class="org-string">"Source Code Pro"</span>, monospace;
    <span class="org-css-property">text-align</span>: right;
    <span class="org-css-property">border-top-left-radius</span>: 5px;
    <span class="org-css-property">border-top-right-radius</span>: 5px;
    <span class="org-css-property">padding-top</span>: 2px;
    <span class="org-css-property">padding-bottom</span>: 2px;
}

<span class="org-css-selector">.lilac-caption label </span>{
    <span class="org-css-property">margin-right</span>: 10px;
    <span class="org-css-property">padding-left</span>: 10px;
    <span class="org-css-property">padding-right</span>: 10px;
    <span class="org-css-property">padding-bottom</span>: 10px;
    <span class="org-css-property">border-radius</span>: 5px;
    <span class="org-css-property">border-style</span>: solid;
    <span class="org-css-property">border-bottom-style</span>: none;
    <span class="org-css-property">border-bottom-left-radius</span>: 0;
    <span class="org-css-property">border-bottom-right-radius</span>: 0;
    <span class="org-css-property">border-width</span>: 1px;
    <span class="org-css-property">background-color</span>: var(<span class="org-variable-name">--bg-code</span>);
    <span class="org-css-property">border-color</span>: var(<span class="org-variable-name">--border-code</span>);
}

<span class="org-css-selector">.lilac-caption-source-code-block-name </span>{
    <span class="org-css-property">color</span>: <span class="custom">#444444</span>;
    <span class="org-css-property">font-weight</span>: bold;
    <span class="org-css-property">margin-right</span>: 5px;
}

<span class="org-css-selector">.lilac-caption-parent-link </span>{
    <span class="org-css-property">margin-top</span>: 5px;
    <span class="org-css-property">margin-right</span>: 5px;
    <span class="org-css-property">padding-left</span>: 5px;
    <span class="org-css-property">padding-right</span>: 5px;
    <span class="org-css-property">font-weight</span>: bold;
}
<span class="org-css-selector">.lilac-caption-parent-link a </span>{
    <span class="org-css-property">padding-left</span>: 10px;
    <span class="org-css-property">padding-right</span>: 10px;
    <span class="org-css-property">padding-bottom</span>: 10px;
    <span class="org-css-property">color</span>: var(<span class="org-variable-name">--fg-nref-link</span>);
    <span class="org-css-property">background-color</span>: var(<span class="org-variable-name">--bg-nref-link</span>);
    <span class="org-css-property">border-radius</span>: 5px;
    <span class="org-css-property">border-style</span>: solid;
    <span class="org-css-property">border-width</span>: 1px;
    <span class="org-css-property">border-bottom-style</span>: none;
    <span class="org-css-property">border-bottom-left-radius</span>: 0;
    <span class="org-css-property">border-bottom-right-radius</span>: 0;
    <span class="org-css-property">transition</span>: all 150ms ease-in-out;
}
<span class="org-css-selector">.lilac-caption-parent-link a:hover </span>{
    <span class="org-css-property">color</span>: var(<span class="org-variable-name">--fg-nref-link-hover</span>);
    <span class="org-css-property">background-color</span>: var(<span class="org-variable-name">--bg-nref-link-hover</span>);
    <span class="org-css-property">text-decoration</span>: none;
}

<span class="org-css-selector">.lilac-caption-link-symbol a </span>{
    <span class="org-css-property">margin-right</span>: 5px;
}
<span class="org-css-selector">.lilac-caption-link-symbol a:hover </span>{
    <span class="org-css-property">text-decoration</span>: none;
}

<span class="org-css-selector">.lilac-caption-listing-number </span>{
    <span class="org-css-property">margin-right</span>: 5px;
}
</pre></div></div>
</div>
</div>

<div id="outline-container-h-Links-to-child-source-block-from-parent" class="outline-5">
<h5 id="h-Links-to-child-source-block-from-parent"><span class="section-number-5">3.4.10.11.</span> Links to child source block from parent</h5>
<div class="outline-text-5" id="text-h-Links-to-child-source-block-from-parent">
<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-css">css-source-code-block-child-link-from-parent</a></span><span class="lilac-caption-link-symbol"><a href="#__NREF__css-source-code-block-child-link-from-parent">&#x1f517;</a></span></div><pre class="src src-css" id="__NREF__css-source-code-block-child-link-from-parent"><span class="org-css-selector">.lilac-child-link-from-parent </span>{
    <span class="org-css-property">font-weight</span>: bold;
}
<span class="org-css-selector">.lilac-child-link-from-parent a </span>{
    <span class="org-css-property">color</span>: var(<span class="org-variable-name">--fg-nref-link</span>);
    <span class="org-css-property">background-color</span>: var(<span class="org-variable-name">--bg-nref-link</span>);
    <span class="org-css-property">border-radius</span>: 5px;
    <span class="org-css-property">border-style</span>: solid;
    <span class="org-css-property">border-width</span>: 1px;
    <span class="org-css-property">margin</span>: 2px 0;
    <span class="org-css-property">padding</span>: 0 5px;
    <span class="org-css-property">display</span>: inline-block;
    <span class="org-css-property">transition</span>: all 150ms ease-in-out;
}
<span class="org-css-selector">.lilac-child-link-from-parent a:hover </span>{
    <span class="org-css-property">color</span>: var(<span class="org-variable-name">--fg-nref-link-hover</span>);
    <span class="org-css-property">background-color</span>: var(<span class="org-variable-name">--bg-nref-link-hover</span>);
    <span class="org-css-property">text-decoration</span>: none;
}
</pre></div></div>
</div>
</div>

<div id="outline-container-h-Sidenotes-1" class="outline-5">
<h5 id="h-Sidenotes-1"><span class="section-number-5">3.4.10.12.</span> Sidenotes</h5>
<div class="outline-text-5" id="text-h-Sidenotes-1">
<p>
Sidenotes are small blurbs of text that are displayed "out-of-band", on the
right margin. This right margin is good for presenting smaller ideas that
shouldn't necessarily sit in the main body text.
</p>

<p>
The CSS below is drawn primarily from <a href="https://scripter.co/sidenotes-using-only-css/">here</a>, with some modifications.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-css">css-sidenotes</a></span><span class="lilac-caption-link-symbol"><a href="#__NREF__css-sidenotes">&#x1f517;</a></span></div><pre class="src src-css" id="__NREF__css-sidenotes"><span class="org-css-selector">.sidenote </span>{
    <span class="org-css-property">font-size</span>: 80%;
    <span class="org-css-property">margin-top</span>: 1em;
    <span class="org-css-property">padding</span>: 1em 0 1em 1em;
    <span class="org-css-property">border-left</span>: solid;
    <span class="org-css-property">border-right</span>: none;
    <span class="org-css-property">border-width</span>: 1px;
    <span class="org-css-property">border-color</span>: var(<span class="org-variable-name">--border-light</span>);
}

<span class="org-css-selector">.sidenote p </span>{
    <span class="org-css-property">padding-top</span>: 0;
    <span class="org-css-property">margin-top</span>: 1em;
}

<span class="org-css-selector">.sidenote p:first-child </span>{
    <span class="org-css-property">margin-top</span>: 0;
}

<span class="org-builtin">@media</span> (max-width: 1425px) {
    <span class="org-css-selector">.sidenote </span>{
        <span class="org-css-property">margin-left</span>: 1em;
    }
}

<span class="org-builtin">@media</span> (min-width: 1425px) {
    <span class="org-css-selector">.sidenote </span>{
        <span class="org-css-property">margin-left</span>: 0;

        <span class="org-css-property">width</span>: 280px;
        <span class="org-css-property">float</span>: right;
        <span class="org-css-property">margin-right</span>: -315px;
    }
}
</pre></div></div>
</div>
</div>
</div>

<div id="outline-container-h-Create--lilac-theme--file" class="outline-4">
<h4 id="h-Create--lilac-theme--file"><span class="section-number-4">3.4.11.</span> Create <code>lilac.theme</code> file</h4>
<div class="outline-text-4" id="text-h-Create--lilac-theme--file">
<p>
Allow HTML exports of Org files (inluding this one) to pull in CSS and
JavaScript that we've defined for Lilac by referring to a single theme file. The
inspiration for this setup comes from <a href="https://gitlab.com/OlMon/org-themes">https://gitlab.com/OlMon/org-themes</a>.
</p>

<p>
For the fonts, we break up the definition over multiple lines here using Emacs
Lisp for readability.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-theme">fonts-to-load</a></span><span class="lilac-caption-link-symbol"><a href="#__NREF__fonts-to-load">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__fonts-to-load">(concat
 <span class="org-string">"#+HTML_HEAD: &lt;link rel=\"stylesheet\" href="</span>
   <span class="org-string">"\"https://fonts.googleapis.com/css2"</span>
     <span class="org-string">"?family=Source+Serif+Pro:wght@400;700"</span>
     <span class="org-string">"&amp;family=Source+Sans+Pro:wght@400;700"</span>
     <span class="org-string">"&amp;family=Source+Code+Pro"</span>
 <span class="org-string">"\"&gt;"</span>)
</pre></div></div><p>
Now we get the result of evaluating the above with <code>__NREF__fonts-to-load()</code>
below (note the trailing parentheses <code>()</code>, which evaluates the referenced code
block before injecting its evaluated value).
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><label class="org-src-name">lilac.theme</label><span class="lilac-caption-link-symbol"><a href="#lilac-theme">&#x1f517;</a></span></div><pre class="src src-org" id="lilac-theme"><span class="org-comment"># Include additional CSS styles.</span>
<span class="org-org-meta-line">#+HTML_HEAD: &lt;link rel="stylesheet" type="text/css" href="syntax-highlighting.css"/&gt;</span>
<span class="org-org-meta-line">#+HTML_HEAD: &lt;link rel="stylesheet" type="text/css" href="lilac.css" /&gt;</span>
<span class="lilac-child-link-from-parent"><a href="#__NREF__fonts-to-load">fonts-to-load</a></span>()

<span class="lilac-child-link-from-parent"><a href="#__NREF__lilac-theme-js">lilac-theme-js</a></span>
</pre></div></div>
</div>
</div>

<div id="outline-container-h-Ignore-woven-HTML-from--git-diff" class="outline-4">
<h4 id="h-Ignore-woven-HTML-from--git-diff"><span class="section-number-4">3.4.12.</span> Ignore woven HTML from <code>git diff</code></h4>
<div class="outline-text-4" id="text-h-Ignore-woven-HTML-from--git-diff">
<p>
Typically we only need to look at the rendered HTML output in a web browser as
the raw HTML diff output is extremely difficult to parse as a human. So by
default we ask Git to exclude it from <code>git diff</code> by treating them as binary
data.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><label class="org-src-name">.gitattributes</label><span class="lilac-caption-link-symbol"><a href="#gitattributes">&#x1f517;</a></span></div><pre class="src src-gitattributes" id="gitattributes">* -diff
**/*.org diff
**/.gitattributes diff
**/.gitmodules diff
**/.gitignore diff
package/nix/sources.json diff
package/nix/sources.nix diff
</pre></div></div><p>
In order to still show the HTML textual diff, we can run <code>git diff --text</code>.
</p>
</div>

<div id="outline-container-h-git-add--p" class="outline-5">
<h5 id="h-git-add--p"><span class="section-number-5">3.4.12.1.</span> <code>git add -p</code></h5>
<div class="outline-text-5" id="text-h-git-add--p">
<p>
Note that the above setting to treat HTML files as binary data prevents them
from being considered for <code>git add -p</code>. In order to add them, use <code>git add -u</code>
instead.
</p>
</div>
</div>
</div>

<div id="outline-container-h-gitignore" class="outline-4">
<h4 id="h-gitignore"><span class="section-number-4">3.4.13.</span> gitignore</h4>
<div class="outline-text-4" id="text-h-gitignore">
<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><label class="org-src-name">.gitignore</label><span class="lilac-caption-link-symbol"><a href="#gitignore">&#x1f517;</a></span></div><pre class="src src-gitignore" id="gitignore">**/*.auctex-auto
tangle
update-deps
weave
</pre></div></div>
</div>
</div>
</div>

<div id="outline-container-h-Tests" class="outline-3">
<h3 id="h-Tests"><span class="section-number-3">3.5.</span> Tests</h3>
<div class="outline-text-3" id="text-h-Tests">
<p>
We use <a href="https://www.gnu.org/software/emacs/manual/ert.html">ERT, the Emacs Lisp Regression Testing tool</a> for our unit tests. Pure
functions that take all of their inputs explicitly ("dependency-injected") are
easy to test because we just provide the various inputs and expect the function
to produce certain outputs. For functions that operate on an Emacs buffer, we
use <code>with-temp-buffer</code> to create a temporary buffer first before invoking the
functions under test.
</p>

<p>
Some functions we test expect Org mode to be active (so that certain Org mode
functions are available), so we turn it on here by calling <code>(org-mode)</code>.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><label class="org-src-name">lilac-tests.el</label><span class="lilac-caption-link-symbol"><a href="#lilac-tests-el">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="lilac-tests-el">(<span class="org-keyword">require</span> '<span class="org-constant">ert</span>)
(<span class="org-keyword">require</span> '<span class="org-constant">lilac</span>)

(org-mode)

<span class="lilac-child-link-from-parent"><a href="#__NREF__t-helpers-1">t-helpers</a></span>
<span class="lilac-child-link-from-parent"><a href="#__NREF__t-smart-caption-generation-1">t-smart-caption-generation</a></span>
<span class="lilac-child-link-from-parent"><a href="#__NREF__t-link-to-child-block-from-parent-block-1">t-link-to-child-block-from-parent-block</a></span>

(<span class="org-keyword">provide</span> '<span class="org-constant">lilac-tests</span>)
</pre></div></div>
</div>

<div id="outline-container-h-Test-helpers" class="outline-4">
<h4 id="h-Test-helpers"><span class="section-number-4">3.5.1.</span> Test helpers</h4>
<div class="outline-text-4" id="text-h-Test-helpers">
</div>

<div id="outline-container-h-Avoid-cross-abstraction-Noweb-reference-prefix-collision" class="outline-5">
<h5 id="h-Avoid-cross-abstraction-Noweb-reference-prefix-collision"><span class="section-number-5">3.5.1.1.</span> Avoid cross-abstraction Noweb reference prefix collision</h5>
<div class="outline-text-5" id="text-h-Avoid-cross-abstraction-Noweb-reference-prefix-collision">
<p>
Note that we cannot write <code>__NREF__foo</code> directly in the test code here, because
when this Org file is tangled, the references will be detected and Org mode will
try to replace them with a monoblock or polyblock elsewhere in this file named
<code>__NREF__foo</code>. So we have to go in "stealth mode" by writing the <code>__NREF__</code>
prefix indirectly with the <code>(nref)</code> helper function.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-tests-el">t-helpers</a></span>(1/2) <span class="lilac-caption-link-symbol"><a href="#__NREF__t-helpers-1">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__t-helpers-1">(<span class="org-keyword">defun</span> <span class="org-function-name">nref</span> (s) (concat <span class="org-string">"__NREF__"</span> s))
</pre></div></div>
</div>
</div>

<div id="outline-container-h-Setup-and-tear-down-fixture-for-HTML-tests" class="outline-5">
<h5 id="h-Setup-and-tear-down-fixture-for-HTML-tests"><span class="section-number-5">3.5.1.2.</span> Setup and tear-down fixture for HTML tests</h5>
<div class="outline-text-5" id="text-h-Setup-and-tear-down-fixture-for-HTML-tests">
<div class="sidenote" id="org0000124">
<p>
The <a href="https://www.gnu.org/software/emacs/manual/html_mono/ert.html#Fixtures-and-Test-Suites">Emacs manual</a> for ERT defines fixtures as environments which provide setup
and tear-down.
</p>

</div>

<p>
When testing HTML output (behavior of <code>(lilac-publish)</code>), it's useful to create
a temporary Org file and to generate the HTML output (as part of "setup"). Then
we'd run the tests, and finally delete the temporary files (as part of
"tear-down").
</p>

<p>
We use <code>(lilac-publish-fixture)</code> to do the aforementioned setup and tear-down
for us. In between setup and tear-down, we execute the <code>test</code> function with a
<code>funcall</code>.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-tests-el">t-helpers</a></span>(2/2) <span class="lilac-caption-link-symbol"><a href="#__NREF__t-helpers-2">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__t-helpers-2">(<span class="org-keyword">defun</span> <span class="org-function-name">lilac-publish-fixture</span> (fname-prefix content test)
  (<span class="org-keyword">let*</span> ((fname-org (make-temp-file fname-prefix nil <span class="org-string">".org"</span>))
         (fname-html (concat (string-remove-suffix <span class="org-string">"org"</span> fname-org) <span class="org-string">"html"</span>)))
    (<span class="org-keyword">unwind-protect</span>
        (<span class="org-keyword">progn</span>
          (<span class="org-keyword">with-temp-file</span> fname-org
            (org-mode)
            (insert content))
          (find-file fname-org)
          (lilac-publish)
          (funcall test (elquery-read-file fname-html)))
    (shell-command-to-string
     (concat <span class="org-string">"rm -f "</span>
             (mapconcat 'identity `(,fname-org ,fname-html) <span class="org-string">" "</span>))))))
</pre></div></div>
</div>
</div>
</div>

<div id="outline-container-h-Smart-source-code-block-caption-helpers" class="outline-4">
<h4 id="h-Smart-source-code-block-caption-helpers"><span class="section-number-4">3.5.2.</span> Smart source code block caption helpers</h4>
<div class="outline-text-4" id="text-h-Smart-source-code-block-caption-helpers">
<p>
<code>lilac-get-noweb-children</code> should return a list of Noweb references (child block
names) found in a source code block.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-tests-el">t-smart-caption-generation</a></span>(1/6) <span class="lilac-caption-link-symbol"><a href="#__NREF__t-smart-caption-generation-1">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__t-smart-caption-generation-1">(<span class="org-keyword">ert-deftest</span> <span class="org-function-name">t-lilac-get-noweb-children</span> ()
  (<span class="org-keyword">let</span> ((body
         (concat
          <span class="org-string">"#+name: foo\n"</span>
          <span class="org-string">"#+caption: foo\n"</span>
          <span class="org-string">"#+begin_src emacs-lisp\n"</span>
          <span class="org-string">"; foo\n"</span>
          <span class="org-string">"#+end_src\n"</span>)))
    (<span class="org-keyword">should</span> (equal (lilac-get-noweb-children body)
                   ())))
  (<span class="org-keyword">let</span> ((body
         (concat
          <span class="org-string">"#+name: parent\n"</span>
          <span class="org-string">"#+caption: parent\n"</span>
          <span class="org-string">"#+begin_src emacs-lisp\n"</span>
          <span class="org-string">"; foo\n"</span>
          (nref <span class="org-string">"one"</span>) <span class="org-string">"\n"</span>
          <span class="org-string">"; bar\n"</span>
          (nref <span class="org-string">"two"</span>) <span class="org-string">"\n"</span>
          <span class="org-string">"#+end_src\n"</span>)))
    (<span class="org-keyword">should</span> (equal (lilac-get-noweb-children body)
                   `(,(nref <span class="org-string">"one"</span>) ,(nref <span class="org-string">"two"</span>))))))
</pre></div></div><p>
<code>lilac-is-parent-block</code> depends on <code>lilac-get-noweb-children</code>. We tested the
latter already above, but we test the former anyway for completeness.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-tests-el">t-smart-caption-generation</a></span>(2/6) <span class="lilac-caption-link-symbol"><a href="#__NREF__t-smart-caption-generation-2">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__t-smart-caption-generation-2">(<span class="org-keyword">ert-deftest</span> <span class="org-function-name">t-lilac-is-parent-block</span> ()
  (<span class="org-keyword">with-temp-buffer</span>
    (insert <span class="org-string">"#+name: parent\n"</span>)
    (insert <span class="org-string">"#+caption: parent\n"</span>)
    (insert <span class="org-string">"#+begin_src emacs-lisp\n"</span>)
    (insert <span class="org-string">"; foo\n"</span>)
    (insert (concat (nref <span class="org-string">"child"</span>) <span class="org-string">"\n"</span>))
    (insert <span class="org-string">"#+end_src\n"</span>)
    (goto-char (point-min))
    (<span class="org-keyword">let</span> ((src-block (org-element-at-point)))
      (<span class="org-keyword">should-not</span> (equal nil (lilac-is-parent-block src-block))))))
</pre></div></div><p>
Here we test whether we can automatically insert captions for child blocks.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-tests-el">t-smart-caption-generation</a></span>(3/6) <span class="lilac-caption-link-symbol"><a href="#__NREF__t-smart-caption-generation-3">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__t-smart-caption-generation-3">(<span class="org-keyword">ert-deftest</span> <span class="org-function-name">t-lilac-insert-noweb-source-code-block-captions</span> ()
  (<span class="org-keyword">with-temp-buffer</span>
    (insert <span class="org-string">"#+name: parent\n"</span>)
    (insert <span class="org-string">"#+caption: parent\n"</span>)
    (insert <span class="org-string">"#+begin_src emacs-lisp\n"</span>)
    (insert <span class="org-string">"; foo\n"</span>)
    (insert (concat (nref <span class="org-string">"child1"</span>) <span class="org-string">"\n"</span>))
    (insert (concat (nref <span class="org-string">"child2"</span>) <span class="org-string">"\n"</span>))
    (insert <span class="org-string">"#+end_src\n"</span>)
    (insert <span class="org-string">"\n"</span>)
    (insert (concat <span class="org-string">"#+name: "</span> (nref <span class="org-string">"child1"</span>) <span class="org-string">"\n"</span>))
    (insert <span class="org-string">"#+begin_src emacs-lisp\n"</span>)
    (insert <span class="org-string">"; bar\n"</span>)
    (insert <span class="org-string">"#+end_src\n"</span>)
    (insert <span class="org-string">"\n"</span>)
    (insert (concat <span class="org-string">"#+name: "</span> (nref <span class="org-string">"child2"</span>) <span class="org-string">"\n"</span>))
    (insert <span class="org-string">"#+begin_src emacs-lisp\n"</span>)
    (insert <span class="org-string">"; baz\n"</span>)
    (insert <span class="org-string">"#+end_src\n"</span>)
    (lilac-insert-noweb-source-code-block-captions nil)
    (goto-char (point-min))
    (<span class="org-keyword">should</span> (search-forward
             (concat <span class="org-string">"#+caption: ="</span> (nref <span class="org-string">"child1"</span>) <span class="org-string">"=  [[parent][1]]"</span>)
             nil t))
    (<span class="org-keyword">should</span> (search-forward
             (concat <span class="org-string">"#+caption: ="</span> (nref <span class="org-string">"child2"</span>) <span class="org-string">"=  [[parent][1]]"</span>)
             nil t)))
  (<span class="org-keyword">with-temp-buffer</span>
    (insert <span class="org-string">"#+name: parent1\n"</span>)
    (insert <span class="org-string">"#+caption: parent1\n"</span>)
    (insert <span class="org-string">"#+begin_src emacs-lisp\n"</span>)
    (insert <span class="org-string">"; foo\n"</span>)
    (insert (concat (nref <span class="org-string">"child1"</span>) <span class="org-string">"\n"</span>))
    (insert (concat (nref <span class="org-string">"child2"</span>) <span class="org-string">"\n"</span>))
    (insert <span class="org-string">"#+end_src\n"</span>)
    (insert <span class="org-string">"\n"</span>)
    (insert (concat <span class="org-string">"#+name: "</span> (nref <span class="org-string">"child1"</span>) <span class="org-string">"\n"</span>))
    (insert <span class="org-string">"#+begin_src emacs-lisp\n"</span>)
    (insert <span class="org-string">"; bar\n"</span>)
    (insert <span class="org-string">"#+end_src\n"</span>)
    (insert <span class="org-string">"\n"</span>)
    (insert (concat <span class="org-string">"#+name: "</span> (nref <span class="org-string">"child2"</span>) <span class="org-string">"\n"</span>))
    (insert <span class="org-string">"#+begin_src emacs-lisp\n"</span>)
    (insert <span class="org-string">"; baz\n"</span>)
    (insert <span class="org-string">"#+end_src\n"</span>)
    (insert <span class="org-string">"\n"</span>)
    (insert (concat <span class="org-string">"#+name: parent2\n"</span>))
    (insert <span class="org-string">"#+caption: parent2\n"</span>)
    (insert <span class="org-string">"#+begin_src emacs-lisp\n"</span>)
    (insert <span class="org-string">"; foo\n"</span>)
    (insert (concat (nref <span class="org-string">"child1"</span>) <span class="org-string">"\n"</span>))
    (insert <span class="org-string">"#+end_src\n"</span>)
    (lilac-insert-noweb-source-code-block-captions nil)
    (goto-char (point-min))
    (<span class="org-keyword">should</span> (search-forward
             (concat <span class="org-string">"#+caption: ="</span>
                     (nref <span class="org-string">"child1"</span>)
                     <span class="org-string">"=  [[parent1][1]]  [[parent2][2]]"</span>)
             nil t))
    (<span class="org-keyword">should</span> (search-forward
             (concat <span class="org-string">"#+caption: ="</span> (nref <span class="org-string">"child2"</span>) <span class="org-string">"=  [[parent1][1]]"</span>)
             nil t))))
</pre></div></div><p>
Here we test retrieval of parent source code blocks.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-tests-el">t-smart-caption-generation</a></span>(4/6) <span class="lilac-caption-link-symbol"><a href="#__NREF__t-smart-caption-generation-4">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__t-smart-caption-generation-4">(<span class="org-keyword">ert-deftest</span> <span class="org-function-name">t-lilac-get-parent-blocks</span> ()
  (<span class="org-keyword">with-temp-buffer</span>
    (insert <span class="org-string">"#+name: foo\n"</span>)
    (insert <span class="org-string">"#+caption: foo\n"</span>)
    (insert <span class="org-string">"#+begin_src emacs-lisp\n"</span>)
    (insert <span class="org-string">"; foo\n"</span>)
    (insert <span class="org-string">"#+end_src\n"</span>)
    (insert <span class="org-string">"\n"</span>)
    (insert <span class="org-string">"#+name: bar\n"</span>)
    (insert <span class="org-string">"#+caption: bar\n"</span>)
    (insert <span class="org-string">"#+begin_src emacs-lisp\n"</span>)
    (insert <span class="org-string">"; bar\n"</span>)
    (insert <span class="org-string">"#+end_src\n"</span>)
    (<span class="org-keyword">should-not</span> (lilac-get-parent-blocks)))
  (<span class="org-keyword">with-temp-buffer</span>
    (insert <span class="org-string">"#+name: parent1\n"</span>)
    (insert <span class="org-string">"#+caption: parent1\n"</span>)
    (insert <span class="org-string">"#+begin_src emacs-lisp\n"</span>)
    (insert <span class="org-string">"; foo\n"</span>)
    (insert (concat (nref <span class="org-string">"child1"</span>) <span class="org-string">"\n"</span>))
    (insert <span class="org-string">"#+end_src\n"</span>)
    (insert <span class="org-string">"\n"</span>)
    (insert <span class="org-string">"#+name: parent2\n"</span>)
    (insert <span class="org-string">"#+caption: parent2\n"</span>)
    (insert <span class="org-string">"#+begin_src emacs-lisp\n"</span>)
    (insert <span class="org-string">"; bar\n"</span>)
    (insert (concat (nref <span class="org-string">"child2"</span>) <span class="org-string">"\n"</span>))
    (insert <span class="org-string">"#+end_src\n"</span>)
    (<span class="org-keyword">should</span> (lilac-get-parent-blocks))))
</pre></div></div><p>
Here we test generating the child-to-parents hash table.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-tests-el">t-smart-caption-generation</a></span>(5/6) <span class="lilac-caption-link-symbol"><a href="#__NREF__t-smart-caption-generation-5">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__t-smart-caption-generation-5">(<span class="org-keyword">ert-deftest</span> <span class="org-function-name">t-lilac-mk-child-parents-hash-table</span> ()
  (<span class="org-keyword">with-temp-buffer</span>
    (insert <span class="org-string">"#+name: foo\n"</span>)
    (insert <span class="org-string">"#+caption: foo\n"</span>)
    (insert <span class="org-string">"#+begin_src emacs-lisp\n"</span>)
    (insert <span class="org-string">"; foo\n"</span>)
    (insert <span class="org-string">"#+end_src\n"</span>)
    (insert <span class="org-string">"\n"</span>)
    (insert <span class="org-string">"#+name: bar\n"</span>)
    (insert <span class="org-string">"#+caption: bar\n"</span>)
    (insert <span class="org-string">"#+begin_src emacs-lisp\n"</span>)
    (insert <span class="org-string">"; bar\n"</span>)
    (insert <span class="org-string">"#+end_src\n"</span>)
    (<span class="org-keyword">let*</span> ((parent-blocks (lilac-get-parent-blocks))
           (child-parents-hash-table
             (lilac-mk-child-parents-hash-table parent-blocks)))
      (<span class="org-keyword">should</span> (equal (hash-table-count child-parents-hash-table) 0))))
  (<span class="org-keyword">with-temp-buffer</span>
    (insert <span class="org-string">"#+name: parent1\n"</span>)
    (insert <span class="org-string">"#+caption: parent1\n"</span>)
    (insert <span class="org-string">"#+begin_src emacs-lisp\n"</span>)
    (insert <span class="org-string">"; foo\n"</span>)
    (insert (concat (nref <span class="org-string">"child1"</span>) <span class="org-string">"\n"</span>))
    (insert <span class="org-string">"#+end_src\n"</span>)
    (insert <span class="org-string">"\n"</span>)
    (insert <span class="org-string">"#+name: parent2\n"</span>)
    (insert <span class="org-string">"#+caption: parent2\n"</span>)
    (insert <span class="org-string">"#+begin_src emacs-lisp\n"</span>)
    (insert <span class="org-string">"; bar\n"</span>)
    (insert (concat (nref <span class="org-string">"child2"</span>) <span class="org-string">"\n"</span>))
    (insert <span class="org-string">"#+end_src\n"</span>)
    (<span class="org-keyword">let*</span> ((parent-blocks (lilac-get-parent-blocks))
           (child-parents-hash-table
             (lilac-mk-child-parents-hash-table parent-blocks)))
      (<span class="org-keyword">should</span> (equal (hash-table-count child-parents-hash-table) 2)))))
</pre></div></div><p>
Here we test the construction of smart captions.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-tests-el">t-smart-caption-generation</a></span>(6/6) <span class="lilac-caption-link-symbol"><a href="#__NREF__t-smart-caption-generation-6">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__t-smart-caption-generation-6">(<span class="org-keyword">ert-deftest</span> <span class="org-function-name">t-lilac-mk-smart-captions</span> ()
  (<span class="org-keyword">with-temp-buffer</span>
    (insert <span class="org-string">"#+name: parent1\n"</span>)
    (insert <span class="org-string">"#+caption: parent1\n"</span>)
    (insert <span class="org-string">"#+begin_src emacs-lisp\n"</span>)
    (insert <span class="org-string">"; foo\n"</span>)
    (insert (concat (nref <span class="org-string">"child1"</span>) <span class="org-string">"\n"</span>))
    (insert <span class="org-string">"#+end_src\n"</span>)
    (insert <span class="org-string">"\n"</span>)
    (insert <span class="org-string">"#+name: parent2\n"</span>)
    (insert <span class="org-string">"#+caption: parent2\n"</span>)
    (insert <span class="org-string">"#+begin_src emacs-lisp\n"</span>)
    (insert <span class="org-string">"; bar\n"</span>)
    (insert (concat (nref <span class="org-string">"child2"</span>) <span class="org-string">"\n"</span>))
    (insert <span class="org-string">"#+end_src\n"</span>)
    (<span class="org-keyword">let*</span> ((parent-blocks (lilac-get-parent-blocks))
           (child-parents-hash-table
             (lilac-mk-child-parents-hash-table parent-blocks))
           (smart-captions (lilac-mk-smart-captions
                            child-parents-hash-table)))
      (<span class="org-keyword">should</span> (equal smart-captions nil))))
  (<span class="org-keyword">with-temp-buffer</span>
    (insert <span class="org-string">"#+name: parent1\n"</span>)
    (insert <span class="org-string">"#+caption: parent1\n"</span>)
    (insert <span class="org-string">"#+begin_src emacs-lisp\n"</span>)
    (insert <span class="org-string">"; foo\n"</span>)
    (insert (concat (nref <span class="org-string">"child1"</span>) <span class="org-string">"\n"</span>))
    (insert <span class="org-string">"#+end_src\n"</span>)
    (insert <span class="org-string">"\n"</span>)
    (insert <span class="org-string">"#+name: parent2\n"</span>)
    (insert <span class="org-string">"#+caption: parent2\n"</span>)
    (insert <span class="org-string">"#+begin_src emacs-lisp\n"</span>)
    (insert <span class="org-string">"; bar\n"</span>)
    (insert (concat (nref <span class="org-string">"child1"</span>) <span class="org-string">"\n"</span>))
    (insert <span class="org-string">"#+end_src\n"</span>)
    (insert <span class="org-string">"\n"</span>)
    (insert (concat <span class="org-string">"#+name: "</span> (nref <span class="org-string">"child1"</span>) <span class="org-string">"\n"</span>))
    (insert <span class="org-string">"#+begin_src emacs-lisp\n"</span>)
    (insert <span class="org-string">"; child1\n"</span>)
    (insert <span class="org-string">"#+end_src\n"</span>)
    (<span class="org-keyword">let*</span> ((parent-blocks (lilac-get-parent-blocks))
           (child-parents-hash-table
             (lilac-mk-child-parents-hash-table parent-blocks))
           (smart-captions (lilac-mk-smart-captions
                            child-parents-hash-table)))
      (<span class="org-keyword">should</span> (equal smart-captions
       `((181 . ,(concat <span class="org-string">"#+caption: ="</span>
                         (nref <span class="org-string">"child1"</span>)
                         <span class="org-string">"=  [[parent1][1]]  [[parent2][2]]\n"</span>)))))))
  (<span class="org-keyword">with-temp-buffer</span>
    (insert <span class="org-string">"#+name: parent1\n"</span>)
    (insert <span class="org-string">"#+caption: parent1\n"</span>)
    (insert <span class="org-string">"#+begin_src emacs-lisp\n"</span>)
    (insert <span class="org-string">"; foo\n"</span>)
    (insert (concat (nref <span class="org-string">"child1"</span>) <span class="org-string">"\n"</span>))
    (insert <span class="org-string">"#+end_src\n"</span>)
    (insert <span class="org-string">"\n"</span>)
    (insert <span class="org-string">"#+name: parent2\n"</span>)
    (insert <span class="org-string">"#+caption: parent2\n"</span>)
    (insert <span class="org-string">"#+begin_src emacs-lisp\n"</span>)
    (insert <span class="org-string">"; bar\n"</span>)
    (insert (concat (nref <span class="org-string">"child2"</span>) <span class="org-string">"\n"</span>))
    (insert <span class="org-string">"#+end_src\n"</span>)
    (insert <span class="org-string">"\n"</span>)
    (insert (concat <span class="org-string">"#+name: "</span> (nref <span class="org-string">"child1"</span>) <span class="org-string">"\n"</span>))
    (insert <span class="org-string">"#+begin_src emacs-lisp\n"</span>)
    (insert <span class="org-string">"; child1\n"</span>)
    (insert <span class="org-string">"#+end_src\n"</span>)
    (insert <span class="org-string">"\n"</span>)
    (insert (concat <span class="org-string">"#+name: "</span> (nref <span class="org-string">"child2"</span>) <span class="org-string">"\n"</span>))
    (insert <span class="org-string">"#+begin_src emacs-lisp\n"</span>)
    (insert <span class="org-string">"; child2\n"</span>)
    (insert <span class="org-string">"#+end_src\n"</span>)
    (<span class="org-keyword">let*</span> ((parent-blocks (lilac-get-parent-blocks))
           (child-parents-hash-table
             (lilac-mk-child-parents-hash-table parent-blocks))
           (smart-captions (lilac-mk-smart-captions
                            child-parents-hash-table)))
      (<span class="org-keyword">should</span> (equal smart-captions
       `((181 . ,(concat <span class="org-string">"#+caption: ="</span>
                         (nref <span class="org-string">"child1"</span>)
                         <span class="org-string">"=  [[parent1][1]]\n"</span>))
         (247 . ,(concat <span class="org-string">"#+caption: ="</span>
                         (nref <span class="org-string">"child2"</span>)
                         <span class="org-string">"=  [[parent2][1]]\n"</span>)))))))
  (<span class="org-keyword">with-temp-buffer</span>
    (insert <span class="org-string">"#+name: parent1\n"</span>)
    (insert <span class="org-string">"#+caption: parent1\n"</span>)
    (insert <span class="org-string">"#+begin_src emacs-lisp\n"</span>)
    (insert <span class="org-string">"; foo\n"</span>)
    (insert (concat (nref <span class="org-string">"child1"</span>) <span class="org-string">"\n"</span>))
    (insert <span class="org-string">"#+end_src\n"</span>)
    (insert <span class="org-string">"\n"</span>)
    (insert (concat <span class="org-string">"#+name: "</span> (nref <span class="org-string">"child1"</span>) <span class="org-string">"\n"</span>))
    (insert <span class="org-string">"#+begin_src emacs-lisp\n"</span>)
    (insert <span class="org-string">"; child1\n"</span>)
    (insert (concat (nref <span class="org-string">"child2"</span>) <span class="org-string">"\n"</span>))
    (insert <span class="org-string">"#+end_src\n"</span>)
    (insert <span class="org-string">"\n"</span>)
    (insert (concat <span class="org-string">"#+name: "</span> (nref <span class="org-string">"child2"</span>) <span class="org-string">"\n"</span>))
    (insert <span class="org-string">"#+begin_src emacs-lisp\n"</span>)
    (insert <span class="org-string">"; child2\n"</span>)
    (insert <span class="org-string">"#+end_src\n"</span>)
    (<span class="org-keyword">let*</span> ((parent-blocks (lilac-get-parent-blocks))
           (child-parents-hash-table
             (lilac-mk-child-parents-hash-table parent-blocks))
           (smart-captions (lilac-mk-smart-captions
                            child-parents-hash-table)))
      (<span class="org-keyword">should</span> (equal smart-captions
       `((91 . ,(concat <span class="org-string">"#+caption: ="</span>
                         (nref <span class="org-string">"child1"</span>)
                         <span class="org-string">"=  [[parent1][1]]\n"</span>))
         (172 . ,(concat <span class="org-string">"#+caption: ="</span>
                         (nref <span class="org-string">"child2"</span>)
                         <span class="org-string">"=  [["</span>
                         (nref <span class="org-string">"child1"</span>)
                         <span class="org-string">"][1]]\n"</span>))))))))
</pre></div></div>
</div>
</div>

<div id="outline-container-h-Link-to-child-block-from-parent-block" class="outline-4">
<h4 id="h-Link-to-child-block-from-parent-block"><span class="section-number-4">3.5.3.</span> Link to child block from parent block</h4>
<div class="outline-text-4" id="text-h-Link-to-child-block-from-parent-block">
</div>

<div id="outline-container-h-One--same--child-node-block-referenced-in-two-different-parent-blocks" class="outline-5">
<h5 id="h-One--same--child-node-block-referenced-in-two-different-parent-blocks"><span class="section-number-5">3.5.3.1.</span> One (same) child node block referenced in two different parent blocks</h5>
<div class="outline-text-5" id="text-h-One--same--child-node-block-referenced-in-two-different-parent-blocks">
<p>
Expect to find a link in the HTML from the parent blocks to the same child
block.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-tests-el">t-link-to-child-block-from-parent-block</a></span>(1/2) <span class="lilac-caption-link-symbol"><a href="#__NREF__t-link-to-child-block-from-parent-block-1">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__t-link-to-child-block-from-parent-block-1">(<span class="org-keyword">ert-deftest</span> <span class="org-function-name">t-lilac-children-are-linked-from-parent</span> ()
  (lilac-publish-fixture
   <span class="org-string">"t-lilac-children-are-linked-from-parent-"</span>
   (concat
    <span class="org-string">"#+name: parent1\n"</span>
    <span class="org-string">"#+caption: parent1\n"</span>
    <span class="org-string">"#+begin_src emacs-lisp\n"</span>
    <span class="org-string">"; foo\n"</span>
    (concat (nref <span class="org-string">"child1"</span>) <span class="org-string">"\n"</span>)
    <span class="org-string">"#+end_src\n"</span>
    <span class="org-string">"\n"</span>
    <span class="org-string">"#+name: parent2\n"</span>
    <span class="org-string">"#+caption: parent2\n"</span>
    <span class="org-string">"#+begin_src emacs-lisp\n"</span>
    <span class="org-string">"; bar\n"</span>
    (concat (nref <span class="org-string">"child1"</span>) <span class="org-string">"\n"</span>)
    <span class="org-string">"#+end_src\n"</span>
    <span class="org-string">"\n"</span>
    (concat <span class="org-string">"#+name: "</span> (nref <span class="org-string">"child1"</span>) <span class="org-string">"\n"</span>)
    <span class="org-string">"#+begin_src emacs-lisp\n"</span>
    <span class="org-string">"; child1\n"</span>
    <span class="org-string">"#+end_src\n"</span>)
   (<span class="org-keyword">lambda</span> (html-ast)
     (<span class="org-keyword">let</span> ((got-child-link-text-parent1
            (elquery-text
             (car (elquery-$
                   <span class="org-string">"#parent1 .lilac-child-link-from-parent a"</span>
                   html-ast))))
           (got-child-link-text-parent2
            (elquery-text
             (car (elquery-$
                   <span class="org-string">"#parent2 .lilac-child-link-from-parent a"</span>
                   html-ast)))))
       (<span class="org-keyword">should</span> (equal got-child-link-text-parent1 <span class="org-string">"child1"</span>))
       (<span class="org-keyword">should</span> (equal got-child-link-text-parent2 <span class="org-string">"child1"</span>))))))
</pre></div></div>
</div>
</div>

<div id="outline-container-h-Nested-child-blocks" class="outline-5">
<h5 id="h-Nested-child-blocks"><span class="section-number-5">3.5.3.2.</span> Nested child blocks</h5>
<div class="outline-text-5" id="text-h-Nested-child-blocks">
<p>
A child block can itself be a parent (and link to the nested child within it).
Expect to find a link to the nested child block from wiithin the first child
block.
</p>

<div class="org-src-container"><div class="lilac-pre-with-caption"><div class="lilac-caption"><span class="lilac-caption-parent-link"><a href="#lilac-tests-el">t-link-to-child-block-from-parent-block</a></span>(2/2) <span class="lilac-caption-link-symbol"><a href="#__NREF__t-link-to-child-block-from-parent-block-2">&#x1f517;</a></span></div><pre class="src src-emacs-lisp" id="__NREF__t-link-to-child-block-from-parent-block-2">(<span class="org-keyword">ert-deftest</span> <span class="org-function-name">t-lilac-children-are-linked-from-parent</span> ()
  (lilac-publish-fixture
   <span class="org-string">"t-lilac-children-are-linked-from-parent-nested-"</span>
   (concat
    <span class="org-string">"#+name: parent1\n"</span>
    <span class="org-string">"#+caption: parent1\n"</span>
    <span class="org-string">"#+begin_src emacs-lisp\n"</span>
    <span class="org-string">"; foo\n"</span>
    (concat (nref <span class="org-string">"child1"</span>) <span class="org-string">"\n"</span>)
    <span class="org-string">"#+end_src\n"</span>
    <span class="org-string">"\n"</span>
    (concat <span class="org-string">"#+name: "</span> (nref <span class="org-string">"child1"</span>) <span class="org-string">"\n"</span>)
    <span class="org-string">"#+begin_src emacs-lisp\n"</span>
    <span class="org-string">"; child1\n"</span>
    (concat (nref <span class="org-string">"nested-child"</span>) <span class="org-string">"\n"</span>)
    <span class="org-string">"#+end_src\n"</span>
    <span class="org-string">"\n"</span>
    (concat <span class="org-string">"#+name: "</span> (nref <span class="org-string">"nested-child"</span>) <span class="org-string">"\n"</span>)
    <span class="org-string">"#+caption: nested-child\n"</span>
    <span class="org-string">"#+begin_src emacs-lisp\n"</span>
    <span class="org-string">"; nested-child\n"</span>
    <span class="org-string">"#+end_src\n"</span>)
   (<span class="org-keyword">lambda</span> (html-ast)
     (<span class="org-keyword">let</span> ((got-child-link-text-parent1
            (elquery-text
             (car (elquery-$
                   <span class="org-string">"#parent1 .lilac-child-link-from-parent a"</span>
                   html-ast))))
           (got-child-link-text-child1
            (elquery-text
             (car (elquery-$
                   (concat <span class="org-string">"#"</span> (nref <span class="org-string">"child1"</span>)
                           <span class="org-string">" .lilac-child-link-from-parent a"</span>)
                 html-ast)))))
       (<span class="org-keyword">should</span> (equal got-child-link-text-parent1 <span class="org-string">"child1"</span>))
       (<span class="org-keyword">should</span> (equal got-child-link-text-child1 <span class="org-string">"nested-child"</span>))))))
</pre></div></div>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-h-Glossary" class="outline-2">
<h2 id="h-Glossary"><span class="section-number-2">4.</span> Glossary</h2>
<div class="outline-text-2" id="text-h-Glossary">
<dl class="org-dl">
<div class="lilac-description-list-entry" id="org0000009"><dt> <b>monoblock</b></dt><dd>an Org mode source code block with a <code>#+name:
  ...</code> field. This block is an independent block and there are no other blocks
with the same name.</dd></div>
<div class="lilac-description-list-entry" id="org0000001"><dt> <b>Noweb</b></dt><dd>A literate programming tool from 1989 that still works and from
which <a href="#org0000137">Org mode</a> borrows heavily using <a href="#org0000139">Noweb-style references</a>. See <a href="https://en.wikipedia.org/wiki/Noweb">Wikipedia</a>.</dd></div>
<div class="lilac-description-list-entry" id="org0000139"><dt> <b>noweb-ref</b></dt><dd>aka "Noweb-style reference". A Noweb-style
reference is just a name (string) that refers to a monoblock or polyblock. See
<a href="https://orgmode.org/manual/Noweb-Reference-Syntax.html">the Org manual</a>.</dd></div>
<div class="lilac-description-list-entry" id="org0000137"><dt> <b>Org mode</b></dt><dd>An Emacs major mode for <code>*.org</code> files, where "major
mode" means that it provides things like syntax highlighting and keyboard
shortcuts for <code>*.org</code> text files if you are using Emacs. For Lilac, the
important thing is that we use Org mode as a literate programming tool. See
<a href="https://orgmode.org/">Org mode</a>.</dd></div>
<div class="lilac-description-list-entry" id="org000000b"><dt> <b>polyblock</b></dt><dd>an Org mode source code block without a <code>#+name:
  ...</code> field, but which has a <code>#+header: :noweb-ref ...</code> field. Other blocks
with the same Noweb-ref name are concatenated together when they are tangled.
Polyblocks are used in cases where we would like to break up a single block
into smaller pieces for explanatory purposes. In all other cases, monoblocks
are preferable, unless the source code block is not to be tangled and is only
for explanatory purposes in the woven output.</dd></div>
<div class="lilac-description-list-entry" id="org0000003"><dt> <b>source code block</b></dt><dd>An Org mode facility that allows
you to enclose a multiline text (typically source code) with <code>#+begin_src ...</code>
and <code>#+end_src</code> lines. They are enclosed in a separate background color in the
HTML output, and are often used for illustrating source code listings. The
format is <code>#+begin_src LANGUAGE_NAME</code> where <code>LANGUAGE_NAME</code> is the name of the
programming language used for the listing. If the name is a recognized name,
it will get syntax highlighting in the output automatically.</dd></div>
</dl>
</div>
</div>

<div id="outline-container-h-References" class="outline-2">
<h2 id="h-References"><span class="section-number-2">5.</span> References</h2>
<div class="outline-text-2" id="text-h-References">
<style>.csl-left-margin{float: left; padding-right: 0em;}
 .csl-right-inline{margin: 0 0 0 2em;}</style><div class="csl-bib-body">
  <div class="csl-entry" id="citeproc_bib_item_1">
    <div class="csl-left-margin">[1]</div><div class="csl-right-inline">N. Ramsey, Literate programming simplified, <i>IEEE Software</i>, vol. 11, no. 5, pp. 97105, Sep. 1994, doi: <a href="https://doi.org/10.1109/52.311070">10.1109/52.311070</a>.</div>
  </div>
  <div class="csl-entry" id="citeproc_bib_item_2">
    <div class="csl-left-margin">[2]</div><div class="csl-right-inline">D. E. Knuth, Literate Programming, <i>The Computer Journal</i>, vol. 27, no. 2, pp. 97111, Feb. 1984, doi: <a href="https://doi.org/10.1093/comjnl/27.2.97">10.1093/comjnl/27.2.97</a>.</div>
  </div>
</div>
</div>
</div>
</div>
</body>
</html>
